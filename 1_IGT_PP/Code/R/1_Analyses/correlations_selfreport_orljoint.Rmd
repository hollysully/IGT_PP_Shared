---
title: "Correlations"
subtitle: "Self-Report w/ ORL Parameters"
output: html_document
---



# -----------------------------------------------
# Setup
## Packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(haven)
library(here)
library(wBoot)
```



## Set Seed
```{r}
set.seed(20230320)
```



## Self-Report Data
```{r}
sr_sess1 = read_sav(here("1_IGT_PP", "Data", "0_Raw", "MergedQuest_3.21.16-Session1.sav"),
                    col_select = c("ID", "sex", "race", "Ethnicity",
                                   "bastot", "basdrive", "basfunsk",
                                   "basrewres", "bis", "panas_pa",
                                   "panas_na", "masqGDA", "masqAA", "masqGDD",
                                   "masqAD", "shaps_tot", "prdep_tot")) %>% 
  # mutate(session = 1) %>%
  filter(ID >= 2049,                          # Subset PP participants
         ID != 2059,                          # Remove participant that played old IFT
         ID != 2083)                          # Remove participant that had no task data

sr_sess2 = read_sav(here("1_IGT_PP", "Data", "0_Raw", "MergedQuest_3.21.16-Session2.sav"),
                    col_select = c("ID", "bastot", "basdrive", "basfunsk",
                                   "basrewres", "bis", "panas_pa",
                                   "panas_na", "shaps_tot")) %>% 
  # mutate(session = 2) %>%
  filter(ID >= 2049,                          # Subset PP participants
         ID != 2059,                          # Remove participant that played old IFT
         ID != 2083,                          # Remove participant that had no task data
         !ID %in% c(2057, 2063, 2064,         # Remove participants that didn't do session 2
                    2067, 2086, 2090,
                    2093, 2094, 2096, 2098))

```
<!-- ------------------------------------------------------------------------------------------ -->
* Demographics
  + ID, sex, race, Ethnicity
  
* Behavioral Activation Scale
  + bastot    = ?
  + basdrive  = Drive subscale: measures persistent pursuit of goals
  + basfunsk  = Fun Seeking subscale: measures desire for and approach towards new rewards
  + basrewres = Reward Responsiveness subscale: measures positive responses to the anticipation or consummation of rewards
  
* Behavioral Inhibition Scale: measures sensitivity to negatively-valenced events
  + bis

* Positive Affect/Negative Affect Schedules: measures state-level mood
  + panas_pa = Positive Affect
  + panas_na = Negative Affect

* Mood and Anxiety Symptom Questionnaire (MASQ): assesses internalizing symptoms experienced in past week
  + masqGDA = General Distress Anxiety subscale: measures general anxious mood
  + masqAA  = Anxious Arousal subscale: measures somatic hyperarousal
  + masqGDD = General Distress Depression subscale: measures general depressed mood
  + masqAD  = Anhedonic Depression subscale: measures low positive affect

* Snaith-Hamilton Pleasure Scale: measures ability to experience pleasure in last few days
  + shaps_tot

* Patient-Reported Outcomes Measurement Information System: assesses symptoms of depression experienced in past week
  + prdep_tot

<!-- ------------------------------------------------------------------------------------------ -->



## ORL Parameters
```{r}
orl_blups = readRDS(here("1_IGT_PP", "Data", "2_Fitted", "Joint", "orl_pp_joint_blups.rds")) %>% 
  
  # Rename ID column to be same as in self-report dataframe
  select(-ID) %>% select(ID = subject, everything())
```



# -----------------------------------------------
# Correlations
```{r}
orl_sess1 = orl_blups %>% 
  filter(session == 1)
orl_sess2 = orl_blups %>% 
  filter(session == 2)

correlations = data.frame()
```



## Session 1 Self-Report w/ Session 1 & 2 ORL Parameters
```{r}
# Loop through each scale from session 1
for(scale in c("bastot", "basdrive", "basfunsk",
               "basrewres", "bis", "panas_pa",
               "panas_na", "masqGDA", "masqAA", "masqGDD",
               "masqAD", "shaps_tot", "prdep_tot")){
  # Loop through each parameter from session 1
  for(param in unique(orl_sess1$parameter)){
    
    curr_data = orl_sess1 %>%
      filter(parameter == param) %>%        # Subset orl parameter
      left_join(sr_sess1) %>%               # Join scales to orl parameter
      select(-c(sex, race, Ethnicity)) %>%  # Remove columns that we don't need
      na.omit()                             # Remove rows with NAs
    
    curr_scale = curr_data[[scale]]         # Subset scale data
    curr_estimate = curr_data[["estimate"]] # Subset estimate for parameter
    # Run the boot-strapped correlation between the current scale and the current parameter
    curr_cor = boot.cor.bca(x = curr_scale, y = curr_estimate,
                            null.hyp = NULL,
                            alternative = c("two.sided", "less", "greater"),
                            conf.level = 0.95, type = NULL, R = 9999)
    
    curr_ci = data.frame(data = curr_cor$Confidence.interval) %>%       # Get the confidence interval of the current correlation (this is a string)
      separate(col = data, sep = ",", into = c("lower", "upper")) %>%   # Separate confidence interval string into lower and upper CI columns
      # Remove parentheses and turn CIs into numerics
      mutate(lower = as.numeric(str_remove(lower, "[(]")),
             upper = as.numeric(str_remove(upper, "[)]")))
    
    # Bind the current correlation to the correlations dataframe while also detailing what the correlation is from (e.g., session, parameter, etc.)
    correlations = bind_rows(correlations,
                             data.frame(parameter_session = 1,
                                        scale_session = 1,
                                        parameter = param,
                                        scale = scale,
                                        r = curr_cor$Observed,
                                        lower_ci = curr_ci$lower[1],
                                        upper_ci = curr_ci$upper[1]))
  }
  
  # Loop through each parameter from session 2
  for(param in unique(orl_sess2$parameter)){
    
    curr_data = orl_sess2 %>%
      filter(parameter == param) %>%        # Subset orl parameter
      left_join(sr_sess1) %>%               # Join scales to orl parameter
      select(-c(sex, race, Ethnicity)) %>%  # Remove columns that we don't need
      na.omit()                             # Remove rows with NAs
    
    curr_scale = curr_data[[scale]]         # Subset scale data
    curr_estimate = curr_data[["estimate"]] # Subset estimate for parameter
    # Run the boot-strapped correlation between the current scale and the current parameter
    curr_cor = boot.cor.bca(x = curr_scale, y = curr_estimate,
                            null.hyp = NULL,
                            alternative = c("two.sided", "less", "greater"),
                            conf.level = 0.95, type = NULL, R = 9999)
    
    curr_ci = data.frame(data = curr_cor$Confidence.interval) %>%       # Get the confidence interval of the current correlation (this is a string)
      separate(col = data, sep = ",", into = c("lower", "upper")) %>%   # Separate confidence interval string into lower and upper CI columns
      # Remove parentheses and turn CIs into numerics
      mutate(lower = as.numeric(str_remove(lower, "[(]")),
             upper = as.numeric(str_remove(upper, "[)]")))
    
    # Bind the current correlation to the correlations dataframe while also detailing what the correlation is from (e.g., session, parameter, etc.)
    correlations = bind_rows(correlations,
                             data.frame(parameter_session = 2,
                                        scale_session = 1,
                                        parameter = param,
                                        scale = scale,
                                        r = curr_cor$Observed,
                                        lower_ci = curr_ci$lower[1],
                                        upper_ci = curr_ci$upper[1]))
  }
}
```



## Session 2 Self-Report w/ Session 1 & 2 ORL Parameters
```{r}
# Loop through each scale from session 2
for(scale in c("bastot", "basdrive", "basfunsk",
               "basrewres", "bis", "panas_pa",
               "panas_na", "shaps_tot")){
  # Loop through each parameter from session 1
  for(param in unique(orl_sess1$parameter)){
    
    curr_data = orl_sess1 %>%
      filter(parameter == param) %>%        # Subset orl parameter
      left_join(sr_sess2) %>%               # Join scales to orl parameter
      na.omit()                             # Remove rows with NAs
    
    curr_scale = curr_data[[scale]]         # Subset scale data
    curr_estimate = curr_data[["estimate"]] # Subset estimate for parameter
    # Run the boot-strapped correlation between the current scale and the current parameter
    curr_cor = boot.cor.bca(x = curr_scale, y = curr_estimate,
                            null.hyp = NULL,
                            alternative = c("two.sided", "less", "greater"),
                            conf.level = 0.95, type = NULL, R = 9999)
    
    curr_ci = data.frame(data = curr_cor$Confidence.interval) %>%       # Get the confidence interval of the current correlation (this is a string)
      separate(col = data, sep = ",", into = c("lower", "upper")) %>%   # Separate confidence interval string into lower and upper CI columns
      # Remove parentheses and turn CIs into numerics
      mutate(lower = as.numeric(str_remove(lower, "[(]")),
             upper = as.numeric(str_remove(upper, "[)]")))
    
    # Bind the current correlation to the correlations dataframe while also detailing what the correlation is from (e.g., session, parameter, etc.)
    correlations = bind_rows(correlations,
                             data.frame(parameter_session = 1,
                                        scale_session = 2,
                                        parameter = param,
                                        scale = scale,
                                        r = curr_cor$Observed,
                                        lower_ci = curr_ci$lower[1],
                                        upper_ci = curr_ci$upper[1]))
  }
  
  # Loop through each parameter from session 2
  for(param in unique(orl_sess2$parameter)){
    
    curr_data = orl_sess2 %>%
      filter(parameter == param) %>%        # Subset orl parameter
      left_join(sr_sess2) %>%               # Join scales to orl parameter
      na.omit()                             # Remove rows with NAs
    
    curr_scale = curr_data[[scale]]         # Subset scale data
    curr_estimate = curr_data[["estimate"]] # Subset estimate for parameter
    # Run the boot-strapped correlation between the current scale and the current parameter
    curr_cor = boot.cor.bca(x = curr_scale, y = curr_estimate,
                            null.hyp = NULL,
                            alternative = c("two.sided", "less", "greater"),
                            conf.level = 0.95, type = NULL, R = 9999)
    
    curr_ci = data.frame(data = curr_cor$Confidence.interval) %>%       # Get the confidence interval of the current correlation (this is a string)
      separate(col = data, sep = ",", into = c("lower", "upper")) %>%   # Separate confidence interval string into lower and upper CI columns
      # Remove parentheses and turn CIs into numerics
      mutate(lower = as.numeric(str_remove(lower, "[(]")),
             upper = as.numeric(str_remove(upper, "[)]")))
    
    # Bind the current correlation to the correlations dataframe while also detailing what the correlation is from (e.g., session, parameter, etc.)
    correlations = bind_rows(correlations,
                             data.frame(parameter_session = 2,
                                        scale_session = 2,
                                        parameter = param,
                                        scale = scale,
                                        r = curr_cor$Observed,
                                        lower_ci = curr_ci$lower[1],
                                        upper_ci = curr_ci$upper[1]))
  }
}
```



# -----------------------------------------------
# Format Correlations
```{r}
formatted_correlations = correlations %>% 
  # Identify CIs that DO NOT overlap with 0
  mutate(sig = case_when(lower_ci < 0 & upper_ci < 0 ~ "*",
                         lower_ci > 0 & upper_ci > 0 ~ "*",
                         T ~ ""),
         # Format numerics
         r = str_replace(format(round(r, 2), nsmall = 2), "0.", replacement = "."),
         lower_ci = str_replace(format(round(lower_ci, 2), nsmall = 2), "0.", replacement = "."),
         upper_ci = str_replace(format(round(upper_ci, 2), nsmall = 2), "0.", replacement = "."),
         # Concatenating correlations and CIs
         estimate = paste(r, " (", lower_ci, ", ", upper_ci, ")", sig,
                          sep = "")) %>% 
  select(-c(sig, r, lower_ci, upper_ci)) %>% 
  pivot_wider(names_from = c("parameter", "parameter_session", "scale_session"), values_from = estimate,
              values_fill = "")

write.csv(formatted_correlations, here("1_IGT_PP", "Figs_Tables", "Joint", "formatted_correlations.csv"))
```



# Unformatted Correlations
```{r}
unformatted_correlations = correlations %>% 
  # format correlations
  mutate(r = str_replace(format(round(r, 2), nsmall = 2), "0.", replacement = ".")) %>% 
  select(-c(lower_ci, upper_ci)) %>% 
  pivot_wider(names_from = c("parameter", "parameter_session", "scale_session"), values_from = r,
              values_fill = "")

write.csv(unformatted_correlations, here("1_IGT_PP", "Figs_Tables", "Joint", "unformatted_correlations.csv"))
```






















