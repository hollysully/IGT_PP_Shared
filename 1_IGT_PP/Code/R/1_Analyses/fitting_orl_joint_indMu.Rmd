---
title: "Fitting Joint Test-Retest ORL"
output: html_document
date: "2023-03-07"
---



# -------------------------------------------
# Setup
## Load Packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(rstan)
library(hBayesDM)
library(bayesplot)
library(here)
library(miscTools)
```



## Load Data
```{r}
stan_data = readRDS(here("1_IGT_PP", "Data", "1_Preprocessed", "List_Sess1&2.rds"))
full_data = readRDS(here("1_IGT_PP", "Data", "1_Preprocessed", "Dataframe_Sess1&2.rds"))
```



# -------------------------------------------
# Fit Model
```{r, eval = F}
# Compile model
orl_model = stan_model(here("1_IGT_PP", "Code", "Stan", "igt_orl_joint_indMu2.stan"))


# Fit model
orl_fit = sampling(orl_model, 
                   data   = stan_data,
                   
                   # Setup for testing model
                   iter   = 2000,
                   warmup = 1000,
                   chains = 4,
                   cores  = 4,
                   
                   # Setup for fitting final model
                   # iter   = 5000,
                   # warmup = 1000,
                   # chains = 4,
                   # cores  = 4,
                   
                   seed   = 43210)


#save the fitted model as an .rds file
saveRDS(orl_fit, here("1_IGT_PP", "Data", "2_Fitted", "Joint_indMu", "orl_pp_joint_indMu2.rds"))
```



```{r}
orl_fit = readRDS(here("1_IGT_PP", "Data", "2_Fitted", "Joint_indMu", "orl_pp_joint_indMu2.rds"))
```



# -------------------------------------------
# Model Diagnostics
```{r}
posterior = extract(orl_fit)

focal_parameters = c("mu_group_Arew", "mu_group_Apun", "mu_group_K",
                     "mu_group_betaF", "mu_group_betaP", "sigma_group_Arew",
                     "sigma_group_Apun", "sigma_group_K", "sigma_group_betaF",
                     "sigma_group_betaP", "mu_person_Arew", "mu_person_Apun",
                     "mu_person_K", "mu_person_betaF", "mu_person_betaP",
                     "sigma_person_Arew", "sigma_person_Apun", "sigma_person_K",
                     "sigma_person_betaF", "sigma_person_betaP", "mu_person_session_Arew",
                     "mu_person_session_Apun", "mu_person_session_K", "mu_person_session_betaF",
                     "mu_person_session_betaP")
```



## Rhat
```{r}
rhats = rhat(orl_fit,
             pars = focal_parameters
             ) %>% 
  data.frame() %>% mutate(parameter = rownames(.))
```



## Traceplots
```{r}
tiff(here("1_IGT_PP", "Figs_Tables", "Joint_indMu",
          "orl_pp_joint_indMu2_group_traceplots.tiff"),
     width = 35, height = 25, units = "cm", res = 300)
  traceplot(orl_fit,
            pars = c("mu_group_Arew", "mu_group_Apun", "mu_group_K",
                     "mu_group_betaF", "mu_group_betaP", "sigma_group_Arew",
                     "sigma_group_Apun", "sigma_group_K", "sigma_group_betaF")
            )
dev.off()

labels = c("mu_person_Arew", "mu_person_Apun", "mu_person_K", "mu_person_betaF",
           "mu_person_betaP", "sigma_person_Arew", "sigma_person_Apun", "sigma_person_K",
           "sigma_person_betaF", "sigma_person_betaP", "mu_person_session_Arew",
           "mu_person_session_Apun", "mu_person_session_K", 
           "mu_person_session_betaF", "mu_person_session_betaP")

for(i in labels){
  
  tiff(here("1_IGT_PP", "Figs_Tables", "Joint_indMu",
            paste("orl_pp_joint_indMu2_", i, "_traceplots.tiff", sep = "")),
       width = 35, height = 25, units = "cm", res = 300)
    traceplot(orl_fit,
              pars = i
              ) %>% print()
    dev.off()
  
}
```



# -------------------------------------------
# Inspect Parameters
## Means +/- PI
```{r}
tiff(here("1_IGT_PP", "Figs_Tables", "Joint_indMu",
          "orl_pp_joint_indMu2_posterior_means.tiff"),
     width = 35, height = 25, units = "cm", res = 300)
  plot(orl_fit, pars = c("mu_group_Arew", "mu_group_Apun", "mu_group_K",
                     "mu_group_betaF", "mu_group_betaP", "sigma_group_Arew",
                     "sigma_group_Apun", "sigma_group_K", "sigma_group_betaF"))
dev.off()
```



## Posterior Distributions
```{r}
# Extract posterior distributions
parameters = rstan::extract(orl_fit, pars = c("mu_group_Arew", "mu_group_Apun", "mu_group_K",
                                              "mu_group_betaF", "mu_group_betaP",
                                              "sigma_group_Arew", "sigma_group_Apun",
                                              "sigma_group_K", "sigma_group_betaF")) %>%
  data.frame()

tiff(here("1_IGT_PP", "Figs_Tables", "Joint_indMu",
          "orl_pp_joint_indMu2_posterior_distributions.tiff"),
     width = 35, height = 25, units = "cm", res = 300)
  par(mfrow = c(5, 5)) # Create 5 x 5 facetted plot
  # Make a density plot of the posterior distributions for the focal parameters using a for loop
  for(i in colnames(parameters)){
    plot(density(parameters[ , i]), main = i)
    abline(v = mean(parameters[ , i]))
  }
dev.off()
```



## Save Parameter Estimates
```{r}
# Get point estimates from the posterior for each parameter
posterior_means = data.frame(estimate = colMeans(posterior)) %>% # Means
# posterior_means = data.frame(estimate = colMedians(posterior)) %>% # Medians
  mutate(col_name = rownames(.))


# Calculate overall BLUP for each participant
posterior_blups = posterior %>% 
  data.frame() %>% 
  select(starts_with("mu_person_Arew"), starts_with("mu_person_Apun"), starts_with("mu_person_K"), starts_with("mu_person_betaF"),
           starts_with("mu_person_betaP"))
  # Use the values of col_name in ind_columns to select columns in posterior dataframe
  select(ind_columns$col_name) %>% 
  # Create a column with iteration number for each parameter
  mutate(iteration = rownames(.)) %>% 
  # Pivot data longer so that it's easier to separate what is the parameter, subject, and session from the posterior columns
  pivot_longer(cols = -iteration, names_to = "param_ID_sess", values_to = "estimate") %>% 
  separate(col = param_ID_sess, into = c("parameter", "ID", "session"), sep = "\\.") %>%
  # Pivot wider so that we can calculate the mean of session 1 and session 2 estimate on each iteration of the posterior
  pivot_wider(names_from = "session", values_from = "estimate", names_prefix = "session_") %>%
  mutate(overall_estimate = (session_1 + session_2)/2,
         ID = as.numeric(ID))

blups = posterior_blups %>% 
  # Calculate posterior means for individual subjects by session and overall
  group_by(parameter, ID) %>% 
  reframe(blup_session1 = mean(session_1),
          blup_session2 = mean(session_2),
          blup_overall = mean(overall_estimate)) %>% 
  left_join(reframe(full_data, subject = unique(subject), ID = unique(ID)))


# Bind posterior means for correlations
  # Note, these are not population-corrected - We do this in joint_test_retest_plots.Rmd
  # Create dataframe with names of correlations of interest
correlations = data.frame(parameter = c("Arew", "Apun", "K", "betaF", "betaP")) %>% 
  # Make a new column that has elements we can match to in the posterior_means dataframe
  mutate(col_name = paste("R_", parameter, ".2.1", sep = "")) %>% 
  # Join only the posterior means that have a matching row name in col_name, then remove col_name
  left_join(posterior_means) %>% select(-col_name)


# Save data
write.csv(mus, here("1_IGT_PP", "Data", "2_Fitted", "Joint_indMu",
                    "orl_pp_joint_indMu_mus.csv"))
write.csv(blups, here("1_IGT_PP", "Data", "2_Fitted", "Joint_indMu",
                      "orl_pp_joint_indMu_blups.csv"))
write.csv(correlations, here("1_IGT_PP", "Data", "2_Fitted", "Joint_indMu",
                             "orl_pp_joint_indMu_model_correlations.csv"))

saveRDS(mus, here("1_IGT_PP", "Data", "2_Fitted", "Joint_indMu",
                  "orl_pp_joint_indMu_mus.rds"))
saveRDS(blups, here("1_IGT_PP", "Data", "2_Fitted", "Joint_indMu",
                    "orl_pp_joint_indMu_blups.rds"))
saveRDS(posterior_blups, here("1_IGT_PP", "Data", "2_Fitted", "Joint_indMu",
                              "orl_pp_joint_indMu_posterior_blups.rds"))
saveRDS(correlations, here("1_IGT_PP", "Data", "2_Fitted", "Joint_indMu",
                           "orl_pp_joint_indMu_model_correlations.rds"))
```

# -------------------------------------------



















