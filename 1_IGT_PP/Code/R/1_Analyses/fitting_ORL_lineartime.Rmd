---
title: "Fitting Linear Time ORL"
output: html_document
date: "2023-03-07"
---



# -------------------------------------------
# Setup
## Load Packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(rstan)
library(hBayesDM)
library(bayesplot)
library(here)
library(miscTools)
library(wBoot)
library(haven)
```



## Load Data
```{r}
stan_data <- readRDS(here("1_IGT_PP", "Data", "1_Preprocessed", "stan_ready_ORL_IGT.rds"))
full_data <- readRDS(here("1_IGT_PP", "Data", "1_Preprocessed", "Dataframe_Sess1&2.rds"))
```



# -------------------------------------------
# Fit Model
```{r, eval = F}
orl_model <- stan_model(here("1_IGT_PP", "Code", "Stan", "igt_orl_lineartime.stan"))

# Fit model
orl_fit <- sampling(
  orl_model, 
  data = stan_data,
  iter = 5000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  seed = 43210
)



#save the fitted model as an .rds file
saveRDS(orl_fit, here("1_IGT_PP", "Data", "2_Fitted", "orl_pp_lineartime.rds"))
```



```{r}
orl_fit <- readRDS(here("1_IGT_PP", "Data", "2_Fitted", "orl_pp_lineartime.rds"))

iterations = orl_fit@sim$chains * (orl_fit@sim$iter - orl_fit@sim$warmup)
```



# -------------------------------------------
# Model Diagnostics
```{r}
posterior <- extract(orl_fit)

focal_parameters <- c(
  "mu_Arew", "mu_Apun", "mu_K",
  "mu_betaF", "mu_betaP", 
  "sigma_Arew", "sigma_Apun", "sigma_K",
  "sigma_betaF", "sigma_betaP", 
  "Arew", "Apun",
  "K", "betaF", "betaP"
)

group_parameters <- grep("mu|sigma", focal_parameters, value=TRUE)
person_parameters <- grep("mu|sigma", focal_parameters, value=TRUE, invert=TRUE)
```



## Rhat
```{r}
rhats <- rhat(
  orl_fit,
  pars = focal_parameters
) %>% 
  as.data.frame() %>%
  mutate(parameter = rownames(.))
```



## Traceplots
```{r}
tiff(here("1_IGT_PP", "Figs_Tables", "ORL_lineartime",
          "orl_pp_lineartime_group_traceplots.tiff"),
     width = 35, height = 25, units = "cm", res = 300)
  traceplot(
    orl_fit,
    pars = group_parameters
)
dev.off()

labels <- person_parameters

for(i in labels){
  tiff(here("1_IGT_PP", "Figs_Tables", "ORL_lineartime",
            paste("orl_pp_lineartime_", i, "_traceplots.tiff", sep = "")),
       width = 35, height = 25, units = "cm", res = 300)
    traceplot(orl_fit,
              pars = i
              ) %>% print()
    dev.off()
  
}
```



# -------------------------------------------
# Inspect Parameters
## Means +/- PI
```{r}
tiff(here("1_IGT_PP", "Figs_Tables", "ORL_lineartime",
          "orl_pp_lineartime_posterior_means.tiff"),
     width = 35, height = 25, units = "cm", res = 300)
  plot(orl_fit, pars = group_parameters)
dev.off()
```



## Posterior Distributions
```{r}
# Extract posterior distributions
parameters <- rstan::extract(orl_fit, pars = group_parameters) %>%
  data.frame()

tiff(here("1_IGT_PP", "Figs_Tables", "ORL_lineartime",
          "orl_pp_lineartime_posterior_distributions.tiff"),
     width = 35, height = 25, units = "cm", res = 300)
  par(mfrow = c(5, 5)) # Create 5 x 5 facetted plot
  # Make a density plot of the posterior distributions for the focal parameters using a for loop
  for(i in colnames(parameters)){
    plot(density(parameters[ , i]), main = i)
    abline(v = mean(parameters[ , i]))
  }
dev.off()
```



# -------------------------------------------
## Results
### Test-Retest Correlations
```{r}
source(here("1_IGT_PP", "Code", "R", "1_Analyses", "plausible_correlations.R"))
```



```{r}
set.seed(20230525)
UT_Arew_Rs = matrix(data = NA, nrow = iterations)
UT_Apun_Rs = matrix(data = NA, nrow = iterations)
UT_K_Rs = matrix(data = NA, nrow = iterations)
betaF_Rs = matrix(data = NA, nrow = iterations)
betaP_Rs = matrix(data = NA, nrow = iterations)

for(i in 1:iterations){
  UT_Arew_Rs[i] = cor(posterior$Arew[i,,1], posterior$Arew[i,,2])
  UT_Apun_Rs[i] = cor(posterior$Apun[i,,1], posterior$Apun[i,,2])
  UT_K_Rs[i] = cor(posterior$K[i,,1], posterior$K[i,,2])
  betaF_Rs[i] = cor(posterior$betaF[i,,1], posterior$betaF[i,,2]) 
  betaP_Rs[i] = cor(posterior$betaP[i,,1], posterior$betaP[i,,2]) 
}
Arew_Rs = pop_correct_MCMC(UT_Arew_Rs, n_subj = 49, kappa = 1)
Apun_Rs = pop_correct_MCMC(UT_Apun_Rs, n_subj = 49, kappa = 1)
K_Rs = pop_correct_MCMC(UT_K_Rs, n_subj = 49, kappa = 1)

mean(Arew_Rs)
mean(Apun_Rs)
mean(K_Rs)
mean(betaF_Rs)
mean(betaP_Rs)

par(mfrow = c(2, 3))
plot(density(Arew_Rs), main = "A+")
abline(v = mean(Arew_Rs))
plot(density(Apun_Rs), main = "A-")
abline(v = mean(Apun_Rs))
plot(density(K_Rs), main = "K")
abline(v = mean(K_Rs))
plot(density(betaF_Rs), main = expression(paste(beta, italic(f), sep = "")))
abline(v = mean(betaF_Rs))
plot(density(betaP_Rs), main = expression(paste(beta, italic(p), sep = "")))
abline(v = mean(betaP_Rs))
```



### Session 1/2 Differences
```{r}
par(mfrow = c(2, 3))
plot(density(posterior$mu_pr[,2,1]), main = "A+")
abline(v = mean(posterior$mu_pr[,2,1]))
abline(v = HDIofMCMC(posterior$mu_pr[,2,1]), col = "red")

plot(density(posterior$mu_pr[,2,2]), main = "A-")
abline(v = mean(posterior$mu_pr[,2,2]))
abline(v = HDIofMCMC(posterior$mu_pr[,2,2]), col = "red")

plot(density(posterior$mu_pr[,2,3]), main = "K")
abline(v = mean(posterior$mu_pr[,2,3]))
abline(v = HDIofMCMC(posterior$mu_pr[,2,3]), col = "red")

plot(density(posterior$mu_pr[,2,4]), main = expression(paste(beta, italic(f), sep = "")))
abline(v = mean(posterior$mu_pr[,2,4]))
abline(v = HDIofMCMC(posterior$mu_pr[,2,4]), col = "red")

plot(density(posterior$mu_pr[,2,5]), main = expression(paste(beta, italic(p), sep = "")))
abline(v = mean(posterior$mu_pr[,2,5]))
abline(v = HDIofMCMC(posterior$mu_pr[,2,5]), col = "red")
```



### Self-Report Correlations
#### Load SR Data
```{r}
sr_sess1 = read_sav(here("1_IGT_PP", "Data", "0_Raw", "MergedQuest_3.21.16-Session1.sav"),
                    col_select = c("ID", "sex", "race", "Ethnicity",
                                   "bastot", "basdrive", "basfunsk",
                                   "basrewres", "bis", "panas_pa",
                                   "panas_na", "masqGDA", "masqAA", "masqGDD",
                                   "masqAD", "shaps_tot", "prdep_tot")) %>% 
  mutate(session = 1) %>%
  filter(ID >= 2049,                          # Subset PP participants
         ID != 2059,                          # Remove participant that played old IFT
         ID != 2083)                          # Remove participant that had no task data
scale_sess1 = c("bastot", "basdrive", "basfunsk", "basrewres", "bis",
                "panas_pa", "panas_na", "masqGDA", "masqAA", "masqGDD",
                "masqAD", "shaps_tot", "prdep_tot")

sr_sess2 = read_sav(here("1_IGT_PP", "Data", "0_Raw", "MergedQuest_3.21.16-Session2.sav"),
                    col_select = c("ID", "bastot", "basdrive", "basfunsk",
                                   "basrewres", "bis", "panas_pa",
                                   "panas_na", "shaps_tot")) %>% 
  mutate(session = 2) %>%
  filter(ID >= 2049,                          # Subset PP participants
         ID != 2059,                          # Remove participant that played old IFT
         ID != 2083,                          # Remove participant that had no task data
         !ID %in% c(2057, 2063, 2064,         # Remove participants that didn't do session 2
                    2067, 2086, 2090,
                    2093, 2094, 2096, 2098))
scale_sess2 = c("bastot", "basdrive", "basfunsk", "basrewres", "bis",
                "panas_pa", "panas_na", "shaps_tot")
```



#### Correlation Function
```{r}
get_SR_corrs = function(post, p_session, parameter, p_name, scale, scale_names){
  post = post[[p_name]]
  if(length(unique(scale$ID)) == 39) post = post[,stan_data$Tsubj[,2]==120,]
  
  corrs = matrix(data = NA, nrow = iterations, ncol = length(scale_names),
                 dimnames = list(c(1:iterations), c(unique(scale_names))))
  
  for(scale_name in scale_names){
    for(i in 1:iterations){
      corrs[i, scale_name] = cor(post[i,,p_session], scale[[scale_name]])
    }
  }
  return(corrs)
}
```



#### ORL 1 vs SR 1
```{r}
print("Arew")
Arew1_SR1_Rs = get_SR_corrs(post = posterior, p_session = 1, parameter = posterior$Arew,
                            p_name = "Arew", scale = sr_sess1, scale_names = scale_sess1)
apply(Arew1_SR1_Rs, 2, mean)

print("Apun")
Apun1_SR1_Rs = get_SR_corrs(post = posterior, p_session = 1, parameter = posterior$Apun,
                            p_name = "Apun", scale = sr_sess1, scale_names = scale_sess1)
apply(Apun1_SR1_Rs, 2, mean)

print("K")
K1_SR1_Rs = get_SR_corrs(post = posterior, p_session = 1, parameter = posterior$K,
                         p_name = "K", scale = sr_sess1, scale_names = scale_sess1)
apply(K1_SR1_Rs, 2, mean)

print("BetaF")
betaF1_SR1_Rs = get_SR_corrs(post = posterior, p_session = 1, parameter = posterior$betaF,
                             p_name = "betaF", scale = sr_sess1, scale_names = scale_sess1)
apply(betaF1_SR1_Rs, 2, mean)

print("BetaP")
betaP1_SR1_Rs = get_SR_corrs(post = posterior, p_session = 1, parameter = posterior$betaP,
                             p_name = "betaP", scale = sr_sess1, scale_names = scale_sess1)
apply(betaP1_SR1_Rs, 2, mean)
```



#### ORL 1 vs SR 2
```{r, eval}
print("Arew")
Arew1_SR2_Rs = get_SR_corrs(post = posterior, p_session = 1, parameter = posterior$Arew,
                            p_name = "Arew", scale = sr_sess2, scale_names = scale_sess2)
apply(Arew1_SR2_Rs, 2, mean)

print("Apun")
Apun1_SR2_Rs = get_SR_corrs(post = posterior, p_session = 1, parameter = posterior$Apun,
                            p_name = "Apun", scale = sr_sess2, scale_names = scale_sess2)
apply(Apun1_SR2_Rs, 2, mean)

print("K")
K1_SR2_Rs = get_SR_corrs(post = posterior, p_session = 1, parameter = posterior$K,
                         p_name = "K", scale = sr_sess2, scale_names = scale_sess2)
apply(K1_SR2_Rs, 2, mean)

print("BetaF")
betaF1_SR2_Rs = get_SR_corrs(post = posterior, p_session = 1, parameter = posterior$betaF,
                             p_name = "betaF", scale = sr_sess2, scale_names = scale_sess2)
apply(betaF1_SR2_Rs, 2, mean)

print("BetaP")
betaP1_SR2_Rs = get_SR_corrs(post = posterior, p_session = 1, parameter = posterior$betaP,
                             p_name = "betaP", scale = sr_sess2, scale_names = scale_sess2)
apply(betaP1_SR2_Rs, 2, mean)
```



#### ORL 2 vs SR 1
```{r, eval}
print("Arew")
Arew2_SR1_Rs = get_SR_corrs(post = posterior, p_session = 2, parameter = posterior$Arew,
                            p_name = "Arew", scale = sr_sess1, scale_names = scale_sess1)
apply(Arew2_SR1_Rs, 2, mean)

print("Apun")
Apun2_SR1_Rs = get_SR_corrs(post = posterior, p_session = 2, parameter = posterior$Apun,
                            p_name = "Apun", scale = sr_sess1, scale_names = scale_sess1)
apply(Apun2_SR1_Rs, 2, mean)

print("K")
K2_SR1_Rs = get_SR_corrs(post = posterior, p_session = 2, parameter = posterior$K,
                         p_name = "K", scale = sr_sess1, scale_names = scale_sess1)
apply(K2_SR1_Rs, 2, mean)

print("BetaF")
betaF2_SR1_Rs = get_SR_corrs(post = posterior, p_session = 2, parameter = posterior$betaF,
                             p_name = "betaF", scale = sr_sess1, scale_names = scale_sess1)
apply(betaF2_SR1_Rs, 2, mean)

print("BetaP")
betaP2_SR1_Rs = get_SR_corrs(post = posterior, p_session = 2, parameter = posterior$betaP,
                             p_name = "betaP", scale = sr_sess1, scale_names = scale_sess1)
apply(betaP2_SR1_Rs, 2, mean)
```



#### ORL 2 vs SR 2
```{r}
print("Arew")
Arew2_SR2_Rs = get_SR_corrs(post = posterior, p_session = 2, parameter = posterior$Arew,
                            p_name = "Arew", scale = sr_sess2, scale_names = scale_sess2)
apply(Arew2_SR2_Rs, 2, mean)

print("Apun")
Apun2_SR2_Rs = get_SR_corrs(post = posterior, p_session = 2, parameter = posterior$Apun,
                            p_name = "Apun", scale = sr_sess2, scale_names = scale_sess2)
apply(Apun2_SR2_Rs, 2, mean)

print("K")
K2_SR2_Rs = get_SR_corrs(post = posterior, p_session = 2, parameter = posterior$K,
                         p_name = "K", scale = sr_sess2, scale_names = scale_sess2)
apply(K2_SR2_Rs, 2, mean)

print("BetaF")
betaF2_SR2_Rs = get_SR_corrs(post = posterior, p_session = 2, parameter = posterior$betaF,
                             p_name = "betaF", scale = sr_sess2, scale_names = scale_sess2)
apply(betaF2_SR2_Rs, 2, mean)

print("BetaP")
betaP2_SR2_Rs = get_SR_corrs(post = posterior, p_session = 2, parameter = posterior$betaP,
                             p_name = "betaP", scale = sr_sess2, scale_names = scale_sess2)
apply(betaP2_SR2_Rs, 2, mean)
```



# -------------------------------------------



















