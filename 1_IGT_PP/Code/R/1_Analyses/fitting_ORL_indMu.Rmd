---
title: "Fitting Ind-Mu ORL"
output: html_document
date: "2023-03-07"
---



# -------------------------------------------
# Setup
## Load Packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(rstan)
library(hBayesDM)
library(bayesplot)
library(here)
library(miscTools)
library(wBoot)
library(haven)
```



## Load Data
```{r}
stan_data <- readRDS(here("1_IGT_PP", "Data", "1_Preprocessed", "stan_ready_IGT_ORL.rds"))
full_data <- readRDS(here("1_IGT_PP", "Data", "1_Preprocessed", "Dataframe_Sess1&2.rds"))
```



# -------------------------------------------
# Fit Model
```{r, eval = F}
orl_model <- stan_model(here("1_IGT_PP", "Code", "Stan", "igt_orl_indMu.stan"))

# Fit model
orl_fit <- sampling(
  orl_model, 
  data = stan_data,
  iter = 5000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  seed = 43210
)



#save the fitted model as an .rds file
saveRDS(orl_fit, here("1_IGT_PP", "Data", "2_Fitted", "orl_pp_indMu.rds"))
```



```{r}
orl_fit <- readRDS(here("1_IGT_PP", "Data", "2_Fitted", "orl_pp_indMu.rds"))

iterations = orl_fit@sim$chains * (orl_fit@sim$iter - orl_fit@sim$warmup)
```



# -------------------------------------------
# Model Diagnostics
```{r}
orl_posteriors <- extract(orl_fit)

focal_parameters <- c(
  "mu_Arew", "mu_Apun", "mu_K",
  "mu_betaF", "mu_betaP", 
  "sigma_Arew", "sigma_Apun", "sigma_K",
  "sigma_betaF", "sigma_betaP", 
  "Arew", "Apun",
  "K", "betaF", "betaP"
)

group_parameters <- grep("mu|sigma", focal_parameters, value=TRUE)
person_parameters <- grep("mu|sigma", focal_parameters, value=TRUE, invert=TRUE)
```



## Rhat
```{r}
rhats <- rhat(
  orl_fit,
  pars = focal_parameters
) %>% 
  as.data.frame() %>%
  mutate(parameter = rownames(.))
```



## Traceplots
```{r}
tiff(here("1_IGT_PP", "Figs_Tables", "ORL_indMu",
          "orl_pp_joint_indMu_group_traceplots.tiff"),
     width = 35, height = 25, units = "cm", res = 300)
  traceplot(
    orl_fit,
    pars = group_parameters
)
dev.off()

labels <- person_parameters

for(i in labels){
  tiff(here("1_IGT_PP", "Figs_Tables", "Joint",
            paste("orl_pp_joint_indMu_", i, "_traceplots.tiff", sep = "")),
       width = 35, height = 25, units = "cm", res = 300)
    traceplot(orl_fit,
              pars = i
              ) %>% print()
    dev.off()
  
}
```



# -------------------------------------------
# Inspect Parameters
## Means +/- PI
```{r}
tiff(here("1_IGT_PP", "Figs_Tables", "ORL_indMu",
          "orl_pp_joint_indMu_posterior_means.tiff"),
     width = 35, height = 25, units = "cm", res = 300)
  plot(orl_fit, pars = group_parameters)
dev.off()
```



## Posterior Distributions
```{r}
# Extract posterior distributions
orl_parameters <- rstan::extract(orl_fit, pars = group_parameters) %>%
  data.frame()

tiff(here("1_IGT_PP", "Figs_Tables", "ORL_indMu",
          "orl_pp_joint_indMu_posterior_distributions.tiff"),
     width = 35, height = 25, units = "cm", res = 300)
  par(mfrow = c(5, 5)) # Create 5 x 5 facetted plot
  # Make a density plot of the posterior distributions for the focal parameters using a for loop
  for(i in colnames(orl_parameters)){
    plot(density(orl_parameters[ , i]), main = i)
    abline(v = mean(orl_parameters[ , i]))
  }
dev.off()
```



# -------------------------------------------
# Results
## Self-Report Correlations
```{r}
selfreport_models = readRDS(here("1_IGT_PP", "Data", "2_Fitted", "binomial_selfreport_indMu_fits.rds"))
selfreport = readRDS(here("1_IGT_PP", "Data", "1_Preprocessed", "stan_ready_binomial_selfreport.rds"))
```



```{r}
scales = c(# Session 1 only
           "prdep_tot", "masqGDA", "masqAA", "masqGDD",
           # "masqAD", # Removed
           # Both Sessions
           "bastot", "basdrive", "basfunsk", "basrewres",
           "bis", "panas_pa", "panas_na", "shaps_tot")


selfreport_posteriors = list()
sr_posterior_means = list()

for(scale in scales){
  selfreport_posteriors[[scale]] = extract(selfreport_models[[scale]], par = "theta")
  sr_posterior_means[[scale]] = apply(selfreport_posteriors[[scale]]$theta*selfreport[[scale]]$M, 2, mean)
}

orl_posterior_means = list()

for(parameter in person_parameters){
  orl_posterior_means[[parameter]] = apply(orl_posteriors[[parameter]], 2, mean)
}
```



```{r}
for(parameter in person_parameters){
  for(scale in scales){
    print(paste(parameter, " vs ", scale, ": r = ",
                round(cor(orl_posterior_means[[parameter]], sr_posterior_means[[scale]]), 2),
                sep = ""))
  }
}
```



## Relations to Behavior
```{r}
choice = ifelse(stan_data$choice == 1, 1, ifelse(stan_data$choice == 2, 0, NA))

card_proportions = matrix(data = NA, nrow = 49, ncol = 4)
good_proportions = vector()

for(i in 1:49){
  good_proportions[i] = mean(choice[i,,][stan_data$card[i,,] == 3 | stan_data$card[i,,] == 4])
  for(c in 1:4){
    card_proportions[i,c] = mean(choice[i,,][stan_data$card[i,,] == c])
  }
}
```



```{r}
for(parameter in person_parameters){
  for(c in 1:4){
    card = ifelse(c == 1, "Super bad",
                  ifelse(c == 2, "Kinda bad",
                         ifelse(c == 3, "Kinda good", "Super good")))
    print(paste(parameter, " vs card", c, ": r = ",
                round(cor(orl_posterior_means[[parameter]], card_proportions[,c]), 2),
                sep = ""))
  }
}
```



```{r}
for(parameter in person_parameters){
    print(paste(parameter, " vs card", c, ": r = ",
                round(cor(orl_posterior_means[[parameter]], good_proportions), 2),
                sep = ""))
}
```


# -------------------------------------------



















