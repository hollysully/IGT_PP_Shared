---
title: "Parameter Recovery for RL"
output: 
  html_document:
    theme: flatly
    toc: yes
    toc_float:
      collapsed: true
---



```{css, echo = F}
#TOC {
    max-width: fit-content;
    white-space: nowrap;
  }
  
  div:has(> #TOC) {
    display: flex;
    flex-direction: row-reverse;
}
div.tocify {
width: 100%;
}
```


```{r setup, include=FALSE}
# -------------------------------------------
# SETUP
knitr::opts_chunk$set(echo = F, warning = F, message = F,
                      fig.align = "center")


# -------------------------------------------
# LOAD PACKAGES
library(tidyverse)
library(rstan)
library(hBayesDM)
library(bayesplot)
library(here)
library(miscTools)
library(cmdstanr)
library(stringi)
library(ggpp)
library(lemon)
source(here("1_IGT_PP", "Code", "R", "3_other", "helpful_functions.R"))
library(MASS)
library(ggh4x)
library(grid)
library(extraDistr)
library(lme4)
library(knitr)
library(stargazer)
library(kableExtra)


# -------------------------------------------
# SPECIFY CONDITIONS
conditions = "LoB_LoR"


# -------------------------------------------
# LOAD DATA
parameters = list()
stan_data = list()

for(condition in conditions){
}
```


# Low Beta-Low R
```{r}
# SET CONDITION
condition = "LoB_LoR"


# PARAMETERS
parameters = readRDS(here("1_HLCM", "Data", "0_Simulated_RL",
                          paste0("RL_parameters_", condition, ".RDS")))


# LOAD DATA
stan_data = readRDS(here("1_HLCM", "Data", "1_Stan",
                         paste0("RL_choices_", condition, ".RDS")))

timestamps = list()
RL_posteriors = list()

for(s in 1:stan_data$S){
  # TIMESTAMPS
  timestamps[[paste0("S", s)]] =
    readRDS(here("1_HLCM", "Data", "2_Fitted", paste0("RL_", condition),
                 paste0("S", s, "_Timestamp.RDS")))
  
  # POSTERIORS
  RL_posteriors[[paste0("S", s)]] =
    readRDS(here("1_HLCM", "Data", "2_Fitted", paste0("RL_", condition),
                 paste0("S", s, "_Posteriors.RDS")))
}
```


## ORL Timestamps
```{r}
data.frame(Session = c("Session 1", "Session 2", "Session 3", "Session 4", "Session 5"),
           Start = c(timestamps$S1$start, timestamps$S2$start, timestamps$S3$start, 
                     timestamps$S4$start, timestamps$S5$start),
           End = c(timestamps$S1$end, timestamps$S2$end, timestamps$S3$end, 
                   timestamps$S4$end, timestamps$S5$end),
           Runtime = round(c(timestamps$S1$diff, timestamps$S2$diff, timestamps$S3$diff, 
                       timestamps$S4$diff, timestamps$S5$diff), 2)) %>% 
  kable(format = "html", escape = FALSE,
        col.names = c("Session",
                      "Start",
                      "End",
                      "Runtime")) %>% 
  kable_styling()
```


## ORL Parameter Recovery
### Group-Level Parameters
```{r}
group_level_parameters = data.frame()
for(s in 1:stan_data$S){
  group_level_parameters =
    bind_rows(group_level_parameters,
              data.frame(
                Session = paste("Session", s),
                True_Mean = round(parameters$mu_intercept_UT + parameters$mu_beta_UT*(s-1), 3),
                Estimated_Mean = round(mean(RL_posteriors[[paste0("S", s)]]$gamma00), 3),
                True_SD = round(parameters$sd_intercept_UT, 3),
                Estimated_SD = round(mean(RL_posteriors[[paste0("S", s)]]$sigma_U), 3))
              )
}

kable(group_level_parameters, format = "html", escape = FALSE,
      col.names = c("Session", 
                    "True Mean", 
                    "Estimate Mean",
                    "True SD",
                    "Estimated SD")) %>% 
  kable_styling()
```


### Person-Level Parameters
```{r}
# PREP PARAMETERS
RL_parameters = data.frame()
for(s in 1:stan_data$S){
  RL_parameters = data.frame(ID = 1:stan_data$N, session = s,
                             true_theta = parameters$A_UTs[,s],
                             est_theta = apply(RL_posteriors[[paste0("S",s)]]$theta, 2, mean),
                             true_A = parameters$As[,s],
                             est_A = apply(RL_posteriors[[paste0("S",s)]]$A, 2, mean)) %>% 
    bind_rows(RL_parameters)
}

RL_parameters = RL_parameters %>% 
  pivot_longer(starts_with(c("true", "est")),
               names_to = "parameter", values_to = "estimate") %>% 
  mutate(type = case_when(str_detect(parameter, "true") ~ "true", T ~ "est"),
         parameter = str_remove(parameter, "true_|est_")) %>% 
  pivot_wider(names_from = "type", values_from = "estimate") %>% 
  group_by(session, parameter) %>% 
  mutate(r = cor(true, est),
         r_lab = paste0("r=.", round(r*100)))


# BUILD PLOT
person_level_plot = RL_parameters %>% 
    mutate(session_lab = case_when(parameter == "A_UT" ~ paste0("T", session), T ~ "")) %>% 
    ggplot(aes(x = true, y = est)) +
      ggpp::geom_text_npc(aes(npcx = "right", npcy = "bottom", label = session_lab),
                          hjust = .95, vjust = .25, size = 7) +
      geom_point() +
      geom_smooth(method = "lm", formula = y~x, se = F) +
      geom_text_npc(aes(npcx = "left", npcy = "top", label = r_lab), check_overlap = T) +
      scale_x_continuous(expand = expansion(mult = .025)) +
      scale_y_continuous(expand = expansion(mult = .025)) +
      labs(x = "True Person-Level Estimate", y = "Estimated Person-Level Estimate") +
      theme_classic() +
      theme(axis.text = element_blank(),
            axis.title = element_text(size = 16),
            strip.text = element_blank(),
            plot.margin = unit(c(1, .5, .5, .5), units = "cm")) +
      lemon::facet_rep_wrap(session~parameter, scales = "free", ncol = 2)
```


```{r, fig.width=4, fig.height=8.5}
# plot
# grid.newpage()
# pushViewport(viewport(x = .5, y = .5, width = 1, height = 1))
grid.draw(person_level_plot)

# text
grid.text(c(expression(italic(A)), expression(paste("Unbounded ", italic(A)))),
          x = c(.325, .75), y = .98,
          gp = gpar(fontsize = 18))
```


## Growth Parameter Recovery
### LMER Model
```{r, results='asis'}
growth_model = RL_parameters %>% 
  filter(parameter == "theta") %>% 
  lmer(est ~ session + (session|ID),
             data = ., REML = T)
stargazer(growth_model, type = "html", digits = 3)

performance::check_model(growth_model)
```


### Quantitative Comparison
```{r}
data.frame(
  True_Intercept = round(parameters$mu_intercept_UT, 3),
  Estimated_Intercept =
    round(summary(growth_model)$coefficients["(Intercept)", "Estimate"], 3),
  True_Slope = round(parameters$mu_beta_UT, 3),
  Estimated_Slope =
    round(summary(growth_model)$coefficients["session", "Estimate"], 3),
  True_R = round(parameters$int_slope_R, 3),
  Estimated_R =
    round(attr(VarCorr(growth_model)$ID, "correlation")["(Intercept)", "session"], 3)) %>% 
  kable(format = "html", escape = FALSE,
        col.names = c("True Intercept",
                      "Estimate Intercept",
                      "True Slope",
                      "Estimated Slope",
                      "True R",
                      "Estimated R")) %>% 
  kable_styling()
```


### Visual Comparison
```{r, fig.width=5, fig.height=4}
RL_parameters %>% 
  # PREP DATA
  ungroup() %>% filter(parameter == "theta") %>% 
  dplyr::select(ID, session, true, est) %>% 
  pivot_longer(c("true", "est"), values_to = "theta",
               names_to = "type") %>%  
  # PLOT
  ggplot(aes(x = session, y = theta, group = interaction(session, type),
             color = type, fill = type)) +
    # GEOMS
    geom_violin(position = position_dodge(width = .5), trim = F, alpha = .05,
                linewidth = .5, width = 1) +
    geom_point(position = position_dodge(width = .5), alpha = .5) +
    geom_abline(intercept = parameters$mu_intercept_UT, slope = parameters$mu_beta_UT,
                color = "dodgerblue3", size = 1) +
    geom_abline(intercept = summary(growth_model)$coefficients["(Intercept)", "Estimate"],
                slope = summary(growth_model)$coefficients["session", "Estimate"],
                color = "goldenrod3", size = 1) +
    # SCALES
    scale_color_manual(values = c("goldenrod3", "dodgerblue3"), 
                       labels = c("est" = "Estimated", "true" = "True")) +
    scale_fill_manual(values = c("goldenrod3", "dodgerblue3"), 
                      labels = c("est" = "Estimated", "true" = "True")) +
    # THEMES
    labs(x = "Session", y = expression(italic(A))) +
    theme_classic() +
    theme(axis.text = element_text(color = "black", size = 12),
          axis.title = element_text(size = 16),
          legend.text = element_text(size = 12),
          legend.title = element_blank(),
          legend.position = c(.15, .9))
```


# High Beta-Low R
```{r}
# SET CONDITION
condition = "HiB_LoR"


# PARAMETERS
parameters = readRDS(here("1_HLCM", "Data", "0_Simulated_RL",
                          paste0("RL_parameters_", condition, ".RDS")))


# LOAD DATA
stan_data = readRDS(here("1_HLCM", "Data", "1_Stan",
                         paste0("RL_choices_", condition, ".RDS")))

timestamps = list()
RL_posteriors = list()

for(s in 1:stan_data$S){
  # TIMESTAMPS
  timestamps[[paste0("S", s)]] =
    readRDS(here("1_HLCM", "Data", "2_Fitted", paste0("RL_", condition),
                 paste0("S", s, "_Timestamp.RDS")))
  
  # POSTERIORS
  RL_posteriors[[paste0("S", s)]] =
    readRDS(here("1_HLCM", "Data", "2_Fitted", paste0("RL_", condition),
                 paste0("S", s, "_Posteriors.RDS")))
}
```


## ORL Timestamps
```{r}
data.frame(Session = c("Session 1", "Session 2", "Session 3", "Session 4", "Session 5"),
           Start = c(timestamps$S1$start, timestamps$S2$start, timestamps$S3$start, 
                     timestamps$S4$start, timestamps$S5$start),
           End = c(timestamps$S1$end, timestamps$S2$end, timestamps$S3$end, 
                   timestamps$S4$end, timestamps$S5$end),
           Runtime = round(c(timestamps$S1$diff, timestamps$S2$diff, timestamps$S3$diff, 
                       timestamps$S4$diff, timestamps$S5$diff), 2)) %>% 
  kable(format = "html", escape = FALSE,
        col.names = c("Session",
                      "Start",
                      "End",
                      "Runtime")) %>% 
  kable_styling()
```


## ORL Parameter Recovery
### Group-Level Parameters
```{r}
group_level_parameters = data.frame()
for(s in 1:stan_data$S){
  group_level_parameters =
    bind_rows(group_level_parameters,
              data.frame(
                Session = paste("Session", s),
                True_Mean = round(parameters$mu_intercept_UT + parameters$mu_beta_UT*(s-1), 3),
                Estimated_Mean = round(mean(RL_posteriors[[paste0("S", s)]]$gamma00), 3),
                True_SD = round(parameters$sd_intercept_UT, 3),
                Estimated_SD = round(mean(RL_posteriors[[paste0("S", s)]]$sigma_U), 3))
              )
}

kable(group_level_parameters, format = "html", escape = FALSE,
      col.names = c("Session", 
                    "True Mean", 
                    "Estimate Mean",
                    "True SD",
                    "Estimated SD")) %>% 
  kable_styling()
```


### Person-Level Parameters
```{r}
# PREP PARAMETERS
RL_parameters = data.frame()
for(s in 1:stan_data$S){
  RL_parameters = data.frame(ID = 1:stan_data$N, session = s,
                             true_theta = parameters$A_UTs[,s],
                             est_theta = apply(RL_posteriors[[paste0("S",s)]]$theta, 2, mean),
                             true_A = parameters$As[,s],
                             est_A = apply(RL_posteriors[[paste0("S",s)]]$A, 2, mean)) %>% 
    bind_rows(RL_parameters)
}

RL_parameters = RL_parameters %>% 
  pivot_longer(starts_with(c("true", "est")),
               names_to = "parameter", values_to = "estimate") %>% 
  mutate(type = case_when(str_detect(parameter, "true") ~ "true", T ~ "est"),
         parameter = str_remove(parameter, "true_|est_")) %>% 
  pivot_wider(names_from = "type", values_from = "estimate") %>% 
  group_by(session, parameter) %>% 
  mutate(r = cor(true, est),
         r_lab = paste0("r=.", round(r*100)))


# BUILD PLOT
person_level_plot = RL_parameters %>% 
    mutate(session_lab = case_when(parameter == "A_UT" ~ paste0("T", session), T ~ "")) %>% 
    ggplot(aes(x = true, y = est)) +
      ggpp::geom_text_npc(aes(npcx = "right", npcy = "bottom", label = session_lab),
                          hjust = .95, vjust = .25, size = 7) +
      geom_point() +
      geom_smooth(method = "lm", formula = y~x, se = F) +
      geom_text_npc(aes(npcx = "left", npcy = "top", label = r_lab), check_overlap = T) +
      scale_x_continuous(expand = expansion(mult = .025)) +
      scale_y_continuous(expand = expansion(mult = .025)) +
      labs(x = "True Person-Level Estimate", y = "Estimated Person-Level Estimate") +
      theme_classic() +
      theme(axis.text = element_blank(),
            axis.title = element_text(size = 16),
            strip.text = element_blank(),
            plot.margin = unit(c(1, .5, .5, .5), units = "cm")) +
      lemon::facet_rep_wrap(session~parameter, scales = "free", ncol = 2)
```


```{r, fig.width=4, fig.height=8.5}
# plot
# grid.newpage()
# pushViewport(viewport(x = .5, y = .5, width = 1, height = 1))
grid.draw(person_level_plot)

# text
grid.text(c(expression(italic(A)), expression(paste("Unbounded ", italic(A)))),
          x = c(.325, .75), y = .98,
          gp = gpar(fontsize = 18))
```


## Growth Parameter Recovery
### LMER Model
```{r, results='asis'}
growth_model = RL_parameters %>% 
  filter(parameter == "theta") %>% 
  lmer(est ~ session + (session|ID),
             data = ., REML = T)
stargazer(growth_model, type = "html", digits = 3)

performance::check_model(growth_model)
```


### Quantitative Comparison
```{r}
data.frame(
  True_Intercept = round(parameters$mu_intercept_UT, 3),
  Estimated_Intercept =
    round(summary(growth_model)$coefficients["(Intercept)", "Estimate"], 3),
  True_Slope = round(parameters$mu_beta_UT, 3),
  Estimated_Slope =
    round(summary(growth_model)$coefficients["session", "Estimate"], 3),
  True_R = round(parameters$int_slope_R, 3),
  Estimated_R =
    round(attr(VarCorr(growth_model)$ID, "correlation")["(Intercept)", "session"], 3)) %>% 
  kable(format = "html", escape = FALSE,
        col.names = c("True Intercept",
                      "Estimate Intercept",
                      "True Slope",
                      "Estimated Slope",
                      "True R",
                      "Estimated R")) %>% 
  kable_styling()
```


### Visual Comparison
```{r, fig.width=5, fig.height=4}
RL_parameters %>% 
  # PREP DATA
  ungroup() %>% filter(parameter == "theta") %>% 
  dplyr::select(ID, session, true, est) %>% 
  pivot_longer(c("true", "est"), values_to = "theta",
               names_to = "type") %>%  
  # PLOT
  ggplot(aes(x = session, y = theta, group = interaction(session, type),
             color = type, fill = type)) +
    # GEOMS
    geom_violin(position = position_dodge(width = .5), trim = F, alpha = .05,
                linewidth = .5, width = 1) +
    geom_point(position = position_dodge(width = .5), alpha = .5) +
    geom_abline(intercept = parameters$mu_intercept_UT, slope = parameters$mu_beta_UT,
                color = "dodgerblue3", size = 1) +
    geom_abline(intercept = summary(growth_model)$coefficients["(Intercept)", "Estimate"],
                slope = summary(growth_model)$coefficients["session", "Estimate"],
                color = "goldenrod3", size = 1) +
    # SCALES
    scale_color_manual(values = c("goldenrod3", "dodgerblue3"), 
                       labels = c("est" = "Estimated", "true" = "True")) +
    scale_fill_manual(values = c("goldenrod3", "dodgerblue3"), 
                      labels = c("est" = "Estimated", "true" = "True")) +
    # THEMES
    labs(x = "Session", y = expression(italic(A))) +
    theme_classic() +
    theme(axis.text = element_text(color = "black", size = 12),
          axis.title = element_text(size = 16),
          legend.text = element_text(size = 12),
          legend.title = element_blank(),
          legend.position = c(.15, .9))
```


# Low Beta-High R
```{r}
# SET CONDITION
condition = "LoB_HiR"


# PARAMETERS
parameters = readRDS(here("1_HLCM", "Data", "0_Simulated_RL",
                          paste0("RL_parameters_", condition, ".RDS")))


# LOAD DATA
stan_data = readRDS(here("1_HLCM", "Data", "1_Stan",
                         paste0("RL_choices_", condition, ".RDS")))

timestamps = list()
RL_posteriors = list()

for(s in 1:stan_data$S){
  # TIMESTAMPS
  timestamps[[paste0("S", s)]] =
    readRDS(here("1_HLCM", "Data", "2_Fitted", paste0("RL_", condition),
                 paste0("S", s, "_Timestamp.RDS")))
  
  # POSTERIORS
  RL_posteriors[[paste0("S", s)]] =
    readRDS(here("1_HLCM", "Data", "2_Fitted", paste0("RL_", condition),
                 paste0("S", s, "_Posteriors.RDS")))
}
```


## ORL Timestamps
```{r}
data.frame(Session = c("Session 1", "Session 2", "Session 3", "Session 4", "Session 5"),
           Start = c(timestamps$S1$start, timestamps$S2$start, timestamps$S3$start, 
                     timestamps$S4$start, timestamps$S5$start),
           End = c(timestamps$S1$end, timestamps$S2$end, timestamps$S3$end, 
                   timestamps$S4$end, timestamps$S5$end),
           Runtime = round(c(timestamps$S1$diff, timestamps$S2$diff, timestamps$S3$diff, 
                       timestamps$S4$diff, timestamps$S5$diff), 2)) %>% 
  kable(format = "html", escape = FALSE,
        col.names = c("Session",
                      "Start",
                      "End",
                      "Runtime")) %>% 
  kable_styling()
```


## ORL Parameter Recovery
### Group-Level Parameters
```{r}
group_level_parameters = data.frame()
for(s in 1:stan_data$S){
  group_level_parameters =
    bind_rows(group_level_parameters,
              data.frame(
                Session = paste("Session", s),
                True_Mean = round(parameters$mu_intercept_UT + parameters$mu_beta_UT*(s-1), 3),
                Estimated_Mean = round(mean(RL_posteriors[[paste0("S", s)]]$gamma00), 3),
                True_SD = round(parameters$sd_intercept_UT, 3),
                Estimated_SD = round(mean(RL_posteriors[[paste0("S", s)]]$sigma_U), 3))
              )
}

kable(group_level_parameters, format = "html", escape = FALSE,
      col.names = c("Session", 
                    "True Mean", 
                    "Estimate Mean",
                    "True SD",
                    "Estimated SD")) %>% 
  kable_styling()
```


### Person-Level Parameters
```{r}
# PREP PARAMETERS
RL_parameters = data.frame()
for(s in 1:stan_data$S){
  RL_parameters = data.frame(ID = 1:stan_data$N, session = s,
                             true_theta = parameters$A_UTs[,s],
                             est_theta = apply(RL_posteriors[[paste0("S",s)]]$theta, 2, mean),
                             true_A = parameters$As[,s],
                             est_A = apply(RL_posteriors[[paste0("S",s)]]$A, 2, mean)) %>% 
    bind_rows(RL_parameters)
}

RL_parameters = RL_parameters %>% 
  pivot_longer(starts_with(c("true", "est")),
               names_to = "parameter", values_to = "estimate") %>% 
  mutate(type = case_when(str_detect(parameter, "true") ~ "true", T ~ "est"),
         parameter = str_remove(parameter, "true_|est_")) %>% 
  pivot_wider(names_from = "type", values_from = "estimate") %>% 
  group_by(session, parameter) %>% 
  mutate(r = cor(true, est),
         r_lab = paste0("r=.", round(r*100)))


# BUILD PLOT
person_level_plot = RL_parameters %>% 
    mutate(session_lab = case_when(parameter == "A_UT" ~ paste0("T", session), T ~ "")) %>% 
    ggplot(aes(x = true, y = est)) +
      ggpp::geom_text_npc(aes(npcx = "right", npcy = "bottom", label = session_lab),
                          hjust = .95, vjust = .25, size = 7) +
      geom_point() +
      geom_smooth(method = "lm", formula = y~x, se = F) +
      geom_text_npc(aes(npcx = "left", npcy = "top", label = r_lab), check_overlap = T) +
      scale_x_continuous(expand = expansion(mult = .025)) +
      scale_y_continuous(expand = expansion(mult = .025)) +
      labs(x = "True Person-Level Estimate", y = "Estimated Person-Level Estimate") +
      theme_classic() +
      theme(axis.text = element_blank(),
            axis.title = element_text(size = 16),
            strip.text = element_blank(),
            plot.margin = unit(c(1, .5, .5, .5), units = "cm")) +
      lemon::facet_rep_wrap(session~parameter, scales = "free", ncol = 2)
```


```{r, fig.width=4, fig.height=8.5}
# plot
# grid.newpage()
# pushViewport(viewport(x = .5, y = .5, width = 1, height = 1))
grid.draw(person_level_plot)

# text
grid.text(c(expression(italic(A)), expression(paste("Unbounded ", italic(A)))),
          x = c(.325, .75), y = .98,
          gp = gpar(fontsize = 18))
```


## Growth Parameter Recovery
### LMER Model
```{r, results='asis'}
growth_model = RL_parameters %>% 
  filter(parameter == "theta") %>% 
  lmer(est ~ session + (session|ID),
             data = ., REML = T)
stargazer(growth_model, type = "html", digits = 3)

performance::check_model(growth_model)
```


### Quantitative Comparison
```{r}
data.frame(
  True_Intercept = round(parameters$mu_intercept_UT, 3),
  Estimated_Intercept =
    round(summary(growth_model)$coefficients["(Intercept)", "Estimate"], 3),
  True_Slope = round(parameters$mu_beta_UT, 3),
  Estimated_Slope =
    round(summary(growth_model)$coefficients["session", "Estimate"], 3),
  True_R = round(parameters$int_slope_R, 3),
  Estimated_R =
    round(attr(VarCorr(growth_model)$ID, "correlation")["(Intercept)", "session"], 3)) %>% 
  kable(format = "html", escape = FALSE,
        col.names = c("True Intercept",
                      "Estimate Intercept",
                      "True Slope",
                      "Estimated Slope",
                      "True R",
                      "Estimated R")) %>% 
  kable_styling()
```


### Visual Comparison
```{r, fig.width=5, fig.height=4}
RL_parameters %>% 
  # PREP DATA
  ungroup() %>% filter(parameter == "theta") %>% 
  dplyr::select(ID, session, true, est) %>% 
  pivot_longer(c("true", "est"), values_to = "theta",
               names_to = "type") %>%  
  # PLOT
  ggplot(aes(x = session, y = theta, group = interaction(session, type),
             color = type, fill = type)) +
    # GEOMS
    geom_violin(position = position_dodge(width = .5), trim = F, alpha = .05,
                linewidth = .5, width = 1) +
    geom_point(position = position_dodge(width = .5), alpha = .5) +
    geom_abline(intercept = parameters$mu_intercept_UT, slope = parameters$mu_beta_UT,
                color = "dodgerblue3", size = 1) +
    geom_abline(intercept = summary(growth_model)$coefficients["(Intercept)", "Estimate"],
                slope = summary(growth_model)$coefficients["session", "Estimate"],
                color = "goldenrod3", size = 1) +
    # SCALES
    scale_color_manual(values = c("goldenrod3", "dodgerblue3"), 
                       labels = c("est" = "Estimated", "true" = "True")) +
    scale_fill_manual(values = c("goldenrod3", "dodgerblue3"), 
                      labels = c("est" = "Estimated", "true" = "True")) +
    # THEMES
    labs(x = "Session", y = expression(italic(A))) +
    theme_classic() +
    theme(axis.text = element_text(color = "black", size = 12),
          axis.title = element_text(size = 16),
          legend.text = element_text(size = 12),
          legend.title = element_blank(),
          legend.position = c(.15, .9))
```


# High Beta-High R
```{r}
# SET CONDITION
condition = "HiB_HiR"


# PARAMETERS
parameters = readRDS(here("1_HLCM", "Data", "0_Simulated_RL",
                          paste0("RL_parameters_", condition, ".RDS")))


# LOAD DATA
stan_data = readRDS(here("1_HLCM", "Data", "1_Stan",
                         paste0("RL_choices_", condition, ".RDS")))

timestamps = list()
RL_posteriors = list()

for(s in 1:stan_data$S){
  # TIMESTAMPS
  timestamps[[paste0("S", s)]] =
    readRDS(here("1_HLCM", "Data", "2_Fitted", paste0("RL_", condition),
                 paste0("S", s, "_Timestamp.RDS")))
  
  # POSTERIORS
  RL_posteriors[[paste0("S", s)]] =
    readRDS(here("1_HLCM", "Data", "2_Fitted", paste0("RL_", condition),
                 paste0("S", s, "_Posteriors.RDS")))
}
```


## ORL Timestamps
```{r}
data.frame(Session = c("Session 1", "Session 2", "Session 3", "Session 4", "Session 5"),
           Start = c(timestamps$S1$start, timestamps$S2$start, timestamps$S3$start, 
                     timestamps$S4$start, timestamps$S5$start),
           End = c(timestamps$S1$end, timestamps$S2$end, timestamps$S3$end, 
                   timestamps$S4$end, timestamps$S5$end),
           Runtime = round(c(timestamps$S1$diff, timestamps$S2$diff, timestamps$S3$diff, 
                       timestamps$S4$diff, timestamps$S5$diff), 2)) %>% 
  kable(format = "html", escape = FALSE,
        col.names = c("Session",
                      "Start",
                      "End",
                      "Runtime")) %>% 
  kable_styling()
```


## ORL Parameter Recovery
### Group-Level Parameters
```{r}
group_level_parameters = data.frame()
for(s in 1:stan_data$S){
  group_level_parameters =
    bind_rows(group_level_parameters,
              data.frame(
                Session = paste("Session", s),
                True_Mean = round(parameters$mu_intercept_UT + parameters$mu_beta_UT*(s-1), 3),
                Estimated_Mean = round(mean(RL_posteriors[[paste0("S", s)]]$gamma00), 3),
                True_SD = round(parameters$sd_intercept_UT, 3),
                Estimated_SD = round(mean(RL_posteriors[[paste0("S", s)]]$sigma_U), 3))
              )
}

kable(group_level_parameters, format = "html", escape = FALSE,
      col.names = c("Session", 
                    "True Mean", 
                    "Estimate Mean",
                    "True SD",
                    "Estimated SD")) %>% 
  kable_styling()
```


### Person-Level Parameters
```{r}
# PREP PARAMETERS
RL_parameters = data.frame()
for(s in 1:stan_data$S){
  RL_parameters = data.frame(ID = 1:stan_data$N, session = s,
                             true_theta = parameters$A_UTs[,s],
                             est_theta = apply(RL_posteriors[[paste0("S",s)]]$theta, 2, mean),
                             true_A = parameters$As[,s],
                             est_A = apply(RL_posteriors[[paste0("S",s)]]$A, 2, mean)) %>% 
    bind_rows(RL_parameters)
}

RL_parameters = RL_parameters %>% 
  pivot_longer(starts_with(c("true", "est")),
               names_to = "parameter", values_to = "estimate") %>% 
  mutate(type = case_when(str_detect(parameter, "true") ~ "true", T ~ "est"),
         parameter = str_remove(parameter, "true_|est_")) %>% 
  pivot_wider(names_from = "type", values_from = "estimate") %>% 
  group_by(session, parameter) %>% 
  mutate(r = cor(true, est),
         r_lab = paste0("r=.", round(r*100)))


# BUILD PLOT
person_level_plot = RL_parameters %>% 
    mutate(session_lab = case_when(parameter == "A_UT" ~ paste0("T", session), T ~ "")) %>% 
    ggplot(aes(x = true, y = est)) +
      ggpp::geom_text_npc(aes(npcx = "right", npcy = "bottom", label = session_lab),
                          hjust = .95, vjust = .25, size = 7) +
      geom_point() +
      geom_smooth(method = "lm", formula = y~x, se = F) +
      geom_text_npc(aes(npcx = "left", npcy = "top", label = r_lab), check_overlap = T) +
      scale_x_continuous(expand = expansion(mult = .025)) +
      scale_y_continuous(expand = expansion(mult = .025)) +
      labs(x = "True Person-Level Estimate", y = "Estimated Person-Level Estimate") +
      theme_classic() +
      theme(axis.text = element_blank(),
            axis.title = element_text(size = 16),
            strip.text = element_blank(),
            plot.margin = unit(c(1, .5, .5, .5), units = "cm")) +
      lemon::facet_rep_wrap(session~parameter, scales = "free", ncol = 2)
```


```{r, fig.width=4, fig.height=8.5}
# plot
# grid.newpage()
# pushViewport(viewport(x = .5, y = .5, width = 1, height = 1))
grid.draw(person_level_plot)

# text
grid.text(c(expression(italic(A)), expression(paste("Unbounded ", italic(A)))),
          x = c(.325, .75), y = .98,
          gp = gpar(fontsize = 18))
```


## Growth Parameter Recovery
### LMER Model
```{r, results='asis'}
growth_model = RL_parameters %>% 
  filter(parameter == "theta") %>% 
  lmer(est ~ session + (session|ID),
             data = ., REML = T)
stargazer(growth_model, type = "html", digits = 3)

performance::check_model(growth_model)
```


### Quantitative Comparison
```{r}
data.frame(
  True_Intercept = round(parameters$mu_intercept_UT, 3),
  Estimated_Intercept =
    round(summary(growth_model)$coefficients["(Intercept)", "Estimate"], 3),
  True_Slope = round(parameters$mu_beta_UT, 3),
  Estimated_Slope =
    round(summary(growth_model)$coefficients["session", "Estimate"], 3),
  True_R = round(parameters$int_slope_R, 3),
  Estimated_R =
    round(attr(VarCorr(growth_model)$ID, "correlation")["(Intercept)", "session"], 3)) %>% 
  kable(format = "html", escape = FALSE,
        col.names = c("True Intercept",
                      "Estimate Intercept",
                      "True Slope",
                      "Estimated Slope",
                      "True R",
                      "Estimated R")) %>% 
  kable_styling()
```


### Visual Comparison
```{r, fig.width=5, fig.height=4}
RL_parameters %>% 
  # PREP DATA
  ungroup() %>% filter(parameter == "theta") %>% 
  dplyr::select(ID, session, true, est) %>% 
  pivot_longer(c("true", "est"), values_to = "theta",
               names_to = "type") %>%  
  # PLOT
  ggplot(aes(x = session, y = theta, group = interaction(session, type),
             color = type, fill = type)) +
    # GEOMS
    geom_violin(position = position_dodge(width = .5), trim = F, alpha = .05,
                linewidth = .5, width = 1) +
    geom_point(position = position_dodge(width = .5), alpha = .5) +
    geom_abline(intercept = parameters$mu_intercept_UT, slope = parameters$mu_beta_UT,
                color = "dodgerblue3", size = 1) +
    geom_abline(intercept = summary(growth_model)$coefficients["(Intercept)", "Estimate"],
                slope = summary(growth_model)$coefficients["session", "Estimate"],
                color = "goldenrod3", size = 1) +
    # SCALES
    scale_color_manual(values = c("goldenrod3", "dodgerblue3"), 
                       labels = c("est" = "Estimated", "true" = "True")) +
    scale_fill_manual(values = c("goldenrod3", "dodgerblue3"), 
                      labels = c("est" = "Estimated", "true" = "True")) +
    # THEMES
    labs(x = "Session", y = expression(italic(A))) +
    theme_classic() +
    theme(axis.text = element_text(color = "black", size = 12),
          axis.title = element_text(size = 16),
          legend.text = element_text(size = 12),
          legend.title = element_blank(),
          legend.position = c(.15, .9))
```









