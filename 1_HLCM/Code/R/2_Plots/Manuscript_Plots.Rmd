---
title: "Manuscript Plots"
output: 
  html_document:
    theme: flatly
    toc: yes
    toc_float:
      collapsed: true
---


```{css, echo = F}
#TOC {
    max-width: fit-content;
    white-space: nowrap;
  }
  
  div:has(> #TOC) {
    display: flex;
    flex-direction: row-reverse;
}
div.tocify {
width: 100%;
}
```


# -------------------------------------------
# Setup
## Load Packages
```{r setup, include = F}
knitr::opts_chunk$set(echo = F, warning = F, message = F, fig.align = "center")

library(tidyverse)
library(rstan)
library(hBayesDM)
library(bayesplot)
library(here)
library(miscTools)
library(cmdstanr)
library(stringi)
library(ggpp)
library(lemon)
library(MASS)
library(ggh4x)
library(grid)
library(extraDistr)
library(lme4)
library(kableExtra)
```


## Import Models
```{r}
conditions  = c("neg.beta_neg.cor", "neg.beta_neu.cor", "neg.beta_pos.cor",
                "neu.beta_neg.cor", "neu.beta_neu.cor", "neu.beta_pos.cor",
                "pos.beta_neg.cor", "pos.beta_neu.cor", "pos.beta_pos.cor")
conditions_labs = c("-.3 Beta & -.3 r", "-.3 Beta & 0 r", "-.3 Beta & +.3 r",
                    "0 Beta & -.3 r", "0 Beta & 0 r", "0 Beta & +.3 r",
                    "+.3 Beta & -.3 r", "+.3 Beta & 0 r", "+.3 Beta & +.3 r")
sim_numbers = 1:100

characteristics = data.frame()
diagnostics     = data.frame()
simulations     = data.frame()

for(condition in conditions){
  for(sim in sim_numbers){
    characteristics = bind_rows(characteristics,
                                readRDS(here("1_HLCM", "Data", "2_Fitted", condition,
                                             paste0("RL_Characteristics_", sim, ".RDS"))),
                                readRDS(here("1_HLCM", "Data", "2_Fitted", condition,
                                             paste0("HLCM_Characteristics_", sim, ".RDS"))))
    diagnostics = bind_rows(diagnostics,
                            readRDS(here("1_HLCM", "Data", "2_Fitted", condition,
                                         paste0("RL_Diagnostics_", sim, ".RDS"))),
                            readRDS(here("1_HLCM", "Data", "2_Fitted", condition,
                                         paste0("HLCM_Diagnostics_", sim, ".RDS")))) %>% 
      filter(!str_detect(parameter, "RL1|RL2|RL3"))
    simulations = bind_rows(simulations,
                            readRDS(here("1_HLCM", "Data", "2_Fitted", condition,
                                         paste0("RL_Simulation_", sim, ".RDS"))),
                            readRDS(here("1_HLCM", "Data", "2_Fitted", condition,
                                         paste0("HLCM_Simulation_", sim, ".RDS")))) %>% 
      filter(!str_detect(parameter, "RL1|RL2|RL3"))
  }
}
```


```{r}
characteristics %>%
  group_by(hypermodel) %>% 
  summarise(avg = round(mean(as.numeric(duration, units = "mins")), 2),
            sd = round(sd(as.numeric(duration, units = "mins")), 2))
```


# -------------------------------------------
# Posterior Means
## Group-Level Growth Parameters
### Prep Data
```{r}
group_level_parameters = simulations %>% 
    filter(parameter_type == "group") %>%
    group_by(hypermodel, condition, parameter) %>% 
    mutate(mean_posterior_mean = mean(posterior_mean),
           mean_diff = mean(posterior_mean - true_value)) %>%
    mutate(hypermodel = case_when(hypermodel == "HLCM" ~ "CGM", T ~ hypermodel),
           hypermodel = factor(hypermodel, levels = c("RL", "CGM"),
                               labels = c("Two-Stage", "CGM"), ordered = T),
           parameter = factor(parameter, ordered = T,
                              levels = c("intercept", "slope", "int_slope_R", 
                                         "intercept_SD", "slope_SD", "residual_SD"),
                              labels = c("Intercept~(\u03B3[0])",
                                         "Slope~(\u03B3[1])",
                                         "Int-Slope~Cor~(\u03c1)",
                                         "Intercept~SD~(\u03c3[2][0])", 
                                         "Slope~SD~(\u03c3[2][1])",
                                         "Residual~SD~(\u03c3[1])")),
           condition = factor(
             condition, ordered = T,
             levels = conditions, 
             labels = c(expression(atop("\u03B3"["1"]*"=-.3","\n\u03c1=-.3")),
                        expression(atop("\u03B3"["1"]*"=-.3","\n\u03c1=0")),
                        expression(atop("\u03B3"["1"]*"=-.3","\n\u03c1=+.3")),
                        
                        expression(atop("\u03B3"["1"]*"=0  ","\n\u03c1=-.3")),
                        expression(atop("\u03B3"["1"]*"=0  ","\n\u03c1=0")),
                        expression(atop("\u03B3"["1"]*"=0  ","\n\u03c1=+.3")),
                        
                        expression(atop("\u03B3"["1"]*"=+.3","\n\u03c1=-.3")),
                        expression(atop("\u03B3"["1"]*"=+.3","\n\u03c1=0")),
                        expression(atop("\u03B3"["1"]*"=+.3","\n\u03c1=+.3")))),
           mean_diff_x = case_when(parameter == "Residual~SD~(\u03c3)" ~ .25, T ~ .75),
           mean_diff_y = case_when(hypermodel == "Two-Stage" ~ 1.0, T ~ .95),
           cond_lab = case_when(parameter %in% c("Int-Slope~Cor~(\u03c1)",
                                                 "Residual~SD~(\u03c3[1])") ~ condition))
```


### Group-Level Parameters Plot
```{r, fig.height=16, fig.width=16}
tiff(here("1_HLCM", "Figs_Tables", "1 - Distribution of Group-Level Growth Parameters.tiff"),
     width = 14.6, height = 16, units = "cm", res = 300)

  group_level_parameters %>% 
    mutate(cond_lab = case_when(parameter == "Residual~SD~(\u03c3[1])" ~ condition)) %>% 
    ggplot(aes(x = posterior_mean, fill = hypermodel)) +
      # GEOMS
      geom_histogram(color = "black", linewidth = .25, bins = 25,
                     position = "identity", alpha = .65) +
      geom_hline(yintercept = 0) +
      geom_vline(aes(xintercept = true_value), color = "red2", linewidth = .75) +
      geom_point(aes(x = mean_posterior_mean, y = 30),
                 shape = 21, size = 1.6, stroke = 1, show.legend = F) +
      geom_text_npc(aes(npcx = .95, npcy = .95, label = cond_lab), size = 3,
                    parse = T, hjust = .35, check_overlap = T) +
      # SCALES
      scale_x_continuous(n.breaks = 3) +
      scale_y_continuous(limits = c(0, 30), expand = expansion(mult = c(0, .1)), 
                         breaks = c(0, 15, 30)) +
      scale_color_manual(values = c("goldenrod3", "dodgerblue3")) +
      scale_fill_manual(values = c("goldenrod3", "dodgerblue3")) +
      # THEMES
      labs(x = "Posterior Mean", y = "Frequency") +
      coord_cartesian(clip = "off") +
      theme_classic() +
      theme(axis.text = element_text(color = "black", size = 8),
            axis.ticks = element_line(color = "black", linewidth = .75),
            axis.line = element_line(linewidth = .75),
            axis.title = element_text(size = 12),
            legend.title = element_blank(),
            legend.position = c(.5, 1.075),
            legend.direction = "horizontal",
            plot.margin = unit(c(.75, .5, .1, .15), "cm"),
            panel.spacing.x = unit(.2, "cm"),
            panel.spacing.y = unit(-.1, "cm"),
            strip.text.x = element_text(size = 8, hjust = .25),
            strip.text.y = element_blank(),
            strip.clip = "off",
            strip.background = element_rect(fill = "transparent", colour = "transparent"),
            panel.background = element_rect(fill = "transparent", colour = "transparent"),
            plot.background = element_rect(fill = "transparent", color = "transparent")) +
      facet_rep_grid(condition~parameter, scales = "free_x", labeller = label_parsed) +
      facetted_pos_scales(x = list(
        parameter == "Int-Slope~Cor~(\u03c1)" ~
          scale_x_continuous(limits = c(-1, 1), breaks = c(-1, 0, 1)),
        parameter == "Intercept~SD~(\u03c3[2][0])" ~
          scale_x_continuous(breaks = c(.5, 1, 1.5)),
        parameter == "Residual~SD~(\u03c3[1])" ~
          scale_x_continuous(breaks = c(.5, 1, 1.5))))
  dev.off()
```


### Mean Deviations
```{r}
group_level_parameters %>% 
  mutate(deviation = abs(posterior_mean - true_value),
         order = case_when(parameter == "Intercept~(\u03B3[0])" ~ 1,
                           parameter == "Slope~(\u03B3[1])" ~ 2,
                           parameter == "Intercept~SD~(\u03c3[2][0])" ~ 3, 
                           parameter == "Slope~SD~(\u03c3[2][1])" ~ 4,
                           parameter == "Int-Slope~Cor~(\u03c1)" ~ 5,
                           parameter == "Residual~SD~(\u03c3[1])" ~ 6)) %>% 
  group_by(order, hypermodel, parameter) %>% 
  reframe(mean_deviation = round(mean(deviation), 2),
          sd_deviation   = round(sd(deviation), 2),
          deviation = paste0(mean_deviation, " (", sd_deviation, ")")) %>% 
  dplyr::select(-c(mean_deviation, sd_deviation)) %>% 
  pivot_wider(names_from = "hypermodel", values_from = "deviation") %>% 
  arrange(order) %>% 
  write.csv(here("1_HLCM", "Figs_Tables", "Group-Level Parameter MADs.csv"))


simulations %>% 
  filter(parameter_type != "group") %>% 
  mutate(deviation = abs(posterior_mean - true_value),
         order = case_when(parameter == "intercept" ~ 1,
                           parameter == "slope" ~ 2,
                           parameter == "unbounded_A" ~ 3, 
                           parameter == "A" ~ 4)) %>%
  group_by(order, hypermodel, parameter) %>% 
  reframe(mean_deviation = round(mean(deviation), 2),
          sd_deviation   = round(sd(deviation), 2),
          deviation = paste0(mean_deviation, " (", sd_deviation, ")")) %>% 
  dplyr::select(-c(mean_deviation, sd_deviation)) %>% 
  pivot_wider(names_from = "hypermodel", values_from = "deviation") %>% 
  arrange(order) %>% 
  write.csv(here("1_HLCM", "Figs_Tables", "Person-Level Parameter MADs.csv"))
```


## Person-Level Parameters
### Define Aspects of Plot
```{r}
correlations = simulations %>% 
  filter(parameter_type != "group") %>%
  group_by(simulation, condition, hypermodel, parameter) %>% 
  reframe(r = cor(true_value, posterior_mean)) %>% 
  mutate(hypermodel = case_when(hypermodel == "HLCM" ~ "CGM", T ~ hypermodel),
         hypermodel = factor(hypermodel, levels = c("RL", "CGM"),
                             labels = c("Two-Stage", "CGM"), ordered = T),
         parameter = factor(parameter, ordered = T,
                            levels = c("intercept", "slope", "unbounded_A", "A"),
                            labels = c("Intercept~(\u03B2[0])",
                                       "Slope~(\u03B2[1])",
                                       "Unbounded~A", "A")),
         condition = factor(
           condition, ordered = T,
           levels = conditions, 
           labels = c(expression(atop("\u03B3"["1"]*"=-.3","\n\u03c1=-.3")),
                      expression(atop("\u03B3"["1"]*"=-.3","\n\u03c1=0")),
                      expression(atop("\u03B3"["1"]*"=-.3","\n\u03c1=+.3")),
                      
                      expression(atop("\u03B3"["1"]*"=0  ","\n\u03c1=-.3")),
                      expression(atop("\u03B3"["1"]*"=0  ","\n\u03c1=0")),
                      expression(atop("\u03B3"["1"]*"=0  ","\n\u03c1=+.3")),
                      
                      expression(atop("\u03B3"["1"]*"=+.3","\n\u03c1=-.3")),
                      expression(atop("\u03B3"["1"]*"=+.3","\n\u03c1=0")),
                      expression(atop("\u03B3"["1"]*"=+.3","\n\u03c1=+.3")))),
         cond_lab = case_when(parameter == "A" ~ condition))

mean_correlation = correlations %>% 
  group_by(hypermodel, condition, parameter) %>%
  reframe(mean_r = mean(r)) %>% 
  mutate(hypermodel = case_when(hypermodel == "CGM" ~ "CGM", T ~ "Two_Stage")) %>% 
  pivot_wider(names_from = "hypermodel", values_from = "mean_r")
```


### True v Est Correlation Plot
```{r}
tiff(here("1_HLCM", "Figs_Tables", "2 - Correlation Bw True & Estimated Parameters.tiff"),
     width = 14.6, height = 16, units = "cm", res = 300)

  correlations %>% 
    ggplot(aes(x = r, fill = hypermodel)) +
      # GEOMS
      geom_vline(data = mean_correlation, aes(xintercept = Two_Stage), color = "goldenrod3",
                 show.legend = F) +
      geom_vline(data = mean_correlation, aes(xintercept = CGM), color = "dodgerblue3",
                 show.legend = F) +
      geom_histogram(color = "black", linewidth = .25,
                     position = "identity", alpha = .65) +
      geom_hline(yintercept = 0) +
      geom_text_npc(data = mean_correlation,
                    color = "goldenrod4", size = 3, inherit.aes = F, hjust = 0,
                aes(npcx = "left", npcy = 1, 
                    label = paste0("r = ", round(Two_Stage, 2)))) +
      geom_text_npc(data = mean_correlation, 
                    color = "dodgerblue4", size = 3, inherit.aes = F, hjust = 0,
                aes(npcx = "left", npcy = .65,
                    label = paste0("r = ", round(CGM, 2)))) +
      geom_text_npc(aes(npcx = "right", npcy = 1.1, label = cond_lab),
                    parse = T, hjust = -.1, check_overlap = T) +
      # SCALES
      scale_x_continuous(limits = c(-1,1), expand = expansion(mult = .05),
                         breaks = c(-1, 0, 1), labels = c("-1", "0", "+1")) +
      scale_y_continuous(limits = c(0, NA), n.breaks = 3,
                         expand = expansion(mult = c(0, 0.1))) +
      scale_color_manual(values = c("goldenrod3", "dodgerblue3")) +
      scale_fill_manual(values = c("goldenrod3", "dodgerblue3")) +
      # THEMES
      labs(x = "Correlation Between True & Estimated Parameter", y = "Frequency") +
      coord_cartesian(clip = "off") +
      theme_classic() +
      theme(axis.text = element_text(color = "black", size = 11),
            axis.ticks = element_line(color = "black", linewidth = .75),
            axis.line = element_line(linewidth = .75),
            axis.title = element_text(size = 14),
            legend.title = element_blank(),
            legend.position = c(.5, 1.085),
            legend.direction = "horizontal",
            plot.margin = unit(c(.75, 1.35, .1, .3), "cm"),
            panel.spacing.x = unit(.4, "cm"),
            panel.spacing.y = unit(-.1, "cm"),
            strip.text.x = element_text(size = 12, hjust = 0),
            strip.text.y = element_blank(),
            strip.clip = "off",
            strip.background = element_rect(fill = "transparent", colour = "transparent"),
            panel.background = element_rect(fill = "transparent", colour = "transparent"),
            plot.background = element_rect(fill = "transparent", color = "transparent")) +
      facet_rep_grid(condition~parameter, scales = "free", labeller = label_parsed)
  
dev.off()
```


# -------------------------------------------
# True in HDI
## Group-Level Growth Parameters
```{r}
tiff(here("1_HLCM", "Figs_Tables", "3 - Percent Group-Level Growth Parameters in HDIs.tiff"),
     width = 14.6, height = 12.5, units = "cm", res = 300)

  simulations %>% 
    filter(parameter_type == "group") %>%
    group_by(condition, parameter, hypermodel) %>% 
    summarise(true_in_HDI95 = mean(true_in_HDI95)*100) %>% 
    mutate(hypermodel = case_when(hypermodel == "HLCM" ~ "CGM", T ~ hypermodel),
           hypermodel = factor(hypermodel, levels = c("RL", "CGM"),
                               labels = c("Two-Stage", "CGM"), ordered = T),
           parameter = factor(parameter, ordered = T,
                              levels = c("intercept", "slope", "int_slope_R", 
                                         "intercept_SD", "slope_SD", "residual_SD")),
           gamma10 = factor(
             condition, levels = c("neg.beta_neg.cor", "neg.beta_neu.cor", "neg.beta_pos.cor",
                                   "neu.beta_neg.cor", "neu.beta_neu.cor", "neu.beta_pos.cor",
                                   "pos.beta_neg.cor", "pos.beta_neu.cor", "pos.beta_pos.cor"),
                            labels = c(expression("\u03B3"["1"]*"=-.3"),
                                       expression("\u03B3"["1"]*"=-.3"),
                                       expression("\u03B3"["1"]*"=-.3"),
                                       expression("\u03B3"["1"]*"=0"),
                                       expression("\u03B3"["1"]*"=0"),
                                       expression("\u03B3"["1"]*"=0"),
                                       expression("\u03B3"["1"]*"=+.3"),
                                       expression("\u03B3"["1"]*"=+.3"),
                                       expression("\u03B3"["1"]*"=+.3"))),
           rho = factor(
             condition, levels = c("neg.beta_neg.cor", "neg.beta_neu.cor", "neg.beta_pos.cor",
                                   "neu.beta_neg.cor", "neu.beta_neu.cor", "neu.beta_pos.cor",
                                   "pos.beta_neg.cor", "pos.beta_neu.cor", "pos.beta_pos.cor"),
             labels = c(expression("\u03c1"*"=-.3"), expression("\u03c1"*"=0"),
                        expression("\u03c1"*"=+.3"), expression("\u03c1"*"=-.3"),
                        expression("\u03c1"*"=0"), expression("\u03c1"*"=+.3"),
                        expression("\u03c1"*"=-.3"), expression("\u03c1"*"=0"), expression("\u03c1"*"=+.3")))) %>% 
    ggplot(aes(x = parameter, y = true_in_HDI95, fill = hypermodel)) +
      # GEOMS
      geom_bar(color = "black", linewidth = .75, stat = "identity",
               position = position_dodge(width = .85), width = .75) +
      geom_text(aes(label = paste0(round(true_in_HDI95), "%")),
                vjust = .5, hjust = -.125, size = 2.25,
                angle = 90, position = position_dodge(width = .85)) +
      # SCALES
      scale_x_discrete(
        labels = parse(text = c("Intercept~(\u03B3[0])", "Slope~(\u03B3[1])",
                                "Int-Slope~Cor~(\u03c1)", "Intercept~SD~(\u03c3[2][0])",
                                "Slope~SD~(\u03c3[2][1])", "Residual~SD~(\u03c3[1])"))) +
      scale_y_continuous(limits = c(0,100), expand = c(0,0), 
                         breaks = seq(0, 100, 25), labels = c("0%", "25%", "50%", "75%", "100%")) +
      scale_fill_manual(values = c("goldenrod3", "dodgerblue3")) +
      # THEMES
      labs(y = "95% Coverage") +
      coord_cartesian(clip = "off") +
      theme_classic() +
      theme(axis.text.x = element_text(color = "black", size = 8, angle = 90, vjust = .5, hjust = 1),
            axis.text.y = element_text(color = "black", size = 8),
            axis.ticks = element_line(color = "black", linewidth = .75),
            axis.line = element_line(linewidth = .75),
            axis.title.y = element_text(size = 12),
            axis.title.x = element_blank(),
            legend.position = "top",
            legend.title = element_blank(),
            plot.margin = unit(c(.05,.10, .1, .2), "cm"),
            panel.spacing.x = unit(.25, "cm"),
            panel.spacing.y = unit(-1.5, "cm"),
            strip.text.x = element_text(vjust = 7.25),
            strip.text.y = element_text(angle = 0),
            strip.clip = "off",
            strip.background = element_rect(fill = "transparent", colour = "transparent"),
            panel.background = element_rect(fill = "transparent", colour = "transparent"),
            plot.background = element_rect(fill = "transparent", color = "transparent")) +
      facet_rep_grid(rho~gamma10, labeller = label_parsed)

dev.off()
```

## Person-Level Parameters
```{r}
tiff(here("1_HLCM", "Figs_Tables", "4 - Percent Person-Level Parameters in HDIs.tiff"),
     width = 14.6, height = 12.5, units = "cm", res = 300)

  simulations %>% 
    filter(parameter_type != "group") %>%
    group_by(condition, parameter, hypermodel) %>% 
    summarise(true_in_HDI95 = mean(true_in_HDI95)*100) %>%
    mutate(hypermodel = case_when(hypermodel == "HLCM" ~ "CGM", T ~ hypermodel),
           hypermodel = factor(hypermodel, levels = c("RL", "CGM"),
                               labels = c("Two-Stage", "CGM"), ordered = T),
           parameter = factor(parameter, ordered = T,
                              levels = c("intercept", "slope", "unbounded_A", "A")),
           gamma10 = factor(
             condition, levels = c(
               "neg.beta_neg.cor", "neg.beta_neu.cor", "neg.beta_pos.cor",
               "neu.beta_neg.cor", "neu.beta_neu.cor", "neu.beta_pos.cor",
               "pos.beta_neg.cor", "pos.beta_neu.cor", "pos.beta_pos.cor"),
             labels = c(expression("\u03B3"["1"]*" = -.3"),
                        expression("\u03B3"["1"]*" = -.3"),
                        expression("\u03B3"["1"]*" = -.3"),
                        expression("\u03B3"["1"]*" = 0"),
                        expression("\u03B3"["1"]*" = 0"), 
                        expression("\u03B3"["1"]*" = 0"),
                        expression("\u03B3"["1"]*" = +.3"),
                        expression("\u03B3"["1"]*" = +.3"),
                        expression("\u03B3"["1"]*" = +.3"))),
           rho = factor(
             condition, levels = c(
               "neg.beta_neg.cor", "neg.beta_neu.cor", "neg.beta_pos.cor",
               "neu.beta_neg.cor", "neu.beta_neu.cor", "neu.beta_pos.cor",
               "pos.beta_neg.cor", "pos.beta_neu.cor", "pos.beta_pos.cor"),
             labels = c(expression("\u03c1"*" = -.3"), expression("\u03c1"*" = 0"),
                        expression("\u03c1"*" = +.3"), expression("\u03c1"*" = -.3"),
                        expression("\u03c1"*" = 0"), expression("\u03c1"*" = +.3"),
                        expression("\u03c1"*" = -.3"), expression("\u03c1"*" = 0"),
                        expression("\u03c1"*" = +.3")))
    ) %>% 
    ggplot(aes(x = parameter, y = true_in_HDI95, fill = hypermodel)) +
      # GEOMS
      geom_bar(color = "black", linewidth = .75, stat = "identity",
               position = position_dodge(width = .85), width = .75) +
      geom_text(aes(label = paste0(round(true_in_HDI95), "%")),
                vjust = .5, hjust = -.125, size = 2.25, angle = 90,
                position = position_dodge(width = .85)) +
      # SCALES
      scale_x_discrete(labels = parse(text = c("Intercept~(\u03B2[0])",
                                               "Slope~(\u03B2[1])",
                                               "Unbounded~A", "A"))) +
      scale_y_continuous(limits = c(0,100), expand = c(0,0), 
                         breaks = seq(0, 100, 25), labels = c("0%", "25%", "50%", "75%", "100%")) +
      scale_fill_manual(values = c("goldenrod3", "dodgerblue3")) +
      # THEMES
      labs(y = "95% Coverage") +
      coord_cartesian(clip = "off") +
      theme_classic() +
      theme(axis.text.x = element_text(color = "black", size = 8, angle = 90, vjust = .5, hjust = 1),
            axis.text.y = element_text(color = "black", size = 8),
            axis.ticks = element_line(color = "black", linewidth = .75),
            axis.line = element_line(linewidth = .75),
            axis.title.y = element_text(size = 12),
            axis.title.x = element_blank(),
            legend.position = "top",
            legend.title = element_blank(),
            plot.margin = unit(c(.05,.10, .1, .2), "cm"),
            panel.spacing.x = unit(.25, "cm"),
            panel.spacing.y = unit(-1, "cm"),
            strip.text.x = element_text(vjust = 7.25),
            strip.text.y = element_text(angle = 0),
            strip.clip = "off",
            strip.background = element_rect(fill = "transparent", colour = "transparent"),
            panel.background = element_rect(fill = "transparent", colour = "transparent"),
            plot.background = element_rect(fill = "transparent", color = "transparent")) +
      facet_rep_grid(rho~gamma10, labeller = label_parsed)

dev.off()
```


## MAD
```{r}
simulations %>% 
  mutate(parameter_type =
           case_when(str_detect(parameter_type, "person") ~ "person", T ~ "group")) %>% 
  group_by(hypermodel, model, condition, parameter_type, parameter) %>% 
  reframe(coverage = mean(true_in_HDI95)*100) %>% 
  mutate(abs_dev = abs(coverage - 95)) %>% 
  group_by(hypermodel, model, parameter_type, parameter) %>% 
  reframe(MAD = round(mean(abs_dev), 2)) %>% 
  pivot_wider(names_from = "hypermodel", values_from = "MAD") %>% 
  mutate(model_order = case_when(parameter_type == "group" ~ 1, T ~ 2),
         parameter_order = case_when(parameter == "intercept" ~ 1,
                                     parameter == "slope" ~ 2,
                                     parameter == "intercept_SD" ~ 3,
                                     parameter == "slope_SD" ~ 4,
                                     parameter == "int_slope_R" ~ 5,
                                     parameter == "residual_SD" ~ 6,
                                     parameter == "unbounded_A" ~ 7,
                                     T ~ 8)) %>% 
  arrange(model_order, parameter_order) %>% 
  write.csv(here("1_HLCM", "Figs_Tables", "Coverage_MADs.csv"))
```


# -------------------------------------------
# Percentiles
## Two-Stage Group-Level Growth Parameters
```{r}
tiff(here("1_HLCM", "Figs_Tables",
          "S1 - Group-Level Growth Parameter Percentiles.tiff"),
     width = 14.6, height = 16, units = "cm", res = 300)

  group_level_parameters %>% 
    mutate(parameter_lab = case_when(condition ==
                                       expression(atop("\u03B3"["1"]*"=-.3","\n\u03c1=-.3")) ~
                                       parameter),
           cond_lab = case_when(parameter == "Residual~SD~(\u03c3[1])" ~ condition)) %>% 
    filter(hypermodel == "Two-Stage") %>%
    ggplot(aes(x = percentile, fill = hypermodel)) +
      # GEOMS
      geom_histogram(color = "black", linewidth = .25, bins = 25,
                     position = "identity", alpha = .5, fill = "goldenrod3") +
      geom_hline(yintercept = 0) +
      # SCALES
      scale_x_continuous(limits = c(-.1, 1.1), breaks = seq(0, 1, .5),
                         labels = c("0", ".5", "1")) +
      scale_y_continuous(expand = expansion(mult = c(0, .2)),
                         n.breaks = 3) +
      # THEMES
      labs(x = "Percentile", y = "Frequency") +
      coord_cartesian(clip = "off") +
      theme_classic() +
      theme(axis.text = element_text(color = "black", size = 9),
            axis.ticks = element_line(color = "black", linewidth = .75),
            axis.line = element_line(linewidth = .75),
            axis.title = element_text(size = 12),
            legend.title = element_blank(),
            legend.position = c(.5, 1.065),
            legend.direction = "horizontal",
            plot.margin = unit(c(1, 1.5, .1, .15), "cm"),
            panel.spacing.x = unit(.25, "cm"),
            panel.spacing.y = unit(.15, "cm"),
            strip.text.x = element_blank(),
            strip.text.y = element_blank(),
            strip.clip = "off",
            strip.background = element_rect(fill = "transparent", colour = "transparent"),
            panel.background = element_rect(fill = "transparent", colour = "transparent"),
            plot.background = element_rect(fill = "transparent", color = "transparent")) +
      facet_rep_wrap(condition~parameter, scales = "free",
                     labeller = label_parsed, ncol = 6)
  
dev.off()
```


## CGM Group-Level Growth Parameters
```{r}
tiff(here("1_HLCM", "Figs_Tables",
          "S2 - Group-Level Growth Parameter Percentiles.tiff"),
     width = 14.6, height = 16, units = "cm", res = 300)

  group_level_parameters %>% 
    mutate(parameter_lab = case_when(condition ==
                                       expression(atop("\u03B3"["1"]*"=-.3","\n\u03c1=-.3")) ~
                                       parameter),
           cond_lab = case_when(parameter == "Residual~SD~(\u03c3[1])" ~ condition)) %>% 
    filter(hypermodel == "CGM") %>% 
    ggplot(aes(x = percentile, fill = hypermodel)) +
      # GEOMS
      geom_histogram(color = "black", linewidth = .25, bins = 25,
                     position = "identity", alpha = .5, fill = "dodgerblue3") +
      geom_hline(yintercept = 0) +
      # SCALES
      scale_x_continuous(limits = c(-.1, 1.1), breaks = seq(0, 1, .5),
                         labels = c("0", ".5", "1")) +
      scale_y_continuous(expand = expansion(mult = c(0, .2)),
                         n.breaks = 3) +
      # THEMES
      labs(x = "Percentile", y = "Frequency") +
      coord_cartesian(clip = "off") +
      theme_classic() +
      theme(axis.text = element_text(color = "black", size = 9),
            axis.ticks = element_line(color = "black", linewidth = .75),
            axis.line = element_line(linewidth = .75),
            axis.title = element_text(size = 12),
            legend.title = element_blank(),
            legend.position = c(.5, 1.065),
            legend.direction = "horizontal",
            plot.margin = unit(c(1, 1.5, .1, .15), "cm"),
            panel.spacing.x = unit(.25, "cm"),
            panel.spacing.y = unit(.15, "cm"),
            strip.text.x = element_blank(),
            strip.text.y = element_blank(),
            strip.clip = "off",
            strip.background = element_rect(fill = "transparent", colour = "transparent"),
            panel.background = element_rect(fill = "transparent", colour = "transparent"),
            plot.background = element_rect(fill = "transparent", color = "transparent")) +
      facet_rep_wrap(condition~parameter, scales = "free",
                     labeller = label_parsed, ncol = 6)
  
dev.off()
```


## Two-Stage Person-Level Growth Parameters
```{r}
tiff(here("1_HLCM", "Figs_Tables",
          "S3 - Person-Level Growth Parameter Percentiles.tiff"),
     width = 14.6, height = 16, units = "cm", res = 300)

  simulations %>% 
    filter(parameter_type != "group") %>%
    mutate(hypermodel = factor(hypermodel, levels = c("RL", "HLCM"),
                               labels = c("Two-Stage", "HLCM"), ordered = T),
           parameter = factor(parameter, ordered = T,
                              levels = c("intercept", "slope", "unbounded_A", "A"),
                              labels = c("Intercept~(\u03B2[0])",
                                         "Slope~(\u03B2[1])", "Unbounded~A", "A")),
           condition = factor(condition, ordered = T,
                              levels = conditions, 
                              labels = c(expression(atop("\u03B3"["1"]*"=-.3","\n\u03c1=-.3")),
                                         expression(atop("\u03B3"["1"]*"=-.3","\n\u03c1=0")),
                                         expression(atop("\u03B3"["1"]*"=-.3","\n\u03c1=+.3")),
                                         
                                         expression(atop("\u03B3"["1"]*"=0  ","\n\u03c1=-.3")),
                                         expression(atop("\u03B3"["1"]*"=0  ","\n\u03c1=0")),
                                         expression(atop("\u03B3"["1"]*"=0  ","\n\u03c1=+.3")),
                                         
                                         expression(atop("\u03B3"["1"]*"=+.3","\n\u03c1=-.3")),
                                         expression(atop("\u03B3"["1"]*"=+.3","\n\u03c1=0")),
                                         expression(atop("\u03B3"["1"]*"=+.3","\n\u03c1=+.3"))
                              )),
           cond_lab = case_when(parameter == "A" ~ condition)) %>% 
    filter(hypermodel == "Two-Stage") %>% 
    ggplot(aes(x = percentile, fill = hypermodel)) +
      # GEOMS
      geom_histogram(aes(y = ..count../1000),
                     color = "black", linewidth = .25, fill = "goldenrod3",
                     bins = 25, position = "identity", alpha = .5) +
      geom_hline(yintercept = 0) +
      # SCALES
      scale_x_continuous(breaks = seq(0, 1, .5), labels = c("0", ".5", "1")) +
      scale_y_continuous(expand = expansion(mult = c(0, .2)),
                         n.breaks = 3) +
      # THEMES
      labs(x = "Percentile", y = "Frequency (in Thousands)") +
      coord_cartesian(clip = "off") +
      theme_classic() +
      theme(axis.text = element_text(color = "black", size = 9),
            axis.ticks = element_line(color = "black", linewidth = .75),
            axis.line = element_line(linewidth = .75),
            axis.title = element_text(size = 12),
            legend.title = element_blank(),
            legend.position = c(.5, 1.065),
            legend.direction = "horizontal",
            plot.margin = unit(c(1, 1.5, .1, .15), "cm"),
            panel.spacing.x = unit(.25, "cm"),
            panel.spacing.y = unit(.15, "cm"),
            strip.text.x = element_blank(),
            strip.text.y = element_blank(),
            strip.clip = "off",
            strip.background = element_rect(fill = "transparent", colour = "transparent"),
            panel.background = element_rect(fill = "transparent", colour = "transparent"),
            plot.background = element_rect(fill = "transparent", color = "transparent")) +
      facet_rep_wrap(condition~parameter, ncol = 4,
                     scales = "free", labeller = label_parsed)
  
dev.off()
```


## CGM Person-Level Growth Parameters
```{r}
tiff(here("1_HLCM", "Figs_Tables",
          "S4 - Person-Level Growth Parameter Percentiles.tiff"),
     width = 14.6, height = 16, units = "cm", res = 300)

  simulations %>% 
    filter(parameter_type != "group") %>%
    mutate(hypermodel = factor(hypermodel, levels = c("RL", "HLCM"),
                               labels = c("Two-Stage", "HLCM"), ordered = T),
           parameter = factor(parameter, ordered = T,
                              levels = c("intercept", "slope", "unbounded_A", "A"),
                              labels = c("Intercept~(\u03B2[0])",
                                         "Slope~(\u03B2[1])", "Unbounded~A", "A")),
           condition = factor(condition, ordered = T,
                              levels = conditions, 
                              labels = c(expression(atop("\u03B3"["1"]*"=-.3","\n\u03c1=-.3")),
                                         expression(atop("\u03B3"["1"]*"=-.3","\n\u03c1=0")),
                                         expression(atop("\u03B3"["1"]*"=-.3","\n\u03c1=+.3")),
                                         
                                         expression(atop("\u03B3"["1"]*"=0  ","\n\u03c1=-.3")),
                                         expression(atop("\u03B3"["1"]*"=0  ","\n\u03c1=0")),
                                         expression(atop("\u03B3"["1"]*"=0  ","\n\u03c1=+.3")),
                                         
                                         expression(atop("\u03B3"["1"]*"=+.3","\n\u03c1=-.3")),
                                         expression(atop("\u03B3"["1"]*"=+.3","\n\u03c1=0")),
                                         expression(atop("\u03B3"["1"]*"=+.3","\n\u03c1=+.3"))
                              )),
           cond_lab = case_when(parameter == "A" ~ condition)) %>% 
    filter(hypermodel == "HLCM") %>% 
    ggplot(aes(x = percentile, fill = hypermodel)) +
      # GEOMS
      geom_histogram(aes(y = ..count../1000),
                     color = "black", linewidth = .25, fill = "dodgerblue3",
                     bins = 25, position = "identity", alpha = .5) +
      geom_hline(yintercept = 0) +
      # SCALES
      scale_x_continuous(breaks = seq(0, 1, .5), labels = c("0", ".5", "1")) +
      scale_y_continuous(expand = expansion(mult = c(0, .2)),
                         n.breaks = 3) +
      # THEMES
      labs(x = "Percentile", y = "Frequency (in Thousands)") +
      coord_cartesian(clip = "off") +
      theme_classic() +
      theme(axis.text = element_text(color = "black", size = 9),
            axis.ticks = element_line(color = "black", linewidth = .75),
            axis.line = element_line(linewidth = .75),
            axis.title = element_text(size = 12),
            legend.title = element_blank(),
            legend.position = c(.5, 1.065),
            legend.direction = "horizontal",
            plot.margin = unit(c(1, 1.5, .1, .15), "cm"),
            panel.spacing.x = unit(.25, "cm"),
            panel.spacing.y = unit(.15, "cm"),
            strip.text.x = element_blank(),
            strip.text.y = element_blank(),
            strip.clip = "off",
            strip.background = element_rect(fill = "transparent", colour = "transparent"),
            panel.background = element_rect(fill = "transparent", colour = "transparent"),
            plot.background = element_rect(fill = "transparent", color = "transparent")) +
      facet_rep_wrap(condition~parameter, ncol = 4,
                     scales = "free", labeller = label_parsed)
  
dev.off()
```


# -------------------------------------------
# TADS Good/Bad Play Proportions
```{r}
TADS_data = left_join(
  dplyr::select(readRDS(here("1_HLCM", "Data", "0_Raw_TADS", "TADS_SCID.RDS")),
                -session),
  readRDS(here("1_HLCM", "Data", "0_Raw_TADS", "TADS_12345_IGT.RDS"))
  ) %>% 
  right_join(readRDS(here("1_TADS_Parents_PP", "Data", "0_Raw", 
                                 "processed_demographics_data.RDS")))

tiff(here("1_HLCM", "Figs_Tables", "S5 - TADS Good Bad Play Proportions.tiff"),
     width = 10, height = 8, units = "cm", res = 300)
  TADS_data %>% 
    mutate(good_card = case_when(good_card == 1 ~ "Good", T ~ "Bad"),
           good_card = factor(good_card, levels = c("Good" ,"Bad"),
                              ordered = T)) %>% 
    group_by(participant0ID, session, good_card) %>% 
    reframe(play = mean(play, na.rm = T)) %>% 
    group_by(session, good_card) %>% 
    mutate(play_avg = mean(play, na.rm = T),
           play_sd = sd(play, na.rm = T),
           play_lower = case_when(play_avg - play_sd < 0 ~ 0,
                                  T ~ play_avg - play_sd),
           play_upper = case_when(play_avg + play_sd > 1 ~ 1,
                                  T ~ play_avg + play_sd)) %>% 
    filter(!is.na(session)) %>% 
    ggplot(aes(x = session, y = play, group = session)) +
    geom_point(position = position_jitter(width = .25),
               alpha = .2, size = .75) +
    geom_boxplot(color = "dodgerblue3", fill = "transparent",
                 linewidth = .75, outliers = F) +
    labs(x = "Session", y = "Play Proportion") +
    theme_classic() +
    theme(axis.text = element_text(color = "black", size = 10),
          axis.title = element_text(size = 12),
          legend.title = element_blank(),
          legend.position = c(.5, 1.065),
          legend.direction = "horizontal",
          plot.margin = unit(c(.1, 1.1, .1, .15), "cm"),
          panel.spacing.x = unit(.25, "cm"),
          panel.spacing.y = unit(-.1, "cm"),
          strip.text.x = element_text(size = 10),
          strip.text.y = element_blank(),
          strip.clip = "off",
          strip.background = element_rect(fill = "transparent", colour = "transparent"),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent")) +
    facet_rep_wrap(good_card~., nrow = 2)
dev.off()
```


# -------------------------------------------
# Summary Stats
```{r}
diagnostics %>% 
  filter(parameter != "Intercept") %>% 
  mutate(parameter_type = case_when(parameter %in% c("gamma00", "gamma10", "sigma_U[1]",
                                                     "sigma_U[2]", "R_theta[2,1]", "sigma_resid") ~ "group",
                                    T ~ "person"),
         new_parameter = case_when(str_detect(parameter, "beta0") ~ "beta0",
                                   str_detect(parameter, "beta1") ~ "beta1",
                                   str_detect(parameter, "theta") ~ "theta",
                                   str_detect(parameter, "A") ~ "A",
                                   T ~ parameter)) %>% 
  group_by(hypermodel, new_parameter) %>% 
  reframe(percent_under_1.1 = mean(rhat<1.1),
          m_rhat = mean(rhat),
          sd_rhat = sd(rhat)) %>%
  group_by(hypermodel) %>% 
  reframe(min(percent_under_1.1)) %>% View()

characteristics %>% 
  group_by(hypermodel) %>% 
  reframe(m_duration = mean(duration),
          sd_duration = sd(duration))
```


# -------------------------------------------








