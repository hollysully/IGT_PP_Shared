---
title: "IGT Preprocessing"
output: html_document
author: "Jeremy Haynes"
---



# --------------------------------------
# Setup
## Load Packages
```{r}
library(tidyverse)
library(rprime)
library(car)
library(dplyr)
library(here)
```



## Load Data
```{r}
T1_IGT_child = readRDS(here("1_TADS_Raw_Data", "T1_IGT_child.RDS"))
T1_IGT_dad = readRDS(here("1_TADS_Raw_Data", "T1_IGT_dad.RDS"))
T1_IGT_mom = readRDS(here("1_TADS_Raw_Data", "T1_IGT_mom.RDS"))


T2_IGT_child = readRDS(here("1_TADS_Raw_Data", "T2_IGT_child.RDS"))
T2_IGT_dad = readRDS(here("1_TADS_Raw_Data", "T2_IGT_dad.RDS"))
T2_IGT_mom = readRDS(here("1_TADS_Raw_Data", "T2_IGT_mom.RDS"))


T3_IGT_child = readRDS(here("1_TADS_Raw_Data", "T3_IGT_child.RDS"))
T3_IGT_dad = readRDS(here("1_TADS_Raw_Data", "T3_IGT_dad.RDS"))
T3_IGT_mom = readRDS(here("1_TADS_Raw_Data", "T3_IGT_mom.RDS"))


T4_IGT_child = readRDS(here("1_TADS_Raw_Data", "T4_IGT_child.RDS"))
T4_IGT_dad = readRDS(here("1_TADS_Raw_Data", "T4_IGT_dad.RDS"))
T4_IGT_mom = readRDS(here("1_TADS_Raw_Data", "T4_IGT_mom.RDS"))


T5_IGT_child = readRDS(here("1_TADS_Raw_Data", "T5_IGT_child.RDS"))
T5_IGT_dad = readRDS(here("1_TADS_Raw_Data", "T5_IGT_dad.RDS"))
T5_IGT_mom = readRDS(here("1_TADS_Raw_Data", "T5_IGT_mom.RDS"))


full = readRDS(here("1_TADS_Raw_Data", "full_IGT.RDS"))

SCID = readRDS(here("1_TADS_Parents_PP", "Drugs", "processed_SCID_data.RDS"))
```



```{r}
full %>%
  group_by(time, id, participant) %>% 
  reframe(fix = 1) %>% 
  group_by(time, participant) %>% 
  reframe(`sample size` = sum(fix))
```



# --------------------------------------
# Prep Data
```{r}
IGT_prepped = bind_rows(T1_IGT_dad, T1_IGT_mom,
                        T2_IGT_dad, T2_IGT_mom) %>% 
  select(ID = id, -date, everything())

SCID_prepped = SCID %>%
  mutate(participant = tolower(participant)) %>% 
  select(-date)

combined_data = inner_join(IGT_prepped, SCID_prepped) %>% 
  filter(ID >= 5000 & ID < 6000)
```



# --------------------------------------
# Make Stan Data
## Function
```{r}
# Notes: This creates a stan data list for fitting a mean-based covariate model. That is, a model in which parameters are estimated for each session instead of estimating a difference score between, for example, session 1 to session 2. In addition, the format of the covariates needs to be specified before sending it in with the data
make_stan = function(data, covariate_names){
  library(dplyr)
  library(stringr)
  
  
  ##################################################################
  # prep data
  data = data %>%
    mutate(# create variable that assigns numbers to participant types (1 = child, 2 = mom, 3 = dad)
           participant_num = match(participant, c("child", "mom", "dad")[1:3]),
           # create variable that assigns numbers to card types (1 = A, 2 = B, 3 = C, 4 = D)
           card_num = match(str_remove(AB_card, "AB_"), LETTERS[1:4])) %>% 
    # create new ID variable for consecutive IDs (this is just the "id" variable but with consecutive numbers) 
    group_by(ID) %>% mutate(ID_num = cur_group_id()) %>% 
    # create unique ID for individual participants - this helps make sure that
      # we have a unique ID for moms & dads ("participant" variable) with the
      # same kid ("id" variable)
    group_by(ID, participant) %>% mutate(ID_part = cur_group_id())
  
  ##################################################################
  # setup stan variables
  ID_participant = unique(data$ID_part) # vector of unique ID 
  N = length(ID_participant)            # number of unique IDs
  sessions = unique(data$time)          # vector of unique sessions
  S = length(sessions)                  # number of unique sessions
  C = length(covariate_names)           # number of covariates
  D = S + C                             # number of covariates (including sessions)
  Tr = max(data$trial)                  # max number of trials across participants
  

  ID_OG = rep(-1, N)                            # original ID
  ID_number = rep(-1, N)                        # ID number - this links parents of the same 
                                                  # child together in the same way as ID_OG
  participant_number = rep(-1, N)               # child (1), mom (2), or dad (3)
  Tsubj = array(data = 0, dim = c(N,S))         # number of trials by participant
  card = array(data = -1, dim = c(N,Tr,S))      # cards
  choice = array(data = -1, dim = c(N,Tr,S))    # choices made by participant
  outcome = array(data = -999, dim = c(N,Tr,S)) # outcome of choice
  sign = array(data = -999, dim = c(N,Tr,S))    # sign of choice outcome
  X = array(data = 0, dim = c(N,D,S))           # covariates for participants
  pbx = "good to go"                            # indicator for problem in loop
  
  
  ##################################################################
  # fill vectors and arrays with data
  for(i in 1:N){ # loop through persons
    cur_i = filter(data, ID_part == ID_participant[i]) # subset individual
    
    # assign original ID & double-check it gives whole number (it should)
    ID_OG[i] = mean(cur_i$ID)
    pbx = ifelse(ID_OG[i]%%1>0, "problem in OG ID", pbx)
    
    # assign ID number that ties parents together & double-check it gives whole number (it should)
    ID_number[i] = mean(cur_i$ID_num)
    pbx = ifelse(ID_OG[i]%%1>0, "problem in OG ID", pbx)
    
    # assign participant type & double-check it gives whole number (it should)
    participant_number[i] = mean(cur_i$participant_num)
    pbx = ifelse(participant_number[i]%%1>0, "problem in participant number", pbx)
    
    for(s in 1:S){ # loop through sessions
      cur_is = filter(cur_i, time == sessions[s]) # subset session within individual
      
      if(nrow(cur_is) > 0 & max(cur_is$trial) == 120){ # check if participant has a full session's
                                                         # worth of data - if not, skip next loop
        
        # assign covariate variables
        X[i,s,s] = 1 # assign a 1 for current session
        if(C>0){
          for(c in 1:C){
            X[i,s+c,s] = mean(cur_is[[covariate_names[c]]])
            pbx = ifelse(X[i,s+c,s]%%1>0, "problem in covariate", pbx)
          }
        }
        
        Tsubj[i,s] = max(cur_is$trial)
        
        for(t in 1:Tsubj[i,s]){ # loop through trials
          cur_ist = filter(cur_is, trial == t) # subset trial within session within individual
          
          # assign card number
          card[i,t,s] = cur_ist$card_num
          
          # assign choice
          choice[i,t,s] = ifelse(cur_ist$card_play == 0, 2, cur_ist$card_play)
          
          # assign outcome
          outcome[i,t,s] = ifelse(is.na(cur_ist$outcome), 0, cur_ist$outcome / 100)
          
          # assign sign of outcome
          sign[i,t,s] = sign(outcome[i,t,s])
        }
      }
    }
  }
  
  stan_data = list(ID_participant = ID_participant,
                   ID_OG = ID_OG,
                   ID_number = ID_number,
                   participant_number = participant_number,
                   N = N,
                   S = S,
                   T = Tr,
                   card = card,
                   Tsubj = Tsubj,
                   choice = choice,
                   outcome = outcome,
                   sign = sign,
                   D = D,
                   X = X)
  
  return(stan_data)
}
```



## Make Parent Data
```{r}
parent_stan = make_stan(data = bind_rows(combined_data),
                        covariate_names = c("SU"))

sample = "T1_parent_SU_Dep_Anx"

saveRDS(parent_stan, here("1_TADS_Parents_PP", "Data", "1_Stan", 
                          paste("design", sample, "IGT.RDS", sep = "_")))
```



```{r, eval = F}
for(i in names(parent_stan)){
  View(data.frame(parent_stan[[i]]), title = i)
}
```



## Make Combined Data
```{r, eval = F}
full_stan = make_stan(full)
saveRDS(full_stan, here("1_TADS_Parents_PP", "Data", "1_Stan", "full_IGT.RDS"))
```



# --------------------------------------
```{r}

```






























