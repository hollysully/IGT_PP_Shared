---
title: "Manuscript Plots"
output: html_document
date: "2023-03-09"
---



# ---------------------------------------
# Setup
## Loading Packages
```{r include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rstan)
library(hBayesDM)
library(bayesplot)
library(foreach)
library(tidybayes)
library(patchwork)
library(abind)
library(zoo)
library(here)
library(ggpubr)
library(egg)
library(grid)
library(tidyverse)
library(lemon)
library(ggpp)
library(wBoot)
library(stringi)
library(ggh4x)
library(hBayesDM)
source(here("1_IGT_PP", "Code", "R", "3_other", "helpful_functions.R"))
```



## Load Binomial Data
```{r include=FALSE}
sample = "T1_parent_SU_Dep_Anx"

combined_data = readRDS(here("1_TADS_Parents_PP", "Data", "0_Raw", 
                             paste(sample, "IGT.RDS", sep = "_")))
```


```{r}
names(combined_data)
```

# ---------------------------------------
# Cumulative Choice Plots
```{r}
combined_data %>% 
  select(group = anxiety, everything()) %>% 
  group_by(ID, participant, AB_card) %>% 
  mutate(trial = rank(trial)) %>% 
  mutate(outcome = case_when(is.na(outcome) ~ 0, T ~ outcome),
         good_bad = case_when(card_play == 1 & AB_card %in% c("AB_A", "AB_B") ~ -1,
                              card_play == 1 & AB_card %in% c("AB_C", "AB_D") ~ 1,
                              T ~ 0)) %>% 
  
  # ------------------------------------------------------------------------------
  # LOOKING AT INCOME
  # group_by(ID, participant, group) %>% 
  # reframe(income = sum(outcome)) %>%
  # group_by(group) %>%
  # reframe(`Average Income` = mean(income))
  
  # ------------------------------------------------------------------------------
  # LOOKING AT TOTAL GOOD - BAD
  # group_by(ID, participant, group) %>%
  # reframe(good_bad = sum(good_bad)) %>%
  # group_by(group) %>% 
  # reframe(`Average Good - Bad` = mean(good_bad))
  
  # ------------------------------------------------------------------------------
  # LOOKING AT CUMULATIVE GOOD - BAD
  # group_by(ID, participant, group) %>%
  # arrange(trial) %>% 
  # reframe(good_bad = cumsum(good_bad),
  #         trial = trial) %>%
  # group_by(group, trial) %>% 
  # reframe(`Average Good - Bad` = mean(good_bad)) %>% 
  # ggplot(aes(x = trial, y = `Average Good - Bad`, color = factor(group))) +
  #   geom_line() +
  #   theme_classic()
  
  # ------------------------------------------------------------------------------
  # LOOKING AT CUMULATIVE PLAYS FOR EACH DECK
  group_by(ID, participant, group, AB_card) %>%
  arrange(trial) %>% 
  reframe(card_play = cumsum(card_play),
          trial = trial) %>%
  group_by(group, AB_card, trial) %>% 
  reframe(card_play = mean(card_play)) %>% 
  ggplot(aes(x = trial, y = card_play, color = factor(AB_card))) +
    geom_line() +
    theme_classic()+
    facet_rep_wrap(group~.)
```

```{r}
combined_data %>% 
  select(group = depression, everything()) %>% 
  group_by(ID, participant, AB_card) %>% 
  mutate(trial = rank(trial)) %>% 
  mutate(outcome = case_when(is.na(outcome) ~ 0, T ~ outcome),
         good_bad = case_when(card_play == 1 & AB_card %in% c("AB_A", "AB_B") ~ -1,
                              card_play == 1 & AB_card %in% c("AB_C", "AB_D") ~ 1,
                              T ~ 0),
         freq_play = case_when(card_play == 1 & AB_card %in% c("AB_B", "AB_D") ~ 1,
                               T ~ 0),
         nonfreq_play = case_when(card_play == 1 & AB_card %in% c("AB_B", "AB_D") ~ 0,
                                  T ~ 1)) %>% 
  
  # ------------------------------------------------------------------------------
  # LOOKING AT INCOME
  # group_by(ID, participant, group) %>% 
  # reframe(income = sum(outcome)) %>%
  # group_by(group) %>%
  # reframe(`Average Income` = mean(income))
  
  # ------------------------------------------------------------------------------
  # LOOKING AT TOTAL GOOD - BAD
  # group_by(ID, participant, group) %>%
  # reframe(good_bad = sum(good_bad)) %>%
  # group_by(group) %>% 
  # reframe(`Average Good - Bad` = mean(good_bad))
  
  # ------------------------------------------------------------------------------
  # LOOKING AT CUMULATIVE GOOD - BAD
  # group_by(ID, participant, group) %>%
  # arrange(trial) %>% 
  # reframe(good_bad = cumsum(good_bad),
  #         trial = trial) %>%
  # group_by(group, trial) %>% 
  # reframe(`Average Good - Bad` = mean(good_bad)) %>% 
  # ggplot(aes(x = trial, y = `Average Good - Bad`, color = factor(group))) +
  #   geom_line() +
  #   theme_classic()
  
  # ------------------------------------------------------------------------------
  # LOOKING AT CUMULATIVE PLAYS FOR EACH DECK
  # group_by(ID, participant, group, AB_card) %>%
  # arrange(trial) %>% 
  # reframe(card_play = cumsum(card_play),
  #         trial = trial) %>%
  # group_by(group, AB_card, trial) %>% 
  
  # ------------------------------------------------------------------------------
  # LOOKING AT CUMULATIVE PLAYS FOR HI VS LOW FREQ BETWEEN-GROUPS
  group_by(ID, participant, group) %>%
  arrange(trial) %>%
  reframe(freq_play = cumsum(freq_play),
          nonfreq_play = cumsum(nonfreq_play),
          trial = trial) %>%
  group_by(group, trial) %>%
  reframe(play_freq = median(freq_play),
          play_nonfreq = median(nonfreq_play)) %>% 
  pivot_longer(c("play_freq", "play_nonfreq"), names_to = "type", values_to = "plays",
               names_prefix = "play_") %>% 
  
  ggplot(aes(x = trial, y = plays, color = factor(group))) +
    geom_line() +
    theme_classic()+
    facet_rep_wrap(type~.)
```


```{r}
combined_data %>% 
  select(group = depression, everything()) %>% 
  mutate(freq_play = case_when(card_play == 1 & AB_card %in% c("AB_B", "AB_D") ~ 1,
                               card_play == 0 & AB_card %in% c("AB_B", "AB_D") ~ 0)) %>% 
  group_by(trial, group) %>% 
  reframe(prop_freq = mean(freq_play, na.rm = T)) %>% 
  ungroup() %>% group_by(group) %>% 
  mutate(prop_freq = rollapply(prop_freq, width = 30, FUN = mean,
                                 na.rm = TRUE, fill = NA, partial = T)) %>% 
  
  ggplot(aes(x = trial, y = prop_freq, color = factor(group))) + 
    geom_point() +
    scale_y_continuous(limits = c(0, 1)) +
    # stat_summary(fun.y=mean, geom="point", shape=18,
    #              size=3, color="red") +
    theme_classic()

```


```{r}

combined_data %>% 
  select(group = SU, everything()) %>% 
  group_by(ID, participant, AB_card) %>% 
  mutate(trial = rank(trial)) %>% 
  mutate(outcome = case_when(is.na(outcome) ~ 0, T ~ outcome),
         good_bad = case_when(card_play == 1 & AB_card %in% c("AB_A", "AB_B") ~ -1,
                              card_play == 1 & AB_card %in% c("AB_C", "AB_D") ~ 1,
                              T ~ 0)) %>% 
  
  # ------------------------------------------------------------------------------
  # LOOKING AT INCOME
  # group_by(ID, participant, group) %>% 
  # reframe(income = sum(outcome)) %>%
  # group_by(group) %>%
  # reframe(`Average Income` = mean(income))
  
  # ------------------------------------------------------------------------------
  # LOOKING AT TOTAL GOOD - BAD
  # group_by(ID, participant, group) %>%
  # reframe(good_bad = sum(good_bad)) %>%
  # group_by(group) %>% 
  # reframe(`Average Good - Bad` = mean(good_bad))
  
  # ------------------------------------------------------------------------------
  # LOOKING AT CUMULATIVE GOOD - BAD
  # group_by(ID, participant, group) %>%
  # arrange(trial) %>% 
  # reframe(good_bad = cumsum(good_bad),
  #         trial = trial) %>%
  # group_by(group, trial) %>% 
  # reframe(`Average Good - Bad` = mean(good_bad)) %>% 
  # ggplot(aes(x = trial, y = `Average Good - Bad`, color = factor(group))) +
  #   geom_line() +
  #   theme_classic()
  
  # ------------------------------------------------------------------------------
  # LOOKING AT CUMULATIVE PLAYS FOR EACH DECK
  group_by(ID, participant, group, AB_card) %>%
  arrange(trial) %>% 
  reframe(card_play = cumsum(card_play),
          trial = trial) %>%
  group_by(group, AB_card, trial) %>% 
  reframe(card_play = mean(card_play)) %>% 
  ggplot(aes(x = trial, y = card_play, color = factor(AB_card))) +
    geom_line() +
    theme_classic()+
    facet_rep_wrap(group~.)
```



# ---------------------------------------
# Deck Binomial Model Plots
## Import Relevant Data
```{r}
model_name = "Covariate_Deck_Binomial"
deck_binomial_fit = readRDS(here("1_TADS_Parents_PP", "Data", "2_Fitted",
                                 model_name,
                                 paste(sample, model_name, "fit.rds", sep = "_")))

# -----------------------------------------------------------------------------------
# save posteriors
deck_binomial_posteriors = readRDS(here("1_TADS_Parents_PP", "Data", "2_Fitted",
                                        model_name,
                                        paste(sample, model_name, "posteriors.rds", sep = "_")))

# -----------------------------------------------------------------------------------
# save rhats
deck_binomial_rhats = readRDS(here("1_TADS_Parents_PP", "Data", "2_Fitted",
                                   model_name,
                                   paste(sample, model_name, "rhats.rds", sep = "_")))
```



## Prep Data
```{r, eval = F}
deck_sub_keep = binomial_stan_data$ID_OG[binomial_stan_data$X[,1] == 0]

deck_group_prop = data.frame(iteration = 1:((deck_binomial_fit@sim$iter - deck_binomial_fit@sim$warmup) * deck_binomial_fit@sim$chains),
                        card_A = deck_binomial_posteriors$mu_A_theta,
                        card_B = deck_binomial_posteriors$mu_B_theta,
                        card_C = deck_binomial_posteriors$mu_C_theta,
                        card_D = deck_binomial_posteriors$mu_D_theta) %>% 
  pivot_longer(starts_with("card"), names_to = c("card", "group"),
               values_to = "prop", names_sep = "\\.", names_prefix = "card_") %>% 
  mutate(group = case_when(group == 1 ~ "Con", group == 2 ~ "SU",
                           group == 3 ~ "Dep", group == 4 ~ "Anx")) %>% 
  pivot_wider(names_from = "group", values_from = "prop") %>% 
  mutate(SU_Con = SU - Con, Dep_Con = Dep - Con, Anx_Con = Anx - Con) %>% 
  pivot_longer(contains(c("Con", "SU", "Anx", "Dep")), names_to = "group",
               values_to = "estimate") %>% 
  group_by(card, group) %>% 
  mutate(group = str_replace(group, "_", "-"),
         mean = mean(estimate),
         lower = HDIofMCMC(estimate)[1],
         upper = HDIofMCMC(estimate)[2],
         group = factor(group, levels = c("Con", "SU", "Dep", "Anx",
                                          "SU-Con", "Dep-Con", "Anx-Con")),
         group_means = case_when(group %in% c("Con", "SU", "Dep", "Anx") ~ group,
                                 T ~ "Comparison"),
         group_means = factor(group_means, ordered = T,
                              levels = c("Con", "SU", "Dep", "Anx", "Comparison")),
         comparison = case_when(group %in% c("Con", "SU", "Dep", "Anx") ~ "Group Mean",
                                T ~ group),
         comparison = factor(comparison, ordered = T,
                             levels = c("Group Mean", "SU-Con", "Dep-Con", "Anx-Con")),
         mean = case_when(comparison == "Group Mean" ~ NA, T ~ mean),
         lower = case_when(comparison == "Group Mean" ~ NA, T ~ lower),
         upper = case_when(comparison == "Group Mean" ~ NA, T ~ upper))

deck_ind_prop = data.frame(ID = binomial_stan_data$ID_OG,
                           SU = binomial_stan_data$X[,2],
                           Dep = binomial_stan_data$X[,3],
                           Anx = binomial_stan_data$X[,4],
                           A_obs = binomial_stan_data$A_plays / binomial_stan_data$A_trials,
                           B_obs = binomial_stan_data$B_plays / binomial_stan_data$B_trials,
                           C_obs = binomial_stan_data$C_plays / binomial_stan_data$C_trials,
                           D_obs = binomial_stan_data$D_plays / binomial_stan_data$D_trials,
                           A_pred = apply(deck_binomial_posteriors$A_theta, 2, mean),
                           B_pred = apply(deck_binomial_posteriors$B_theta, 2, mean),
                           C_pred = apply(deck_binomial_posteriors$C_theta, 2, mean),
                           D_pred = apply(deck_binomial_posteriors$D_theta, 2, mean)) %>%
  filter(ID != sub_keep)
```



## Posterior Distributions
```{r, eval = F}
# build plot
deck_group_prop_plot = deck_group_prop %>% 
  ggplot(aes(x = estimate, fill = group_means)) +
    # geoms
    geom_density(alpha = .5) +
    geom_hline(yintercept = 0) +
    geom_vline(aes(xintercept = mean), color = "red2", linewidth = .25) +
    geom_vline(aes(xintercept = lower), color = "red", linetype = "dashed", linewidth = .25) +
    geom_vline(aes(xintercept = upper), color = "red", linetype = "dashed", linewidth = .25) +
    # scales
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05)), n.breaks = 3) +
    scale_fill_manual(values = c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#999999"),
                      limits = c("Con", "SU", "Dep", "Anx")) +
    # themes
    labs(x = "Estimate", y = "Density") +
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black"),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          legend.position = c(.5, 1.05), legend.direction = "horizontal",
          legend.background = element_rect(fill = "transparent", colour = "transparent"),
          legend.title = element_blank(),
          plot.margin = unit(c(1, .5, .3, .1), "cm"),
          panel.spacing.x = unit(1, "cm"),
          panel.spacing.y = unit(.5, "cm"),
          strip.background = element_rect(fill = "transparent", colour = "transparent"),
          strip.text.x = element_blank(),
          strip.text.y = element_blank(),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent")) +
    facet_rep_wrap(card~comparison, scales = "free",
                   nrow = 4, ncol = 4) +
    facetted_pos_scales(
      list(
           comparison == "Group Mean" ~
             scale_x_continuous(limits = c(.5, 1), expand = expansion(add = c(0, 0)),
                                breaks = seq(.5, 1, length.out = 3)),
           comparison != "Group Mean" ~
             scale_x_continuous(limits = c(-.1, .1), expand = expansion(add = c(0, 0)),
                                breaks = seq(-.1, .1, length.out = 3))))

# save plot
tiff(here("1_TADS_Parents_PP", "Figs_Tables",
          model_name,
          paste("Betas", sample, "Posterior Distributions.tiff", sep = " ")),
     width = 16, height = 10, units = "cm", res = 300)

  grid.newpage()
  pushViewport(viewport(x = .5, y = .5, width = 1, height = 1))
  grid.draw(deck_group_prop_plot)
  grid.text(c("Group Means", "SU-Con", "Dep-Con", "Anx-Con"),
            x = c(.125, .375, .625, .85), y = .965,
            gp = gpar(fontsize = 9.5))
  
  # text
  grid.text(c("A", "B", "C", "D"),
            x = rep(.975, 4), y = c(.875, .67, .45, .25),
            gp = gpar(fontsize = 9.5))
  
dev.off()
```



# ---------------------------------------
# Good/Bad Binomial Model Plots
## Import Data
```{r}
# subset participant to exclude
sub_keep = binomial_stan_data$ID_participant[binomial_stan_data$X[,1] == 0]

model_name = "Covariate_Good_Bad_Binomial"

# -----------------------------------------------------------------------------------
# read in model fit
good_bad_binomial_fit = readRDS(here("1_TADS_Parents_PP", "Data", "2_Fitted",
                                     model_name,
                                     paste(sample, model_name, "fit.rds", sep = "_")))

# -----------------------------------------------------------------------------------
# read in posteriors
good_bad_binomial_posteriors = readRDS(here("1_TADS_Parents_PP", "Data", "2_Fitted",
                                            model_name,
                                            paste(sample, model_name, "posteriors.rds", sep = "_")))

# -----------------------------------------------------------------------------------
# read in rhats
good_bad_binomial_rhats = readRDS(here("1_TADS_Parents_PP", "Data", "2_Fitted",
                                       model_name,
                                       paste(sample, model_name, "rhats.rds", sep = "_")))
```



## Prep Data
### Group-Level Data
```{r, eval = T}
good_bad_grp_thetas = data.frame(iteration = 1:((good_bad_binomial_fit@sim$iter -
                                                   good_bad_binomial_fit@sim$warmup) *
                                                  good_bad_binomial_fit@sim$chains),
                                 good_mu = good_bad_binomial_posteriors$mu_good_theta,
                                 good_beta = good_bad_binomial_posteriors$mu_good,
                                 bad_mu = good_bad_binomial_posteriors$mu_bad_theta,
                                 bad_beta = good_bad_binomial_posteriors$mu_bad) %>% 
  pivot_longer(starts_with(c("good", "bad")), names_to = c("valence", "group"),
               values_to = "estimate", names_sep = "\\.") %>% 
  filter(!(str_detect(valence, "beta") & group == 1)) %>% 
  separate(col = "valence", into = c("valence", "parameter"), sep = "_") %>% 
  mutate(group = case_when(group == 1 & parameter == "mu" ~ "Con",
                           group == 2 & parameter == "mu" ~ "SU",
                           group == 3 & parameter == "mu" ~ "Dep",
                           group == 4 & parameter == "mu" ~ "Anx",
                           group == 2 & parameter == "beta" ~ "SU-Con",
                           group == 3 & parameter == "beta" ~ "Dep-Con",
                           group == 4 & parameter == "beta" ~ "Anx-Con")) %>% 
  group_by(valence, parameter, group) %>% 
  mutate(mu = mean(estimate),
         lower = HDIofMCMC(estimate)[1],
         upper = HDIofMCMC(estimate)[2],
         valence = factor(valence, levels = c("good", "bad"), ordered = T),
         group = factor(group, levels = c("Con", "SU", "Dep", "Anx",
                                          "SU-Con", "Dep-Con", "Anx-Con")),
         group_mean = case_when(group %in% c("Con", "SU", "Dep", "Anx") ~ group,
                                T ~ "Comparison"),
         group_mean = factor(group_mean, ordered = T,
                             levels = c("Con", "SU", "Dep", "Anx", "Comparison")),
         comparison = case_when(group %in% c("Con", "SU", "Dep", "Anx") ~ "Group Mean",
                                T ~ group),
         comparison = factor(comparison, ordered = T,
                             levels = c("Group Mean", "SU-Con", "Dep-Con", "Anx-Con")))
```



### Individual-Subject Data
```{r, eval = T}
good_bad_ind_data = data.frame(ID = binomial_stan_data$ID_OG,
                               ID_participant = binomial_stan_data$ID_participant,
                               SU = binomial_stan_data$X[,2],
                               Dep = binomial_stan_data$X[,3],
                               Anx = binomial_stan_data$X[,4],
                               obs_good = (binomial_stan_data$C_plays +
                                           binomial_stan_data$D_plays) /
                                          (binomial_stan_data$C_trials +
                                           binomial_stan_data$D_trials),
                               obs_bad = (binomial_stan_data$A_plays +
                                          binomial_stan_data$B_plays) /
                                         (binomial_stan_data$A_trials +
                                          binomial_stan_data$B_trials),
                               pred_good = apply(good_bad_binomial_posteriors$good_pred, 2, mean) /
                                 (binomial_stan_data$C_trials + binomial_stan_data$D_trials),
                               pred_bad = apply(good_bad_binomial_posteriors$bad_pred, 2, mean) /
                                 (binomial_stan_data$A_trials + binomial_stan_data$B_trials)) %>% 
  pivot_longer(ends_with(c("good", "bad")), names_to = c("type", "valence"),
               values_to = "estimate", names_sep = "_") %>% 
  pivot_wider(names_from = "type", values_from = "estimate")
```



## -----------
## SU
### Person-Level Plots
```{r}
SU_ind_plot = 
  good_bad_ind_data %>% 
  mutate(valence = factor(valence, levels = c("good", "bad"), labels = c("Good", "Bad"),
                          ordered = T),
         SU = factor(SU)) %>% 
  ggplot(aes(fill = SU)) +
    # geoms
    geom_histogram(aes(x = obs, y = ..density..), color = "black",
                   linewidth = .1) +
    geom_density(aes(x = pred), linewidth = .5) +
    # scales
    scale_x_continuous(limits = c(0, 1), expand = c(0, 0), breaks = seq(0, 1, .25),
                       labels = c("0", ".25", ".50", ".75", "1")) +
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05))) +
    scale_fill_manual(values = alpha(c("gray45", "goldenrod3"), alpha = .5),
                      labels = c("Con", "SU")) +
    # themes
    labs(x = "Estimate", y = "Density") +
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black"),
          axis.text.y = element_blank(),
          axis.ticks.x = element_line(color = "black"),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          legend.text = element_text(size = 6),
          legend.key.size = unit(.5, "lines"), legend.spacing.y = unit(.1, "lines"),
          legend.position = c(.1, .945), legend.direction = "vertical",
          legend.background = element_rect(fill = "transparent", colour = "transparent"),
          legend.title = element_blank(),
          plot.margin = unit(c(.5, .5, .3, .1), "cm"),
          panel.spacing.x = unit(.5, "cm"),
          panel.spacing.y = unit(.5, "cm"),
          strip.background = element_rect(fill = "transparent", colour = "transparent"),
          strip.text.x = element_blank(),
          strip.text.y = element_blank(),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent")) +
    facet_rep_wrap(valence~factor(SU), scales = "free",
                   nrow = 2, ncol = 2)
# -----------------------------------------------------------------------------------
# save plot
tiff(here("1_TADS_Parents_PP", "Figs_Tables",
          model_name,
          paste(sample, "Con-SU Ind Distributions.tiff", sep = " ")),
     width = 6, height = 6, units = "cm", res = 300)
  
  grid.newpage()
  # main plot
  pushViewport(viewport(x = .5, y = .5, width = 1, height = 1))
  grid.draw(SU_ind_plot)
  # popViewport()
  
dev.off()
```



### Group-Level Plots
```{r}
# -----------------------------------------------------------------------------------
# Mu Plots
# prep specific data for this plot
SU_mus_plot =
  good_bad_grp_thetas %>% 
  filter(group %in% c("Con", "SU")) %>% 
  mutate(valence = factor(valence, levels = c("good", "bad"), labels = c("Good", "Bad"),
                          ordered = T)) %>% 
  # build plot
  ggplot(aes(x = estimate, fill = group)) +
    # geoms
    geom_density(alpha = .5) +
    geom_hline(yintercept = 0) +
    # scales
    scale_x_continuous(limits = c(.5, 1), expand = c(0, 0), breaks = seq(.5,1, .25)) +
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05)), n.breaks = 3) +
    scale_fill_manual(values = alpha(c("gray45", "goldenrod3"), alpha = .5)) +
    # themes
    labs(x = "Estimate", y = "Density") +
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black"),
          axis.title.x = element_text(size = 10),
          axis.title.y = element_text(size = 10, vjust = 3),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          legend.text = element_text(size = 7),
          legend.key.size = unit(.5, "lines"), legend.spacing.y = unit(.1, "lines"),
          legend.position = c(.1, .925), legend.direction = "vertical",
          legend.background = element_rect(fill = "transparent", colour = "transparent"),
          legend.title = element_blank(),
          plot.margin = unit(c(.125, .4, .2, .125), "cm"),
          panel.spacing.y = unit(0, "cm"),
          strip.background = element_rect(fill = "transparent", colour = "transparent"),
          strip.text.y = element_blank(),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent")) +
    facet_rep_wrap(valence~., scales = "free",
                   nrow = 2, ncol = 1)
# -----------------------------------------------------------------------------------
# Good Beta Plot
# prep specific data for this plot
SU_good_beta_plot =
  good_bad_grp_thetas %>% 
  filter(group == "SU-Con" & valence == "good") %>% 
  # build plot
  ggplot(aes(x = estimate)) +
    # geoms
    geom_density(fill = "gray45", linewidth = .25) +
    geom_hline(yintercept = 0) +
    geom_vline(aes(xintercept = mu), color = "red2", linewidth = .25) +
    geom_vline(aes(xintercept = lower), color = "red", linetype = "dashed", linewidth = .25) +
    geom_vline(aes(xintercept = upper), color = "red", linetype = "dashed", linewidth = .25) +
    # scales
    scale_x_continuous(breaks = 0) +
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05)), n.breaks = 3) +
    # themes
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black", size = 6),
          axis.title = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          plot.margin = unit(c(.1, .4, .2, .1), "cm"),
          panel.spacing.y = unit(0, "cm"),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent"))
# -----------------------------------------------------------------------------------
# Bad Beta Plot
# prep specific data for this plot
SU_bad_beta_plot =
  good_bad_grp_thetas %>% 
  filter(group == "SU-Con" & valence == "bad") %>% 
  # build plot
  ggplot(aes(x = estimate)) +
    # geoms
    geom_density(fill = "gray45", linewidth = .25) +
    geom_hline(yintercept = 0) +
    geom_vline(aes(xintercept = mu), color = "red2", linewidth = .25) +
    geom_vline(aes(xintercept = lower), color = "red", linetype = "dashed", linewidth = .25) +
    geom_vline(aes(xintercept = upper), color = "red", linetype = "dashed", linewidth = .25) +
    # scales
    scale_x_continuous(breaks = 0) +
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05)), n.breaks = 3) +
    # themes
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black", size = 6),
          axis.title = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          plot.margin = unit(c(.1, .4, .2, .1), "cm"),
          panel.spacing.y = unit(0, "cm"),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent"))
# -----------------------------------------------------------------------------------
# save plot
tiff(here("1_TADS_Parents_PP", "Figs_Tables",
          model_name,
          paste(sample, "Con-SU Mus & Beta Posterior Distributions.tiff", sep = " ")),
     width = 4, height = 6, units = "cm", res = 300)
  
  grid.newpage()
  # main plot
  grid.draw(ggplotGrob(SU_mus_plot))
  
  # top inset
  pushViewport(viewport(x = .825, y = .8, width = .375, height = .2))
  grid.draw(ggplotGrob(SU_good_beta_plot))
  popViewport()
  
  # bottom inset
  pushViewport(viewport(x = .825, y = .35, width = .375, height = .2))
  grid.draw(ggplotGrob(SU_bad_beta_plot))
  
  popViewport()
  
dev.off()
```



## -----------
## Dep
### Person-Level Plots
```{r}
Dep_ind_plot = 
  good_bad_ind_data %>% 
  mutate(valence = factor(valence, levels = c("good", "bad"), labels = c("Good", "Bad"),
                          ordered = T)) %>% 
  ggplot() +
    # geoms
    geom_histogram(aes(x = obs, y = ..density.., fill = factor(Dep)), color = "black",
                   linewidth = .1, bins = 75,) +
    geom_density(aes(x = pred, fill = factor(Dep)), linewidth = .5) +
    # scales
    scale_x_continuous(limits = c(0, 1), expand = c(0, 0), breaks = seq(0, 1, .25),
                       labels = c("0", ".25", ".50", ".75", "1")) +
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05))) +
    scale_fill_manual(values = alpha(c("gray45", "goldenrod3"), alpha = .5),
                      labels = c("Con", "Dep")) +
    # themes
    labs(x = "Estimate", y = "Density") +
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black"),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          legend.text = element_text(size = 6),
          legend.key.size = unit(.5, "lines"), legend.spacing.y = unit(.1, "lines"),
          legend.position = c(.1, .945), legend.direction = "vertical",
          legend.background = element_rect(fill = "transparent", colour = "transparent"),
          legend.title = element_blank(),
          plot.margin = unit(c(.5, .5, .3, .1), "cm"),
          panel.spacing.x = unit(.5, "cm"),
          panel.spacing.y = unit(.5, "cm"),
          strip.background = element_rect(fill = "transparent", colour = "transparent"),
          strip.text.x = element_blank(),
          strip.text.y = element_blank(),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent")) +
    facet_rep_wrap(valence~factor(Dep), scales = "free",
                   nrow = 2, ncol = 2)
# -----------------------------------------------------------------------------------
# save plot
tiff(here("1_TADS_Parents_PP", "Figs_Tables",
          model_name,
          paste(sample, "Con-Dep Ind Distributions.tiff", sep = " ")),
     width = 6, height = 6, units = "cm", res = 300)
  
  grid.newpage()
  # main plot
  pushViewport(viewport(x = .5, y = .5, width = 1, height = 1))
  grid.draw(Dep_ind_plot)
  # popViewport()
  
dev.off()
```



### Group-Level Plots
```{r}
# -----------------------------------------------------------------------------------
# Mu Plots
# prep specific data for this plot
Dep_mus_plot =
  good_bad_grp_thetas %>% 
  filter(group %in% c("Con", "Dep")) %>% 
  mutate(valence = factor(valence, levels = c("good", "bad"), labels = c("Good", "Bad"),
                          ordered = T)) %>% 
  # build plot
  ggplot(aes(x = estimate, fill = group)) +
    # geoms
    geom_density(alpha = .5) +
    geom_hline(yintercept = 0) +
    # scales
    scale_x_continuous(limits = c(.5, 1), expand = c(0, 0), breaks = seq(.5,1, .25)) +
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05)), n.breaks = 3) +
    scale_fill_manual(values = alpha(c("gray45", "goldenrod3"), alpha = .5)) +
    # themes
    labs(x = "Estimate", y = "Density") +
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black"),
          axis.title.x = element_text(size = 10),
          axis.title.y = element_text(size = 10, vjust = 3),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          legend.text = element_text(size = 7),
          legend.key.size = unit(.5, "lines"), legend.spacing.y = unit(.1, "lines"),
          legend.position = c(.1, .925), legend.direction = "vertical",
          legend.background = element_rect(fill = "transparent", colour = "transparent"),
          legend.title = element_blank(),
          plot.margin = unit(c(.125, .4, .2, .125), "cm"),
          panel.spacing.y = unit(0, "cm"),
          strip.background = element_rect(fill = "transparent", colour = "transparent"),
          strip.text.y = element_blank(),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent")) +
    facet_rep_wrap(valence~., scales = "free",
                   nrow = 2, ncol = 1)
# -----------------------------------------------------------------------------------
# Good Beta Plot
# prep specific data for this plot
Dep_good_beta_plot =
  good_bad_grp_thetas %>% 
  filter(group == "Dep-Con" & valence == "good") %>% 
  # build plot
  ggplot(aes(x = estimate)) +
    # geoms
    geom_density(fill = "gray45", linewidth = .25) +
    geom_hline(yintercept = 0) +
    geom_vline(aes(xintercept = mu), color = "red2", linewidth = .25) +
    geom_vline(aes(xintercept = lower), color = "red", linetype = "dashed", linewidth = .25) +
    geom_vline(aes(xintercept = upper), color = "red", linetype = "dashed", linewidth = .25) +
    # scales
    scale_x_continuous(breaks = 0) +
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05)), n.breaks = 3) +
    # themes
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black", size = 6),
          axis.title = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          plot.margin = unit(c(.1, .4, .2, .1), "cm"),
          panel.spacing.y = unit(0, "cm"),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent"))
# -----------------------------------------------------------------------------------
# Bad Beta Plot
# prep specific data for this plot
Dep_bad_beta_plot =
  good_bad_grp_thetas %>% 
  filter(group == "Dep-Con" & valence == "bad") %>% 
  # build plot
  ggplot(aes(x = estimate)) +
    # geoms
    geom_density(fill = "gray45", linewidth = .25) +
    geom_hline(yintercept = 0) +
    geom_vline(aes(xintercept = mu), color = "red2", linewidth = .25) +
    geom_vline(aes(xintercept = lower), color = "red", linetype = "dashed", linewidth = .25) +
    geom_vline(aes(xintercept = upper), color = "red", linetype = "dashed", linewidth = .25) +
    # scales
    scale_x_continuous(breaks = 0) +
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05)), n.breaks = 3) +
    # themes
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black", size = 6),
          axis.title = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          plot.margin = unit(c(.1, .4, .2, .1), "cm"),
          panel.spacing.y = unit(0, "cm"),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent"))
# -----------------------------------------------------------------------------------
# save plot
tiff(here("1_TADS_Parents_PP", "Figs_Tables",
          model_name,
          paste(sample, "Con-Dep Mus & Beta Posterior Distributions.tiff", sep = " ")),
     width = 4, height = 6, units = "cm", res = 300)
  
  grid.newpage()
  # main plot
  grid.draw(ggplotGrob(Dep_mus_plot))
  
  # top inset
  pushViewport(viewport(x = .825, y = .8, width = .375, height = .2))
  grid.draw(ggplotGrob(Dep_good_beta_plot))
  popViewport()
  
  # bottom inset
  pushViewport(viewport(x = .825, y = .35, width = .375, height = .2))
  grid.draw(ggplotGrob(Dep_bad_beta_plot))
  
  popViewport()
  
dev.off()
```



## -----------
## Anx
### Person-Level Plots
```{r}
Anx_ind_plot = 
  good_bad_ind_data %>% 
  mutate(valence = factor(valence, levels = c("good", "bad"), labels = c("Good", "Bad"),
                          ordered = T)) %>% 
  ggplot() +
    # geoms
    geom_histogram(aes(x = obs, y = ..density.., fill = factor(Anx)), color = "black",
                   linewidth = .1, bins = 75,) +
    geom_density(aes(x = pred, fill = factor(Anx)), linewidth = .5) +
    # scales
    scale_x_continuous(limits = c(0, 1), expand = c(0, 0), breaks = seq(0, 1, .25),
                       labels = c("0", ".25", ".50", ".75", "1")) +
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05))) +
    scale_fill_manual(values = alpha(c("gray45", "goldenrod3"), alpha = .5),
                      labels = c("Con", "Anx")) +
    # themes
    labs(x = "Estimate", y = "Density") +
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black"),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          legend.text = element_text(size = 6),
          legend.key.size = unit(.5, "lines"), legend.spacing.y = unit(.1, "lines"),
          legend.position = c(.1, .945), legend.direction = "vertical",
          legend.background = element_rect(fill = "transparent", colour = "transparent"),
          legend.title = element_blank(),
          plot.margin = unit(c(.5, .5, .3, .1), "cm"),
          panel.spacing.x = unit(.5, "cm"),
          panel.spacing.y = unit(.5, "cm"),
          strip.background = element_rect(fill = "transparent", colour = "transparent"),
          strip.text.x = element_blank(),
          strip.text.y = element_blank(),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent")) +
    facet_rep_wrap(valence~factor(Anx), scales = "free",
                   nrow = 2, ncol = 2)
# -----------------------------------------------------------------------------------
# save plot
tiff(here("1_TADS_Parents_PP", "Figs_Tables",
          model_name,
          paste(sample, "Con-Anx Ind Distributions.tiff", sep = " ")),
     width = 6, height = 6, units = "cm", res = 300)
  
  grid.newpage()
  # main plot
  pushViewport(viewport(x = .5, y = .5, width = 1, height = 1))
  grid.draw(Anx_ind_plot)
  # popViewport()
  
dev.off()
```



### Group-Level Plots 1
```{r}
# -----------------------------------------------------------------------------------
# Mu Plots
# prep specific data for this plot
Anx_mus_plot =
  good_bad_grp_thetas %>% 
  filter(group %in% c("Con", "Anx")) %>% 
  mutate(valence = factor(valence, levels = c("good", "bad"), labels = c("Good", "Bad"),
                          ordered = T)) %>% 
  # build plot
  ggplot(aes(x = estimate, fill = group)) +
    # geoms
    geom_density(alpha = .5) +
    geom_hline(yintercept = 0) +
    # scales
    scale_x_continuous(limits = c(.5, 1), expand = c(0, 0), breaks = seq(.5,1, .25)) +
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05)), n.breaks = 3) +
    scale_fill_manual(values = alpha(c("gray45", "goldenrod3"), alpha = .5)) +
    # themes
    labs(x = "Estimate", y = "Density") +
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black"),
          axis.title.x = element_text(size = 10),
          axis.title.y = element_text(size = 10, vjust = 3),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          legend.text = element_text(size = 7),
          legend.key.size = unit(.5, "lines"), legend.spacing.y = unit(.1, "lines"),
          legend.position = c(.1, .925), legend.direction = "vertical",
          legend.background = element_rect(fill = "transparent", colour = "transparent"),
          legend.title = element_blank(),
          plot.margin = unit(c(.125, .4, .2, .125), "cm"),
          panel.spacing.y = unit(0, "cm"),
          strip.background = element_rect(fill = "transparent", colour = "transparent"),
          strip.text.y = element_blank(),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent")) +
    facet_rep_wrap(valence~., scales = "free",
                   nrow = 2, ncol = 1)
# -----------------------------------------------------------------------------------
# Good Beta Plot
# prep specific data for this plot
Anx_good_beta_plot =
  good_bad_grp_thetas %>% 
  filter(group == "Anx-Con" & valence == "good") %>% 
  # build plot
  ggplot(aes(x = estimate)) +
    # geoms
    geom_density(fill = "gray45", linewidth = .25) +
    geom_hline(yintercept = 0) +
    geom_vline(aes(xintercept = mu), color = "red2", linewidth = .25) +
    geom_vline(aes(xintercept = lower), color = "red", linetype = "dashed", linewidth = .25) +
    geom_vline(aes(xintercept = upper), color = "red", linetype = "dashed", linewidth = .25) +
    # scales
    scale_x_continuous(breaks = 0) +
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05)), n.breaks = 3) +
    # themes
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black", size = 6),
          axis.title = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          plot.margin = unit(c(.1, .4, .2, .1), "cm"),
          panel.spacing.y = unit(0, "cm"),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent"))
# -----------------------------------------------------------------------------------
# Bad Beta Plot
# prep specific data for this plot
Anx_bad_beta_plot =
  good_bad_grp_thetas %>% 
  filter(group == "Anx-Con" & valence == "bad") %>% 
  # build plot
  ggplot(aes(x = estimate)) +
    # geoms
    geom_density(fill = "gray45", linewidth = .25) +
    geom_hline(yintercept = 0) +
    geom_vline(aes(xintercept = mu), color = "red2", linewidth = .25) +
    geom_vline(aes(xintercept = lower), color = "red", linetype = "dashed", linewidth = .25) +
    geom_vline(aes(xintercept = upper), color = "red", linetype = "dashed", linewidth = .25) +
    # scales
    scale_x_continuous(breaks = 0) +
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05)), n.breaks = 3) +
    # themes
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black", size = 6),
          axis.title = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          plot.margin = unit(c(.1, .4, .2, .1), "cm"),
          panel.spacing.y = unit(0, "cm"),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent"))
# -----------------------------------------------------------------------------------
# save plot
tiff(here("1_TADS_Parents_PP", "Figs_Tables",
          model_name,
          paste(sample, "Con-Anx Mus & Beta Posterior Distributions.tiff", sep = " ")),
     width = 4, height = 6, units = "cm", res = 300)
  
  grid.newpage()
  # main plot
  grid.draw(ggplotGrob(Anx_mus_plot))
  
  # top inset
  pushViewport(viewport(x = .825, y = .8, width = .375, height = .2))
  grid.draw(ggplotGrob(Anx_good_beta_plot))
  popViewport()
  
  # bottom inset
  pushViewport(viewport(x = .825, y = .35, width = .375, height = .2))
  grid.draw(ggplotGrob(Anx_bad_beta_plot))
  
  popViewport()
  
dev.off()
```



### Group-Level Plots 2
```{r}
# -----------------------------------------------------------------------------------
# Mu Plots
# prep specific data for this plot
Anx_dot_plot =
  good_bad_grp_thetas %>% 
    # plot
    ggplot(aes(x = type, y = choice_proportion, fill = session)) +
      # geoms
      geom_crossbar(aes(y = mu, ymin = mu, ymax = mu), size = .5, fatten = 0) +
      geom_dotplot(binaxis = "y", stackdir = "center",
                   position = position_dodge(width = .8)) +
      geom_pointrange(aes(y = mu_session, ymin = lower, ymax = upper),
                      color = "red", size = .1,
                      position = position_dodge(width = .8)) +
      # scales
      scale_y_continuous(limits = c(0, 1), expand = c(.01, .01), breaks = seq(0, 1, .25)) +
      scale_fill_manual(values = c("gray25", "gray75"),
                        labels = c("Session 1", "Session 2")) +
      # themes
      labs(x = "Session", y = "Proportion of Plays") +
      coord_cartesian(clip = "off") +
      theme_classic() +
      theme(axis.text.x = element_text(color = "black", size = 10),
            axis.text.y = element_text(color = "black", size = 9),
            axis.title.x = element_blank(),
            axis.title.y = element_text(size = 10),
            plot.margin = unit(c(1.5,0,0,0), "lines"),
            legend.position = "none")
  
  
  
  
  
  good_bad_grp_thetas %>% 
  filter(group %in% c("Con", "Anx")) %>% 
  mutate(valence = factor(valence, levels = c("good", "bad"), labels = c("Good", "Bad"),
                          ordered = T)) %>% 
  # build plot
  ggplot(aes(x = estimate, fill = group)) +
    # geoms
    geom_density(alpha = .5) +
    geom_hline(yintercept = 0) +
    # scales
    scale_x_continuous(limits = c(.5, 1), expand = c(0, 0), breaks = seq(.5,1, .25)) +
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05)), n.breaks = 3) +
    scale_fill_manual(values = alpha(c("gray45", "goldenrod3"), alpha = .5)) +
    # themes
    labs(x = "Estimate", y = "Density") +
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black"),
          axis.title.x = element_text(size = 10),
          axis.title.y = element_text(size = 10, vjust = 3),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          legend.text = element_text(size = 7),
          legend.key.size = unit(.5, "lines"), legend.spacing.y = unit(.1, "lines"),
          legend.position = c(.1, .925), legend.direction = "vertical",
          legend.background = element_rect(fill = "transparent", colour = "transparent"),
          legend.title = element_blank(),
          plot.margin = unit(c(.125, .4, .2, .125), "cm"),
          panel.spacing.y = unit(0, "cm"),
          strip.background = element_rect(fill = "transparent", colour = "transparent"),
          strip.text.y = element_blank(),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent")) +
    facet_rep_wrap(valence~., scales = "free",
                   nrow = 2, ncol = 1)
# -----------------------------------------------------------------------------------
# Good Beta Plot
# prep specific data for this plot
Anx_good_beta_plot =
  good_bad_grp_thetas %>% 
  filter(group == "Anx-Con" & valence == "good") %>% 
  # build plot
  ggplot(aes(x = estimate)) +
    # geoms
    geom_density(fill = "gray45", linewidth = .25) +
    geom_hline(yintercept = 0) +
    geom_vline(aes(xintercept = mu), color = "red2", linewidth = .25) +
    geom_vline(aes(xintercept = lower), color = "red", linetype = "dashed", linewidth = .25) +
    geom_vline(aes(xintercept = upper), color = "red", linetype = "dashed", linewidth = .25) +
    # scales
    scale_x_continuous(breaks = 0) +
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05)), n.breaks = 3) +
    # themes
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black", size = 6),
          axis.title = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          plot.margin = unit(c(.1, .4, .2, .1), "cm"),
          panel.spacing.y = unit(0, "cm"),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent"))
# -----------------------------------------------------------------------------------
# Bad Beta Plot
# prep specific data for this plot
Anx_bad_beta_plot =
  good_bad_grp_thetas %>% 
  filter(group == "Anx-Con" & valence == "bad") %>% 
  # build plot
  ggplot(aes(x = estimate)) +
    # geoms
    geom_density(fill = "gray45", linewidth = .25) +
    geom_hline(yintercept = 0) +
    geom_vline(aes(xintercept = mu), color = "red2", linewidth = .25) +
    geom_vline(aes(xintercept = lower), color = "red", linetype = "dashed", linewidth = .25) +
    geom_vline(aes(xintercept = upper), color = "red", linetype = "dashed", linewidth = .25) +
    # scales
    scale_x_continuous(breaks = 0) +
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05)), n.breaks = 3) +
    # themes
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black", size = 6),
          axis.title = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          plot.margin = unit(c(.1, .4, .2, .1), "cm"),
          panel.spacing.y = unit(0, "cm"),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent"))
# -----------------------------------------------------------------------------------
# save plot
tiff(here("1_TADS_Parents_PP", "Figs_Tables",
          model_name,
          paste(sample, "Con-Anx Mus & Beta Posterior Distributions.tiff", sep = " ")),
     width = 4, height = 6, units = "cm", res = 300)
  
  grid.newpage()
  # main plot
  grid.draw(ggplotGrob(Anx_mus_plot))
  
  # top inset
  pushViewport(viewport(x = .825, y = .8, width = .375, height = .2))
  grid.draw(ggplotGrob(Anx_good_beta_plot))
  popViewport()
  
  # bottom inset
  pushViewport(viewport(x = .825, y = .35, width = .375, height = .2))
  grid.draw(ggplotGrob(Anx_bad_beta_plot))
  
  popViewport()
  
dev.off()
```



## -----------
## STOP



```{r}
  good_bad_ind_data %>% 
  ggplot(aes(fill = factor(SU))) +
    # geoms
    geom_histogram(aes(x = obs, y = ..density..), color = "black",
                   bins = 75) +
    geom_density(aes(x = pred)) +
    # scales
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05)), n.breaks = 3) +
    # scale_color_manual(values = c("gray45", "goldenrod3"),
    #                   labels = c("Con", "SU")) +
    scale_fill_manual(values = alpha(c("gray45", "goldenrod3"), alpha = .5),
                      labels = c("Con", "SU")) +
    # themes
    labs(x = "Estimate", y = "Density") +
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black"),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          legend.text = element_text(size = 6),
          legend.key.size = unit(.5, "lines"), legend.spacing.y = unit(.1, "lines"),
          legend.position = c(.2, .925), legend.direction = "horizontal",
          legend.background = element_rect(fill = "transparent", colour = "transparent"),
          legend.title = element_blank(),
          plot.margin = unit(c(.5, .5, .3, .1), "cm"),
          panel.spacing.x = unit(.5, "cm"),
          panel.spacing.y = unit(.5, "cm"),
          strip.background = element_rect(fill = "transparent", colour = "transparent"),
          # strip.text.x = element_blank(),
          # strip.text.y = element_blank(),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent")) +
    facet_rep_wrap(valence~factor(SU), scales = "free",
                   nrow = 2, ncol = 2)
```






## Posteriors
```{r, eval = T}
# build plot
good_bad_group_prop_plot = good_bad_ind_prop %>% 
  ggplot(aes(x = proportion)) +
    # geoms
    geom_histogram(aes(y = ..density.., fill = SU), color = "black",
                   linewidth = .1, bins = 50) +
    geom_density(data = filter(good_bad_grp_thetas, group %in% c("Con", "SU", "SU-Con")),
                 aes(x = estimate, fill = group), alpha = .5) +
    geom_hline(yintercept = 0) +
    geom_vline(data = filter(good_bad_mu_thetas, group %in% "SU-Con"),
               aes(xintercept = mu), color = "red2", linewidth = .25) +
    geom_vline(data = filter(good_bad_mu_thetas, group %in% "SU-Con"),
               aes(xintercept = lower), color = "red", linetype = "dashed", linewidth = .25) +
    geom_vline(data = filter(good_bad_mu_thetas, group %in% "SU-Con"),
               aes(xintercept = upper), color = "red", linetype = "dashed", linewidth = .25) +
    # scales
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05)), n.breaks = 3) +
    scale_fill_manual(values = c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#999999"),
                      limits = c("Con", "SU", "Dep", "Anx")) +
    # themes
    labs(x = "Estimate", y = "Density") +
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black"),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          legend.text = element_text(size = 6),
          legend.key.size = unit(.5, "lines"), legend.spacing.y = unit(.1, "lines"),
          legend.position = c(.2, .925), legend.direction = "horizontal",
          legend.background = element_rect(fill = "transparent", colour = "transparent"),
          legend.title = element_blank(),
          plot.margin = unit(c(.5, .5, .3, .1), "cm"),
          panel.spacing.x = unit(.5, "cm"),
          panel.spacing.y = unit(.5, "cm"),
          strip.background = element_rect(fill = "transparent", colour = "transparent"),
          # strip.text.x = element_blank(),
          # strip.text.y = element_blank(),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent")) +
    facet_rep_wrap(valence~comparison, scales = "free",
                   nrow = 2, ncol = 2) #+
    # facetted_pos_scales(
    #   list(
    #        valence == "good" & comparison == "Group Mean" ~
    #          scale_x_continuous(limits = c(.725, .925), expand = expansion(add = c(0, 0)),
    #                             breaks = seq(.75, .9, .05), labels = c(".75", ".80", ".85", ".90")),
    #        valence == "bad" & comparison == "Group Mean" ~
    #          scale_x_continuous(limits = c(.575, .775), expand = expansion(add = c(0, 0)),
    #                             breaks = seq(.6, .75, .05), labels = c(".60", ".65", ".70", ".75")),
    #        comparison != "Group Mean" ~
    #          scale_x_continuous(limits = c(-.1, .1), expand = expansion(add = c(0, 0)),
    #                             breaks = seq(-.1, .1, length.out = 3)))) + 
    # guides(fill = guide_legend(nrow = 2))

# save plot
tiff(here("1_TADS_Parents_PP", "Figs_Tables",
          model_name,
          paste("Betas", sample, "Posterior Distributions.tiff", sep = " ")),
     width = 14.6, height = 6, units = "cm", res = 300)

  grid.newpage()
  pushViewport(viewport(x = .5, y = .5, width = 1, height = 1))
  grid.draw(good_bad_group_prop_plot)
  grid.text(c("Group Means", "SU-Con", "Dep-Con", "Anx-Con"),
            x = c(.145, .395, .625, .865), y = .95,
            gp = gpar(fontsize = 9.5))
  
  # text
  grid.text(c("Good", "Bad"),
            x = rep(.99, 2), y = c(.85, .425), hjust = 1,
            gp = gpar(fontsize = 9.5))
  
dev.off()
```



## Posterior Distributions
```{r, eval = T}
# build plot
good_bad_group_prop_plot = good_bad_ind_prop %>% 
  ggplot(aes(x = estimate, fill = group_means)) +
    # geoms
    geom_histogram(aes(y = ..density..), color = "black", fill = "gray45",
                   linewidth = .1, bins = 50) +
    geom_density(data = good_bad_group_prop, aes(x = estimate, fill = group_means),
                 alpha = .5) +
    geom_hline(yintercept = 0) +
    geom_vline(data = good_bad_group_prop,
               aes(xintercept = mean), color = "red2", linewidth = .25) +
    geom_vline(data = good_bad_group_prop,
               aes(xintercept = lower), color = "red", linetype = "dashed", linewidth = .25) +
    geom_vline(data = good_bad_group_prop, 
               aes(xintercept = upper), color = "red", linetype = "dashed", linewidth = .25) +
    # scales
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05)), n.breaks = 3) +
    scale_fill_manual(values = c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#999999"),
                      limits = c("Con", "SU", "Dep", "Anx")) +
    # themes
    labs(x = "Estimate", y = "Density") +
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black"),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          legend.text = element_text(size = 6),
          legend.key.size = unit(.5, "lines"), legend.spacing.y = unit(.1, "lines"),
          legend.position = c(.2, .925), legend.direction = "horizontal",
          legend.background = element_rect(fill = "transparent", colour = "transparent"),
          legend.title = element_blank(),
          plot.margin = unit(c(.5, .5, .3, .1), "cm"),
          panel.spacing.x = unit(.5, "cm"),
          panel.spacing.y = unit(.5, "cm"),
          strip.background = element_rect(fill = "transparent", colour = "transparent"),
          strip.text.x = element_blank(),
          strip.text.y = element_blank(),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent")) +
    facet_rep_wrap(valence~comparison, scales = "free",
                   nrow = 2, ncol = 4) +
    facetted_pos_scales(
      list(
           valence == "good" & comparison == "Group Mean" ~
             scale_x_continuous(limits = c(.725, .925), expand = expansion(add = c(0, 0)),
                                breaks = seq(.75, .9, .05), labels = c(".75", ".80", ".85", ".90")),
           valence == "bad" & comparison == "Group Mean" ~
             scale_x_continuous(limits = c(.575, .775), expand = expansion(add = c(0, 0)),
                                breaks = seq(.6, .75, .05), labels = c(".60", ".65", ".70", ".75")),
           comparison != "Group Mean" ~
             scale_x_continuous(limits = c(-.1, .1), expand = expansion(add = c(0, 0)),
                                breaks = seq(-.1, .1, length.out = 3)))) + 
    guides(fill = guide_legend(nrow = 2))

# save plot
tiff(here("1_TADS_Parents_PP", "Figs_Tables",
          model_name,
          paste("Betas", sample, "Posterior Distributions.tiff", sep = " ")),
     width = 14.6, height = 6, units = "cm", res = 300)

  grid.newpage()
  pushViewport(viewport(x = .5, y = .5, width = 1, height = 1))
  grid.draw(good_bad_group_prop_plot)
  grid.text(c("Group Means", "SU-Con", "Dep-Con", "Anx-Con"),
            x = c(.145, .395, .625, .865), y = .95,
            gp = gpar(fontsize = 9.5))
  
  # text
  grid.text(c("Good", "Bad"),
            x = rep(.99, 2), y = c(.85, .425), hjust = 1,
            gp = gpar(fontsize = 9.5))
  
dev.off()
```



# ---------------------------------------
## Prep Data
### Group-Level Data
```{r, eval = T}
sub_keep = binomial_stan_data$ID_OG[binomial_stan_data$X[,1] == 0]

good_bad_grp_thetas = data.frame(iteration = 1:((good_bad_binomial_fit@sim$iter -
                                                   good_bad_binomial_fit@sim$warmup) *
                                                  good_bad_binomial_fit@sim$chains),
                                 good_mu = good_bad_binomial_posteriors$mu_good_theta,
                                 good_beta = good_bad_binomial_posteriors$mu_good,
                                 bad_mu = good_bad_binomial_posteriors$mu_bad_theta,
                                 bad_beta = good_bad_binomial_posteriors$mu_bad) %>% 
  pivot_longer(starts_with(c("good", "bad")), names_to = c("valence", "group"),
               values_to = "estimate", names_sep = "\\.") %>% 
  filter(!(str_detect(valence, "beta") & group == 1)) %>% 
  separate(col = "valence", into = c("valence", "parameter"), sep = "_") %>% 
  mutate(group = case_when(group == 1 & parameter == "mu" ~ "Con",
                           group == 2 & parameter == "mu" ~ "SU",
                           group == 3 & parameter == "mu" ~ "Dep",
                           group == 4 & parameter == "mu" ~ "Anx",
                           group == 2 & parameter == "beta" ~ "SU-Con",
                           group == 3 & parameter == "beta" ~ "Dep-Con",
                           group == 4 & parameter == "beta" ~ "Anx-Con")) %>% 
  group_by(valence, parameter, group) %>% 
  mutate(valence = factor(valence, levels = c("good", "bad"), ordered = T),
         group = factor(group, levels = c("Con", "SU", "Dep", "Anx",
                                          "SU-Con", "Dep-Con", "Anx-Con")),
         group_means = case_when(group %in% c("Con", "SU", "Dep", "Anx") ~ group,
                                 T ~ "Comparison"),
         group_means = factor(group_means, ordered = T,
                              levels = c("Con", "SU", "Dep", "Anx", "Comparison")),
         comparison = case_when(group %in% c("Con", "SU", "Dep", "Anx") ~ "Group Mean",
                                T ~ group),
         comparison = factor(comparison, ordered = T,
                             levels = c("Group Mean", "SU-Con", "Dep-Con", "Anx-Con")))


good_bad_mu_thetas = good_bad_group_prop %>% 
  group_by(valence, parameter, group, group_means, comparison) %>% 
  summarise(mu = mean(estimate),
            lower = HDIofMCMC(estimate)[1],
            upper = HDIofMCMC(estimate)[2])
```



### Individual-Subject Data
```{r, eval = T}
good_bad_ind_prop = data.frame(ID = binomial_stan_data$ID_OG,
                               ID = binomial_stan_data$ID_participant,
                               SU = binomial_stan_data$X[,2],
                               Dep = binomial_stan_data$X[,3],
                               Anx = binomial_stan_data$X[,4],
                               obs_good = (binomial_stan_data$C_plays +
                                           binomial_stan_data$D_plays) /
                                          (binomial_stan_data$C_trials +
                                           binomial_stan_data$D_trials),
                               obs_bad = (binomial_stan_data$A_plays +
                                           binomial_stan_data$B_plays) /
                                          (binomial_stan_data$A_trials +
                                           binomial_stan_data$B_trials)) %>%
  filter(ID != sub_keep) %>% 
  mutate(SU = case_when(SU == 1 ~ "SU", T ~ "Con"),
         Dep = case_when(SU == 1 ~ "Dep", T ~ "Con"),
         Anx = case_when(SU == 1 ~ "Anx", T ~ "Con"),
         comparison = "Group Mean") %>% 
  pivot_longer(c("obs_good", "obs_bad"), names_to = "valence", values_to = "proportion",
               names_prefix = "obs_")


good_bad_ind_data = data.frame(ID = binomial_stan_data$ID_OG,
                               ID = binomial_stan_data$ID_participant,
                               SU = binomial_stan_data$X[,2],
                               Dep = binomial_stan_data$X[,3],
                               Anx = binomial_stan_data$X[,4],
                               obs_good = (binomial_stan_data$C_plays +
                                           binomial_stan_data$D_plays) /
                                          (binomial_stan_data$C_trials +
                                           binomial_stan_data$D_trials),
                               obs_bad = (binomial_stan_data$A_plays +
                                          binomial_stan_data$B_plays) /
                                         (binomial_stan_data$A_trials +
                                          binomial_stan_data$B_trials),
                               pred_good = apply(good_bad_binomial_posteriors$good_pred, 2, mean) /
                                 (binomial_stan_data$C_trials + binomial_stan_data$D_trials),
                               pred_bad = apply(good_bad_binomial_posteriors$bad_pred, 2, mean) /
                                 (binomial_stan_data$A_trials + binomial_stan_data$B_trials)) %>% 
  pivot_longer(ends_with(c("good", "bad")), names_to = c("type", "valence"),
               values_to = "estimate", names_sep = "_") %>% 
  pivot_wider(names_from = "type", values_from = "estimate")
  # mutate(valence = factor(valence, levels = c("good", "bad"), ordered = T),
  #        group = factor(group, levels = c("Con", "SU", "Dep", "Anx",
  #                                         "SU-Con", "Dep-Con", "Anx-Con")),
  #        group_means = case_when(group %in% c("Con", "SU", "Dep", "Anx") ~ group,
  #                                T ~ "Comparison"),
  #        group_means = factor(group_means, ordered = T,
  #                             levels = c("Con", "SU", "Dep", "Anx", "Comparison")),
  #        comparison = case_when(group %in% c("Con", "SU", "Dep", "Anx") ~ "Group Mean",
  #                               T ~ group),
  #        comparison = factor(comparison, ordered = T,
  #                            levels = c("Group Mean", "SU-Con", "Dep-Con", "Anx-Con")))
```



```{r}
  good_bad_ind_data %>% 
  ggplot() +
    # geoms
    geom_histogram(aes(x = obs, y = ..density.., fill = factor(SU)), color = "black",
                   bins = 75) +
    geom_density(aes(x = pred, fill = factor(SU))) +
    # scales
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05)), n.breaks = 3) +
    # scale_color_manual(values = c("gray45", "goldenrod3"),
    #                   labels = c("Con", "SU")) +
    scale_fill_manual(values = alpha(c("gray45", "goldenrod3"), alpha = .5),
                      labels = c("Con", "SU")) +
    # themes
    labs(x = "Estimate", y = "Density") +
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black"),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          legend.text = element_text(size = 6),
          legend.key.size = unit(.5, "lines"), legend.spacing.y = unit(.1, "lines"),
          legend.position = c(.2, .925), legend.direction = "horizontal",
          legend.background = element_rect(fill = "transparent", colour = "transparent"),
          legend.title = element_blank(),
          plot.margin = unit(c(.5, .5, .3, .1), "cm"),
          panel.spacing.x = unit(.5, "cm"),
          panel.spacing.y = unit(.5, "cm"),
          strip.background = element_rect(fill = "transparent", colour = "transparent"),
          # strip.text.x = element_blank(),
          # strip.text.y = element_blank(),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent")) +
    facet_rep_wrap(valence~factor(SU), scales = "free",
                   nrow = 2, ncol = 2)
```






## Posteriors
```{r, eval = T}
# build plot
good_bad_group_prop_plot = good_bad_ind_prop %>% 
  ggplot(aes(x = proportion)) +
    # geoms
    geom_histogram(aes(y = ..density.., fill = SU), color = "black",
                   linewidth = .1, bins = 50) +
    geom_density(data = filter(good_bad_grp_thetas, group %in% c("Con", "SU", "SU-Con")),
                 aes(x = estimate, fill = group), alpha = .5) +
    geom_hline(yintercept = 0) +
    geom_vline(data = filter(good_bad_mu_thetas, group %in% "SU-Con"),
               aes(xintercept = mu), color = "red2", linewidth = .25) +
    geom_vline(data = filter(good_bad_mu_thetas, group %in% "SU-Con"),
               aes(xintercept = lower), color = "red", linetype = "dashed", linewidth = .25) +
    geom_vline(data = filter(good_bad_mu_thetas, group %in% "SU-Con"),
               aes(xintercept = upper), color = "red", linetype = "dashed", linewidth = .25) +
    # scales
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05)), n.breaks = 3) +
    scale_fill_manual(values = c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#999999"),
                      limits = c("Con", "SU", "Dep", "Anx")) +
    # themes
    labs(x = "Estimate", y = "Density") +
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black"),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          legend.text = element_text(size = 6),
          legend.key.size = unit(.5, "lines"), legend.spacing.y = unit(.1, "lines"),
          legend.position = c(.2, .925), legend.direction = "horizontal",
          legend.background = element_rect(fill = "transparent", colour = "transparent"),
          legend.title = element_blank(),
          plot.margin = unit(c(.5, .5, .3, .1), "cm"),
          panel.spacing.x = unit(.5, "cm"),
          panel.spacing.y = unit(.5, "cm"),
          strip.background = element_rect(fill = "transparent", colour = "transparent"),
          # strip.text.x = element_blank(),
          # strip.text.y = element_blank(),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent")) +
    facet_rep_wrap(valence~comparison, scales = "free",
                   nrow = 2, ncol = 2) #+
    # facetted_pos_scales(
    #   list(
    #        valence == "good" & comparison == "Group Mean" ~
    #          scale_x_continuous(limits = c(.725, .925), expand = expansion(add = c(0, 0)),
    #                             breaks = seq(.75, .9, .05), labels = c(".75", ".80", ".85", ".90")),
    #        valence == "bad" & comparison == "Group Mean" ~
    #          scale_x_continuous(limits = c(.575, .775), expand = expansion(add = c(0, 0)),
    #                             breaks = seq(.6, .75, .05), labels = c(".60", ".65", ".70", ".75")),
    #        comparison != "Group Mean" ~
    #          scale_x_continuous(limits = c(-.1, .1), expand = expansion(add = c(0, 0)),
    #                             breaks = seq(-.1, .1, length.out = 3)))) + 
    # guides(fill = guide_legend(nrow = 2))

# save plot
tiff(here("1_TADS_Parents_PP", "Figs_Tables",
          model_name,
          paste("Betas", sample, "Posterior Distributions.tiff", sep = " ")),
     width = 14.6, height = 6, units = "cm", res = 300)

  grid.newpage()
  pushViewport(viewport(x = .5, y = .5, width = 1, height = 1))
  grid.draw(good_bad_group_prop_plot)
  grid.text(c("Group Means", "SU-Con", "Dep-Con", "Anx-Con"),
            x = c(.145, .395, .625, .865), y = .95,
            gp = gpar(fontsize = 9.5))
  
  # text
  grid.text(c("Good", "Bad"),
            x = rep(.99, 2), y = c(.85, .425), hjust = 1,
            gp = gpar(fontsize = 9.5))
  
dev.off()
```



## Posterior Distributions
```{r, eval = T}
# build plot
good_bad_group_prop_plot = good_bad_ind_prop %>% 
  ggplot(aes(x = estimate, fill = group_means)) +
    # geoms
    geom_histogram(aes(y = ..density..), color = "black", fill = "gray45",
                   linewidth = .1, bins = 50) +
    geom_density(data = good_bad_group_prop, aes(x = estimate, fill = group_means),
                 alpha = .5) +
    geom_hline(yintercept = 0) +
    geom_vline(data = good_bad_group_prop,
               aes(xintercept = mean), color = "red2", linewidth = .25) +
    geom_vline(data = good_bad_group_prop,
               aes(xintercept = lower), color = "red", linetype = "dashed", linewidth = .25) +
    geom_vline(data = good_bad_group_prop, 
               aes(xintercept = upper), color = "red", linetype = "dashed", linewidth = .25) +
    # scales
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult = c(0, .05)), n.breaks = 3) +
    scale_fill_manual(values = c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#999999"),
                      limits = c("Con", "SU", "Dep", "Anx")) +
    # themes
    labs(x = "Estimate", y = "Density") +
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black"),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          legend.text = element_text(size = 6),
          legend.key.size = unit(.5, "lines"), legend.spacing.y = unit(.1, "lines"),
          legend.position = c(.2, .925), legend.direction = "horizontal",
          legend.background = element_rect(fill = "transparent", colour = "transparent"),
          legend.title = element_blank(),
          plot.margin = unit(c(.5, .5, .3, .1), "cm"),
          panel.spacing.x = unit(.5, "cm"),
          panel.spacing.y = unit(.5, "cm"),
          strip.background = element_rect(fill = "transparent", colour = "transparent"),
          strip.text.x = element_blank(),
          strip.text.y = element_blank(),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent")) +
    facet_rep_wrap(valence~comparison, scales = "free",
                   nrow = 2, ncol = 4) +
    facetted_pos_scales(
      list(
           valence == "good" & comparison == "Group Mean" ~
             scale_x_continuous(limits = c(.725, .925), expand = expansion(add = c(0, 0)),
                                breaks = seq(.75, .9, .05), labels = c(".75", ".80", ".85", ".90")),
           valence == "bad" & comparison == "Group Mean" ~
             scale_x_continuous(limits = c(.575, .775), expand = expansion(add = c(0, 0)),
                                breaks = seq(.6, .75, .05), labels = c(".60", ".65", ".70", ".75")),
           comparison != "Group Mean" ~
             scale_x_continuous(limits = c(-.1, .1), expand = expansion(add = c(0, 0)),
                                breaks = seq(-.1, .1, length.out = 3)))) + 
    guides(fill = guide_legend(nrow = 2))

# save plot
tiff(here("1_TADS_Parents_PP", "Figs_Tables",
          model_name,
          paste("Betas", sample, "Posterior Distributions.tiff", sep = " ")),
     width = 14.6, height = 6, units = "cm", res = 300)

  grid.newpage()
  pushViewport(viewport(x = .5, y = .5, width = 1, height = 1))
  grid.draw(good_bad_group_prop_plot)
  grid.text(c("Group Means", "SU-Con", "Dep-Con", "Anx-Con"),
            x = c(.145, .395, .625, .865), y = .95,
            gp = gpar(fontsize = 9.5))
  
  # text
  grid.text(c("Good", "Bad"),
            x = rep(.99, 2), y = c(.85, .425), hjust = 1,
            gp = gpar(fontsize = 9.5))
  
dev.off()
```



# ---------------------------------------

# HERE

```{r, eval = F}
group_prop_plot = group_prop %>% 
    group_by(type) %>% 
    mutate(mu = mean(choice_proportion, na.rm = T)) %>% 
    # plot
    ggplot(aes(x = type, y = choice_proportion, fill = session)) +
      # geoms
      geom_crossbar(aes(y = mu, ymin = mu, ymax = mu), size = .5, fatten = 0) +
      geom_dotplot(binaxis = "y", stackdir = "center",
                   position = position_dodge(width = .8)) +
      geom_pointrange(aes(y = mu_session, ymin = lower, ymax = upper),
                      color = "red", size = .1,
                      position = position_dodge(width = .8)) +
      # scales
      scale_y_continuous(limits = c(0, 1), expand = c(.01, .01), breaks = seq(0, 1, .25)) +
      scale_fill_manual(values = c("gray25", "gray75"),
                        labels = c("Session 1", "Session 2")) +
      # themes
      labs(x = "Session", y = "Proportion of Plays") +
      coord_cartesian(clip = "off") +
      theme_classic() +
      theme(axis.text.x = element_text(color = "black", size = 10),
            axis.text.y = element_text(color = "black", size = 9),
            axis.title.x = element_blank(),
            axis.title.y = element_text(size = 10),
            plot.margin = unit(c(1.5,0,0,0), "lines"),
            legend.position = "none")


tiff(here("1_IGT_PP", "Figs_Tables", "Manuscript_Plots",
          "Summary_Abs_Reliability.tiff"),
     width = 7, height = 4, units = "cm", res = 300)

  grid.newpage()
  pushViewport(viewport(x = .5, y = .5, width = .9, height = .9))
  grid.draw(prop_abs_plot)
  
  # text
  grid.text(c("1", "2", "1", "2"),
            x = c(.3225, .475, .6975, .85), y = .85,
            gp = gpar(fontsize = 9.5))
  grid.text("Session",
            x = .59, y = .94,
            gp = gpar(fontsize = 9.5))
  grid.lines(x = c(.5,.68), y = .9)
  
dev.off()
```



```{r}
trial_choice_proportions = readRDS(here("1_IGT_PP", "Data", "2_Fitted",
                                        "Joint_ORL", "Joint_ORL_ppcs.rds"))
```



## Functions
```{r}
# MAKE A FANCY LABEL FOR PLOTS
estimate_CI_label = function(estimate, lower, upper){
  
  estimate = round(estimate,2)
  estimate_lab = paste(ifelse(sign(estimate)==1," ","-"), stri_pad_right(str_remove(abs(estimate), "^0+"),
                                                           width = 3, pad = "0"),sep="")
  lower = round(as.numeric(str_remove(lower, "\\(")),2)
  upper = round(as.numeric(str_remove(upper, "\\)")),2)
  
  lower_lab = paste(ifelse(sign(lower)==1,"","-"), stri_pad_right(str_remove(abs(lower), "^0+"),
                                                                  width = 3, pad = "0"),sep="")
  
  upper_lab = paste(ifelse(sign(upper)==1,"","-"), stri_pad_right(str_remove(abs(upper), "^0+"),
                                                                  width = 3, pad = "0"),sep="")
  estimate_CI = paste("=",estimate_lab," [",lower_lab,",",upper_lab,"]",sep="")
  
  return(estimate_CI)
}


#------------------------------------------------------------------------------
# USE SOFTMAX TO OBTAIN CHOICE PROBABILITIES - USED IN SIMULATIONS
softmax = function(values){
  return(exp(values) / sum(exp(values)))
}


#------------------------------------------------------------------------------
# SIMULATION FUNCTION
simulate_orl = function(parameter_mus, condition,
                        custom_seed = 20230928, n_iterations = 1000) {
  set.seed(seed = custom_seed)
  data = data.frame()
  
  # parameters for sim
  Arew = filter(parameter_mus, parameter == "Arew")[[condition]]
  Apun = filter(parameter_mus, parameter == "Apun")[[condition]]
  K = filter(parameter_mus, parameter == "K")[[condition]]
  betaF = filter(parameter_mus, parameter == "betaF")[[condition]]
  betaP = filter(parameter_mus, parameter == "betaP")[[condition]]
  
  for(i in 1:n_iterations){
    utility = rep(0,4)
    ev = rep(0,4)
    ef = rep(0,4)
    pers = rep(0,4)
    K_tr = 3^(K)-1
    
    ef_chosen = 0
    PEval = 0
    PEfreq = 0
    PEfreq_fic = rep(0,4)
    card_trial = rep(0,4)
    
    for(t in 1:120){
      outcome = outcomes$outcome[outcomes$trial == t]
      sign = outcomes$sign[outcomes$trial == t]
      card = outcomes$card[outcomes$trial == t]
      prob = softmax(c(utility[card], 0))
      curr_choice = sample(c(1,2), 1, prob = prob)
      
      if(curr_choice==1) {
        PEval = outcome - ev[card]
        PEfreq= -1*sign - ef[card]
        PEfreq_fic = -1*sign/3 - ef;
        ef_chosen = ef[card];
        
        if(outcome >= 0) {
          ef = ef + Apun * PEfreq_fic
          ef[card] = ef_chosen + Arew * PEfreq
          ev[card] = ev[card] + Arew * PEval
        } else {
          ef = ef + Arew * PEfreq_fic
          ef[card] = ef_chosen + Apun * PEfreq;
          ev[card] = ev[card] + Apun * PEval;
        }
        pers[card] = 1;
      }
      pers = pers / (1 + K_tr)
      
      utility = ev + ef * betaF + pers * betaP
      card_trial[card] = card_trial[card] + 1
      data = data.frame(simulation = condition,
                        iteration = i,
                        card = card,
                        trial = t,
                        card_trial = card_trial[card],
                        choice = curr_choice) %>% 
        bind_rows(data)
    }
  }
  data %>%
    return()
}


#------------------------------------------------------------------------------
# RUN AND CLEAN UP CORRELATIONS
run_cor = function(cur_data, s, cor_type, x_nam, y_nam){
  cor = boot.cor.bca(
    x = cur_data[[x_nam]], y = cur_data[[y_nam]],
    alternative = c("two.sided", "less", "greater"),
    null.hyp = NULL, conf.level = 0.95, type = NULL, R = 9999)
  return(data.frame(
    cor_type = cor_type,
    x = x_nam, y = y_nam,
    session = s,
    r = cor$Observed,
    CI = cor$Confidence.interval))
}
```



# ---------------------------------------
# Good/Bad Play Proportions
## Prep Data
```{r, eval = T}
# Recode choice data
choices = ifelse(stan_data$choice == 2, 0, ifelse(stan_data$choice == 1, 1, NA))

# Empty matrices
IDs = matrix(data = NA, nrow = 49, ncol = 2, dimnames = list(NULL, c("subjID", "id")))
good_proportions = matrix(data = NA, nrow = 49, ncol = 2)
bad_proportions = matrix(data = NA, nrow = 49, ncol = 2)

# Calculate proportions
for(i in 1:49){
  IDs[i,] = c(stan_data$subjIDs[i], i)
  for(s in 1:2){
    good_proportions[i,s] = mean(choices[i,,s][stan_data$card[i,,s] == 3 | stan_data$card[i,,s] == 4], na.rm = T)
    bad_proportions[i,s] = mean(choices[i,,s][stan_data$card[i,,s] == 1 | stan_data$card[i,,s] == 2], na.rm = T)
  }
}

choice_proportions = data.frame(ID = IDs[,"subjID"], id = IDs[,"id"],
                                good_1 = good_proportions[,1], good_2 = good_proportions[,2],
                                bad_1 = bad_proportions[,1], bad_2 = bad_proportions[,2]) %>% 
  pivot_longer(c("good_1", "good_2", "bad_1", "bad_2"), names_sep = "_",
               names_to = c("type", "session"),
               values_to = "choice_proportion") %>% 
  mutate(type = factor(type, levels = c("good", "bad"), labels = c("Good", "Bad"), ordered = T),
         session = factor(session, levels = c("1", "2"), labels = c("1", "2"), ordered = T)) %>% 
  group_by(type, session) %>% 
  mutate(lower = t.test(choice_proportion)$conf.int[1],
         upper = t.test(choice_proportion)$conf.int[2],
         mu_sess = mean(choice_proportion, na.rm = T))

(good_t = t.test(good_proportions[,2], good_proportions[,1], paired = T, alternative = "two.sided"))
(good_r = boot.cor.bca(x = good_proportions[,1][!is.na(good_proportions[,2])],
                       y = good_proportions[,2][!is.na(good_proportions[,2])],
                       null.hyp = NULL,
                       alternative = c("two.sided", "less", "greater"),
                       conf.level = 0.95, type = NULL, R = 9999))
good_r_info = data.frame(r = good_r$Observed,
                         CI = good_r$Confidence.interval) %>% 
  separate(col = "CI", into = c("lower", "upper"), sep = ",") %>% 
  mutate(lower = as.numeric(str_remove(lower, "\\(")), upper = as.numeric(str_remove(upper, "\\)")))

(bad_t = t.test(bad_proportions[,2], bad_proportions[,1], paired = T, alternative = "two.sided"))
(bad_r = boot.cor.bca(x = bad_proportions[,1][!is.na(bad_proportions[,2])],
                      y = bad_proportions[,2][!is.na(bad_proportions[,2])],
                      null.hyp = NULL,
                      alternative = c("two.sided", "less", "greater"),
                      conf.level = 0.95, type = NULL, R = 9999))
bad_r_info = data.frame(r = bad_r$Observed,
                         CI = bad_r$Confidence.interval) %>% 
  separate(col = "CI", into = c("lower", "upper"), sep = ",") %>% 
  mutate(lower = as.numeric(str_remove(lower, "\\(")), upper = as.numeric(str_remove(upper, "\\)")))

prop_rCIs = data.frame(type = factor(c("good", "bad"), levels = c("good", "bad"), labels = c("Good", "Bad"), ordered = T),
                       rCI = c(estimate_CI_label(good_r_info$r, good_r_info$lower, good_r_info$upper),
                               estimate_CI_label(bad_r_info$r, bad_r_info$lower, bad_r_info$upper)))

boot.cor.bca(x = as.numeric(good_proportions[,1]),
             y = as.numeric(bad_proportions[,1]),
             null.hyp = NULL,
             alternative = c("two.sided", "less", "greater"),
             conf.level = 0.95, type = NULL, R = 9999)

boot.cor.bca(x = as.numeric(good_proportions[,2][!is.na(good_proportions[,2])]),
             y = as.numeric(bad_proportions[,2][!is.na(bad_proportions[,2])]),
             null.hyp = NULL,
             alternative = c("two.sided", "less", "greater"),
             conf.level = 0.95, type = NULL, R = 9999)

boot.cor.bca(x = apply(good_proportions, 1, mean, na.rm = T),
             y = apply(bad_proportions, 1, mean, na.rm = T),
             null.hyp = NULL,
             alternative = c("two.sided", "less", "greater"),
             conf.level = 0.95, type = NULL, R = 9999)
```



## Absolute Reliability Plots
```{r, eval = F}


tiff(here("1_IGT_PP", "Figs_Tables", "Manuscript_Plots",
          "Summary_Abs_Reliability.tiff"),
     width = 7, height = 4, units = "cm", res = 300)

  grid.newpage()
  pushViewport(viewport(x = .5, y = .5, width = .9, height = .9))
  grid.draw(prop_abs_plot)
  
  # text
  grid.text(c("1", "2", "1", "2"),
            x = c(.3225, .475, .6975, .85), y = .85,
            gp = gpar(fontsize = 9.5))
  grid.text("Session",
            x = .59, y = .94,
            gp = gpar(fontsize = 9.5))
  grid.lines(x = c(.5,.68), y = .9)
  
dev.off()
```



## Relative Reliability Plots
```{r, eval = F}
tiff(here("1_IGT_PP", "Figs_Tables", "Manuscript_Plots",
          "Summary_Rel_Reliability.tiff"),
     width = 7, height = 3.5, units = "cm", res = 300)
  
  (prop_rel_plot = 
    choice_proportions %>% 
      pivot_wider(names_from = "session", values_from = "choice_proportion", names_prefix = "session_") %>% 
      ggplot(aes(x = session_1, y = session_2)) +
        # geoms
        geom_point(size = 1, shape = 21, color = "black", fill = "gray50") +
        geom_smooth(method = "lm", formula = "y ~ x", color = "black", se = F, size = .5,
                    fullrange = T) +
        geom_text_npc(data = prop_rCIs, aes(npcx = "right", npcy = "bottom",
                                            label = rCI), size = 2.25, vjust = 0) +
        geom_text_npc(aes(npcx = "right", npcy = "bottom"), label = expression(italic(r)),
                      size = 2.25, hjust = 21.25, vjust = 0) +
        # scales
        scale_x_continuous(limits = c(0, 1), expand = c(.01, .01), breaks = seq(0, 1, .25),
                           labels = c("0", ".25", ".50", ".75", "1")) +
        scale_y_continuous(limits = c(0, 1), expand = c(.01, .01), breaks = seq(0, 1, .25),
                           labels = c("0", ".25", ".50", ".75", "1")) +
        # themes
        labs(x = "Session 1", y = "Session 2") +
        coord_cartesian(clip = "off") +
        theme_classic() +
        theme(axis.text = element_text(color = "black"),
              text = element_text(color = "black", size = 10),
              panel.spacing.y = unit(-1, "lines"),
              strip.background = element_rect(color = "transparent", fill = NA),
              strip.text = element_text(vjust = -2),
              plot.margin = unit(c(-.5,0.1,0.1,0.1), "lines"),
              aspect.ratio = 1) +
        facet_rep_wrap(.~type, ncol = 2))
  
dev.off()
```



# ---------------------------------------
# PPC Plot
```{r, eval = F}
tiff(here("1_IGT_PP", "Figs_Tables", "Manuscript_Plots",
          "PPC.tiff"),
     width = 15, height = 7, units = "cm", res = 300)

  # simplify data
  trial_choice_proportions %>% 
    group_by(trial, deck, session) %>% 
    summarise(observed = mean(observed), mu = mean(mu),
              lower50 = mean(lower50), upper50 = mean(upper50),
              lower95 = mean(lower95), upper95 = mean(upper95)) %>%
    # plotting
    ggplot(aes(x = trial,
               group = trial)) +
    # geoms
    geom_linerange(aes(ymin = lower95, ymax = upper95),
                   linewidth = .35, color = "goldenrod3", alpha = .35) +
    geom_linerange(aes(ymin = lower50, ymax = upper50),
                   linewidth = .35, color = "goldenrod3") +
    geom_point(aes(y = mu, color = "Predicted", fill = "Predicted"),
               shape = 21, size = .75) +
    geom_point(aes(y = observed, color = "Observed", fill = "Observed"),
               shape = 21, size = .75) +
    # scales
    scale_y_continuous(limits = c(0,1),
                       breaks = seq(0,1,.25)) +
    scale_color_manual(name = "hello", values = c("Observed" = "black", "Predicted" = "goldenrod3")) +
    scale_fill_manual(name = "hello", values = c("Observed" = "black", "Predicted" = "white")) +
    # theme
    labs(x = "Trial", y = "Proportion Play") +
    theme_classic() +
    theme(axis.text = element_text(color = "black"),
          legend.title = element_blank(),
          legend.background = element_rect(fill = "transparent", colour = "transparent"),
          legend.position = c(.84,.59), 
          legend.spacing.x = unit(0, 'cm'),
          legend.spacing.y = unit(-.25, 'cm'),
          legend.text = element_text(size = 8),
          strip.background = element_blank(),
          panel.spacing.x = unit(-.5,"lines"),
          legend.key.size = unit(.25, "cm"),
          panel.spacing.y = unit(0,"lines")) +
    guides(color = guide_legend(override.aes = list(size = 1.25))) +
    facet_rep_grid(session~deck,
                   labeller = labeller(session = c("1" = "Session 1", "2" = "Session 2"),
                                       deck = c("A" = "Deck A", "B" = "Deck B",
                                                "C" = "Deck C", "D" = "Deck D")))
dev.off()
```



# ---------------------------------------
# Ind-Person PPC Plot
## Calculations
```{r}
N = stan_data$N
S = stan_data$S
C = 4
Trials = stan_data$T
size = 6
```



```{r, eval = F}
ind_choice_proportions = data.frame()

for(i in 1:N){
  for(s in 1:S){
    if(stan_data$Tsubj[i,s] > 0){
      for(c in 1:C){
        curr_data = ifelse(stan_data$choice[i,stan_data$card[i,,s] == c,s] == 2, 0, 1)
        curr_posterior = ifelse(orl_posteriors$choice_pred[,i,stan_data$card[i,,s] == c,s] == 2, 0, 1)
        for(k in 1:(30-(size-1))){
          ind_choice_proportions = data.frame(
            id = i,
            session = s,
            binC = median(k:(k+(size-1))),
            card = c,
            choice = mean(curr_data[k:(k+(size-1))]),
            prob_mean = mean(apply(curr_posterior[,k:(k+(size-1))], 1, mean)),
            prob_median = median(apply(curr_posterior[,k:(k+(size-1))], 1, mean)),
            lower95 = HDIofMCMC(apply(curr_posterior[,k:(k+(size-1))], 1, mean))[1],
            upper95 = HDIofMCMC(apply(curr_posterior[,k:(k+(size-1))], 1, mean))[2],
            lower50 = HDIofMCMC(apply(curr_posterior[,k:(k+(size-1))], 1, mean), credMass = .5)[1],
            upper50 = HDIofMCMC(apply(curr_posterior[,k:(k+(size-1))], 1, mean), credMass = .5)[2]
            ) %>% 
            bind_rows(ind_choice_proportions)
        }
      }
    }
  }
}
saveRDS(ind_choice_proportions, here("1_IGT_PP", "Data", "2_Fitted",
                                     "Joint_ORL", paste0("Joint_ORL_ind_", size,"trial_ppcs.rds")))
```



```{r}
ind_choice_proportions = readRDS(here("1_IGT_PP", "Data", "2_Fitted",
                                      "Joint_ORL", paste0("Joint_ORL_ind_", size,"trial_ppcs.rds")))
rm(list = c("N", "S", "C", "Trials", "size"))
```



## Plot 2050 & 2051
```{r, eval = F}
tiff(here("1_IGT_PP", "Figs_Tables", "Manuscript_Plots",
          "Individual_PPCs.tiff"),
     width = 15, height = 7, units = "cm", res = 300)

  # simplify data
  ind_choice_proportions %>% 
    left_join(data.frame(IDs)) %>% 
    filter(subjID == 2051 | subjID == 2050) %>% 
    mutate(id = paste0("ID #", subjID)) %>%
    select(everything(),
           prob = prob_mean, lower = lower95, upper = upper95,
           -c(prob_median, lower50, upper50)) %>% 
    pivot_wider(names_from = "session", values_from = c("prob", "choice", "lower", "upper")) %>%
    # plotting
    ggplot(aes(x = binC-2.5)) +
      # geoms
      geom_point(aes(y = prob_1, shape = "Session 1 Predicted",
                     color = "Session 1 Predicted", fill = "Session 1 Predicted"),
                 size = .75) +
      geom_point(aes(y = choice_1, shape = "Session 1 Observed",
                     color = "Session 1 Observed", fill = "Session 1 Observed"),
                 size = .75) +
      geom_point(aes(y = prob_2, shape = "Session 2 Predicted",
                     color = "Session 2 Predicted", fill = "Session 2 Predicted"),
                 size = .75) +
      geom_point(aes(y = choice_2, shape = "Session 2 Observed",
                     color = "Session 2 Observed", fill = "Session 2 Observed"),
                 size = .75) +
      # scales
      scale_x_continuous(limits = c(0, 25), expand = c(.0175, .0175), breaks = seq(0, 25, 5)) +
      scale_y_continuous(limits = c(0, 1), expand = c(.015, .015), breaks = seq(0, 1, .25),
                         labels = c("0", ".25", ".50", ".75", "1")) +
      scale_color_manual(name = "hello",
                         values = c("Session 1 Observed" = "black",
                                    "Session 1 Predicted" = "goldenrod3",
                                    "Session 2 Observed" = "black",
                                    "Session 2 Predicted" = "goldenrod3")) +
      scale_fill_manual(name = "hello",
                        values = c("Session 1 Observed" = "black",
                                   "Session 1 Predicted" = "white",
                                   "Session 2 Observed" = "black",
                                   "Session 2 Predicted" = "white")) +
      scale_shape_manual(name = "hello",
                         values = c("Session 1 Observed" = 22,
                                    "Session 1 Predicted" = 22,
                                    "Session 2 Observed" = 23,
                                    "Session 2 Predicted" = 23)) +
      # theme
      labs(x = "6-Trial Bin", y = "Proportion Play") +
      theme_classic() +
      theme(axis.text = element_text(color = "black"),
            strip.background = element_blank(),
            panel.spacing.x = unit(-.5,"lines"),
            legend.title = element_blank(),
            legend.background = element_rect(fill = "transparent", colour = "transparent"),
            legend.position = c(.855,.6175),
            # legend.position = "top", 
            legend.spacing.x = unit(0, 'cm'),
            legend.spacing.y = unit(-.25, 'cm'),
            legend.text = element_text(size = 6.25),
            legend.key.size = unit(.2, "cm"),
            panel.spacing.y = unit(0,"lines")) +
      guides(color = guide_legend(override.aes = list(size = 1.25))) +
      facet_rep_grid(id~card,
                     labeller = labeller(card = c("1" = "Deck A", "2" = "Deck B",
                                                  "3" = "Deck C", "4" = "Deck D")))
dev.off()
```



## Plot 2050
```{r, eval = F}
tiff(here("1_IGT_PP", "Figs_Tables", "Manuscript_Plots",
          "2050_PPCs.tiff"),
     width = 15, height = 7, units = "cm", res = 300)

  # simplify data
  ind_choice_proportions %>% 
    left_join(data.frame(IDs)) %>% 
    filter(subjID == 2050) %>% 
    mutate(id = paste0("ID #", subjID),
           deck = chartr("1234", "ABCD", as.character(card))) %>%
    select(everything(),
           mu = prob_mean, observed = choice,
           lower = lower95, upper = upper95,
           -c(prob_median, lower50, upper50)) %>% 
    # plotting
    ggplot(aes(x = binC-2.5)) +
      # geoms
      geom_point(aes(y = mu, color = "Predicted", fill = "Predicted"),
                 shape = 21, size = .75) +
      geom_point(aes(y = observed, color = "Observed", fill = "Observed"),
                 shape = 21, size = .75) +
      # scales
      scale_x_continuous(limits = c(0,25), breaks = seq(0,25,5)) +
      scale_y_continuous(limits = c(0,1), breaks = seq(0,1,.25)) +
      coord_cartesian(ylim=c(0,1),expand=F,clip="off")+ # added clip = "off"
      scale_color_manual(name = "hello", values = c("Observed" = "black", "Predicted" = "goldenrod3")) +
      scale_fill_manual(name = "hello", values = c("Observed" = "black", "Predicted" = "white")) +
      # theme
      labs(x = "6-Trial Bin", y = "Proportion Play") +
      theme_classic() +
      theme(axis.text = element_text(color = "black"),
            legend.title = element_blank(),
            legend.background = element_rect(fill = "transparent", colour = "transparent"),
            legend.position = c(.84,.59), 
            legend.spacing.x = unit(0, 'cm'),
            legend.spacing.y = unit(-.25, 'cm'),
            legend.text = element_text(size = 8),
            strip.background = element_blank(),
            panel.spacing.x = unit(-.5,"lines"),
            legend.key.size = unit(.25, "cm"),
            panel.spacing.y = unit(0,"lines")) +
      guides(color = guide_legend(override.aes = list(size = 1.25))) +
      facet_rep_grid(session~deck,
                     labeller = labeller(session = c("1" = "Session 1", "2" = "Session 2"),
                                         deck = c("A" = "Deck A", "B" = "Deck B",
                                                  "C" = "Deck C", "D" = "Deck D")))
dev.off()
```



## Plot 2051
```{r, eval = F}
tiff(here("1_IGT_PP", "Figs_Tables", "Manuscript_Plots",
          "2051_PPCs.tiff"),
     width = 15, height = 7, units = "cm", res = 300)

  # simplify data
  ind_choice_proportions %>% 
    left_join(data.frame(IDs)) %>% 
    filter(subjID == 2051) %>% 
    mutate(id = paste0("ID #", subjID),
           deck = chartr("1234", "ABCD", as.character(card))) %>%
    select(everything(),
           mu = prob_mean, observed = choice,
           lower = lower95, upper = upper95,
           -c(prob_median, lower50, upper50)) %>% 
    # plotting
    ggplot(aes(x = binC-2.5)) +
      # geoms
      geom_point(aes(y = mu, color = "Predicted", fill = "Predicted"),
                 shape = 21, size = .75) +
      geom_point(aes(y = observed, color = "Observed", fill = "Observed"),
                 shape = 21, size = .75) +
      # scales
      scale_x_continuous(limits = c(0,25), breaks = seq(0,25,5)) +
      scale_y_continuous(limits = c(0,1), breaks = seq(0,1,.25)) +
      coord_cartesian(ylim=c(0,1),expand=F,clip="off")+ # added clip = "off"
      scale_color_manual(name = "hello", values = c("Observed" = "black", "Predicted" = "goldenrod3")) +
      scale_fill_manual(name = "hello", values = c("Observed" = "black", "Predicted" = "white")) +
      # theme
      labs(x = "6-Trial Bin", y = "Proportion Play") +
      theme_classic() +
      theme(axis.text = element_text(color = "black"),
            legend.title = element_blank(),
            legend.background = element_rect(fill = "transparent", colour = "transparent"),
            legend.position = c(.84,.59), 
            legend.spacing.x = unit(0, 'cm'),
            legend.spacing.y = unit(-.25, 'cm'),
            legend.text = element_text(size = 8),
            strip.background = element_blank(),
            panel.spacing.x = unit(-.5,"lines"),
            legend.key.size = unit(.25, "cm"),
            panel.spacing.y = unit(0,"lines")) +
      guides(color = guide_legend(override.aes = list(size = 1.25))) +
      facet_rep_grid(session~deck,
                     labeller = labeller(session = c("1" = "Session 1", "2" = "Session 2"),
                                         deck = c("A" = "Deck A", "B" = "Deck B",
                                                  "C" = "Deck C", "D" = "Deck D")))
dev.off()
```



## Plot All
```{r, eval = F}
tiff(here("1_IGT_PP", "Figs_Tables", "Manuscript_Plots",
          "ALL_Individual_PPCs.tiff"),
     width = 15, height = 7*25, units = "cm", res = 300)

  # simplify data
  ind_choice_proportions %>% 
    left_join(data.frame(IDs)) %>% 
    mutate(id = paste0("ID #", subjID)) %>%
    select(everything(),
           prob = prob_mean, lower = lower95, upper = upper95,
           -c(prob_median, lower50, upper50)) %>% 
    pivot_wider(names_from = "session", values_from = c("prob", "choice", "lower", "upper")) %>%
    # plotting
    ggplot(aes(x = binC-2.5)) +
      # geoms
      # geom_linerange(aes(ymin = lower_1, ymax = upper_1), show.legend = F,
      #                linewidth = .35, color = "goldenrod3") +
      # geom_linerange(aes(ymin = lower_2, ymax = upper_2), show.legend = F,
      #                linewidth = .35, color = "goldenrod3") +
      geom_point(aes(y = prob_1, shape = "Session 1 Predicted",
                     color = "Session 1 Predicted", fill = "Session 1 Predicted"),
                 size = .75) +
      geom_point(aes(y = choice_1, shape = "Session 1 Observed",
                     color = "Session 1 Observed", fill = "Session 1 Observed"),
                 size = .75) +
      geom_point(aes(y = prob_2, shape = "Session 2 Predicted",
                     color = "Session 2 Predicted", fill = "Session 2 Predicted"),
                 size = .75) +
      geom_point(aes(y = choice_2, shape = "Session 2 Observed",
                     color = "Session 2 Observed", fill = "Session 2 Observed"),
                 size = .75) +
      # scales
      scale_x_continuous(limits = c(0, 25), expand = c(.0175, .0175), breaks = seq(0, 25, 5)) +
      scale_y_continuous(limits = c(0, 1), expand = c(.015, .015), breaks = seq(0, 1, .25),
                         labels = c("0", ".25", ".50", ".75", "1")) +
      scale_color_manual(name = "hello",
                         values = c("Session 1 Observed" = "black",
                                    "Session 1 Predicted" = "goldenrod3",
                                    "Session 2 Observed" = "black",
                                    "Session 2 Predicted" = "goldenrod3")) +
      scale_fill_manual(name = "hello",
                        values = c("Session 1 Observed" = "black",
                                   "Session 1 Predicted" = "white",
                                   "Session 2 Observed" = "black",
                                   "Session 2 Predicted" = "white")) +
      scale_shape_manual(name = "hello",
                         values = c("Session 1 Observed" = 22,
                                    "Session 1 Predicted" = 22,
                                    "Session 2 Observed" = 23,
                                    "Session 2 Predicted" = 23)) +
      # theme
      labs(x = "6-Trial Bin", y = "Proportion Play") +
      theme_classic() +
      theme(axis.text = element_text(color = "black"),
            strip.background = element_blank(),
            panel.spacing.x = unit(-.5,"lines"),
            legend.title = element_blank(),
            legend.background = element_rect(fill = "transparent", colour = "transparent"),
            legend.position = c(.855,.6175),
            # legend.position = "top", 
            legend.spacing.x = unit(0, 'cm'),
            legend.spacing.y = unit(-.25, 'cm'),
            legend.text = element_text(size = 6.25),
            legend.key.size = unit(.2, "cm"),
            panel.spacing.y = unit(0,"lines")) +
      guides(color = guide_legend(override.aes = list(size = 1.25))) +
      facet_rep_grid(id~card,
                     labeller = labeller(card = c("1" = "Deck A", "2" = "Deck B",
                                                  "3" = "Deck C", "4" = "Deck D")))
dev.off()
```



# ---------------------------------------
# ORL Parameters
## Absolute Reliability
```{r, eval = F}
orl_abs_data = bind_rows(data.frame(parameter = "Arew", session = orl_posteriors$mu_Arew),
                         data.frame(parameter = "Apun", session = orl_posteriors$mu_Apun),
                         data.frame(parameter = "betaF", session = orl_posteriors$mu_betaF),
                         data.frame(parameter = "betaP", session = orl_posteriors$mu_betaP),
                         data.frame(parameter = "K", session = orl_posteriors$mu_K)) %>% 
  mutate(session.diff = session.2 - session.1) %>% 
  pivot_longer(starts_with("session"),
               names_to = "session", values_to = "estimate", names_prefix = "session.") %>% 
  group_by(parameter, session) %>% 
  mutate(mu = mean(estimate),
         lower50 = HDIofMCMC(estimate, credMass = .5)[1],
         upper50 = HDIofMCMC(estimate, credMass = .5)[2],
         lower95 = HDIofMCMC(estimate)[1],
         upper95 = HDIofMCMC(estimate)[2],
         parameter = factor(parameter, ordered = T,
                            levels = c("Arew", "Apun", "betaF", "betaP", "K")),
         parameter_lab = factor(parameter,
                                levels = c("Arew", "Apun", "betaF", "betaP", "K"),
                                labels = c(expression(paste(italic(A),"+",sep="")),
                                           expression(paste(italic(A),"-",sep="")),
                                           expression(paste("\u03B2",italic(f),sep="")),
                                           expression(paste("\u03B2",italic(p),sep="")),
                                           expression(italic(K)))),
         parameter_lab = case_when(session == "diff" ~ parameter_lab, T ~ NA))

orl_abs_scales =
  list(parameter == "Arew" & session != "diff" ~
         scale_x_continuous(limits = c(0, .3), expand = expansion(add = c(0, 0)),
                            breaks = seq(0, .3, .15), labels = c("0", ".15", ".3")),
       parameter == "Arew" & session == "diff" ~
         scale_x_continuous(limits = c(-.3, .3), expand = expansion(add = c(0, 0)),
                            breaks = seq(-.3, .3, .3), labels = c("-.3", "0", ".3")),
       
       parameter == "Apun" & session != "diff" ~
         scale_x_continuous(limits = c(.05, .15), expand = expansion(add = c(0, 0)),
                            breaks = seq(.05, .15, .05), labels = c(".05", ".1", ".15")),
       parameter == "Apun" & session == "diff" ~
         scale_x_continuous(limits = c(-.05, .05), expand = expansion(add = c(0, 0)),
                            breaks = seq(-.05, .05, .05), labels = c("-.05", "0", ".05")),
       
       parameter == "betaF" & session != "diff" ~
         scale_x_continuous(limits = c(0, 6), expand = expansion(add = c(0, 0)),
                            breaks = seq(0, 6, 3), labels = c(".05", ".1", ".15")),
       parameter == "betaF" & session == "diff" ~
         scale_x_continuous(limits = c(-3, 3), expand = expansion(add = c(0, 0)),
                            breaks = seq(-3, 3, 3), labels = c("-3", "0", "3")),
       
       parameter == "betaP" & session != "diff" ~
         scale_x_continuous(limits = c(0, 3), expand = expansion(add = c(0, 0)),
                            breaks = seq(0, 3, 1.5), labels = c("0", "1.5", "3")),
       parameter == "betaP" & session == "diff" ~
         scale_x_continuous(limits = c(-2, 2), expand = expansion(add = c(0, 0)),
                            breaks = seq(-2, 2, 2), labels = c("-2", "0", "2")),
       
       parameter == "K" & session != "diff" ~
         scale_x_continuous(limits = c(0, .3), expand = expansion(add = c(0, 0)),
                            breaks = seq(0, .3, .15), labels = c("0", ".15", ".3")),
       parameter == "K" & session == "diff" ~
         scale_x_continuous(limits = c(-.1, .1), expand = expansion(add = c(0, 0)),
                            breaks = seq(-.1, .1, .1), labels = c("-.1", "0", ".1")))
```



```{r, eval = F}
orl_abs_plot = orl_abs_data %>% 
  ggplot(aes(x = estimate)) +
    # geoms
    geom_histogram(aes(y = ..density..), color = "black", fill = "gray45",
                   linewidth = .1, bins = 50) +
  
    geom_hline(yintercept = 0) +
    geom_vline(aes(xintercept = mu), color = "red2", linewidth = .25) +
    geom_vline(aes(xintercept = lower95), color = "red", linetype = "dashed", linewidth = .25) +
    geom_vline(aes(xintercept = upper95), color = "red", linetype = "dashed", linewidth = .25) +
    # scales
    scale_y_continuous(limits = c(0,NA), expand = c(0,0), n.breaks = 3) +
    # themes
    labs(x = "Estimate", y = "Density") +
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black"),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          plot.margin = unit(c(.5, .5, .3, .1), "cm"),
          panel.spacing.x = unit(.5, "cm"),
          panel.spacing.y = unit(0, "cm"),
          strip.background = element_rect(fill = "transparent", colour = "transparent"),
          strip.text.x = element_blank(),
          strip.text.y = element_blank(),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent")) +
    facet_rep_wrap(parameter~session, scales = "free",
                   nrow = 5, ncol = 3) +
    facetted_pos_scales(x = orl_abs_scales)
```



```{r, eval = F}
tiff(here("1_IGT_PP", "Figs_Tables", "Manuscript_Plots",
          "ORL_Abs_Reliability.tiff"),
     width = 7, height = 10, units = "cm", res = 300)

  grid.newpage()
  pushViewport(viewport(x = .5, y = .5, width = 1, height = 1))
  grid.draw(orl_abs_plot)
  
  # text
  grid.text(c("Session 1", "Session 2", " Session 2-1"),
            x = c(.2, .515, .81), y = .98,
            gp = gpar(fontsize = 9.5))
  grid.text(c(expression(paste(italic(A),"+",sep="")),
              expression(paste(italic(A),"-",sep="")),
              expression(paste("\u03B2",italic(f),sep="")),
              expression(paste("\u03B2",italic(p),sep="")),
              expression(italic(K))),
            x = rep(.93, 5), y = c(.89, .725, .55, .37, .195),
            gp = gpar(fontsize = 9.5))
  
dev.off()
```



## Relative Reliability
```{r, eval = F}
tiff(here("1_IGT_PP", "Figs_Tables", "Manuscript_Plots",
          "ORL_Rel_Reliability.tiff"),
     width = 14.6, height = 4, units = "cm", res = 300)

  bind_rows(data.frame(parameter = "Arew", r = orl_posteriors$R_Arew[,2,1]),
            data.frame(parameter = "Apun", r = orl_posteriors$R_Apun[,2,1]),
            data.frame(parameter = "betaF", r = orl_posteriors$R_betaF[,2,1]),
            data.frame(parameter = "betaP", r = orl_posteriors$R_betaP[,2,1]),
            data.frame(parameter = "K", r = orl_posteriors$R_K[,2,1])) %>% 
    mutate(parameter = factor(parameter,
                              levels = c("Arew", "Apun", "betaF", "betaP", "K"),
                              labels = c(expression(paste(italic(A),"+",sep="")),
                                         expression(paste(italic(A),"-",sep="")),
                                         expression(paste("\u03B2",italic(f),sep="")),
                                         expression(paste("\u03B2",italic(p),sep="")),
                                         expression(italic(K))))) %>% 
    group_by(parameter) %>% 
    mutate(mu_r = mean(r),
           estimate_lab = paste("r=", ifelse(sign(round(mu_r,2))==1," ","-"), stri_pad_right(str_remove(abs(round(mu_r,2)), "^0+"),
                                                                                             width = 3, pad = "0"),sep=""),
           lower = HDIofMCMC(r)[1], upper = HDIofMCMC(r)[2],
           below_0 = paste0(round(mean(r<0)*100), "% < 0"), above_0 = paste0(round(mean(r>0)*100), "% > 0"),
           height_ci = max(density(r)$x)*.025, height_m = max(density(r)$x)*.25) %>% 
    ggplot(aes(x = r)) +
      # geoms
      geom_histogram(aes(y = ..density..), color = "black", fill = "gray45",
                     linewidth = .1, bins = 50) +
      geom_text_npc(aes(npcx = "left", npcy = "top", label = below_0),
                    size = 2, vjust = -1.43) +
      geom_text_npc(aes(npcx = "right", npcy = "top", label = above_0),
                    size = 2, vjust = -1.43) +
      geom_text(aes(x = -.925, y = height_m, label = estimate_lab),
                    size = 2) +
      geom_hline(yintercept = 0) +
      geom_vline(aes(xintercept = mu_r), color = "red2", linewidth = .4) +
      geom_errorbarh(aes(xmin = lower, xmax = upper,
                         y = height_ci),
                         color = "red", linewidth = .4) +
      # scales
      scale_x_continuous(limits = c(-1,1), expand = c(0,0), breaks = seq(-1,1,.5),
                         labels = c("-1","-.5","0",".5", "1")) +
      scale_y_continuous(limits = c(0,NA), expand = c(0,0), n.breaks = 3) +
      # themes
      labs(x = "Reliability Coefficient", y = "Density") +
      coord_cartesian(clip = "off") +
      theme_classic() +
      theme(axis.text.x = element_text(color = "black"),
            axis.ticks.x = element_line(color = "black"),
            axis.line.x = element_line(color = "transparent"),
            axis.text.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.line.y = element_blank(),
            plot.margin = unit(c(.1, .3, .1, .3), "cm"),
            panel.spacing = unit(.25, "cm"),
            strip.background = element_rect(fill = "transparent", colour = "transparent"),
            strip.text.x = element_text(size = 12, vjust = 1.5),
            strip.text.y = element_blank(),
            panel.background = element_rect(fill = "transparent", colour = "transparent"),
            plot.background = element_rect(fill = "transparent", color = "transparent")) +
      facet_rep_grid(.~parameter, scales = "free",
                     labeller = label_parsed)
dev.off()
```



# ---------------------------------------
# Prop/ORL/Self-Report Correlations
## Prep Data
```{r}
IDs = matrix(data = NA, nrow = 49, ncol = 2, dimnames = list(NULL, c("subjID", "id")))
temp_good = matrix(data = NA, nrow = 49, ncol = 1)
temp_bad = matrix(data = NA, nrow = 49, ncol = 1)

for(i in 1:49){
  temp_good[i] = mean(choices[i,,][stan_data$card[i,,] == 3 | stan_data$card[i,,] == 4], na.rm = T)
  temp_bad[i] = mean(choices[i,,][stan_data$card[i,,] == 1 | stan_data$card[i,,] == 2], na.rm = T)
}
```


```{r}
ch_prop_sess = choice_proportions %>%
  pivot_wider(names_from = "type", values_from = "choice_proportion") %>% 
  mutate(session = as.numeric(session))
ch_prop_avg = ch_prop_sess %>% 
  group_by(ID) %>% 
  reframe(Good = mean(Good, na.rm = T), Bad = mean(Bad, na.rm = T))

orl_parameters = data.frame(ID = stan_data$subjIDs,
                            Arew = apply(orl_posteriors$Arew, c(2,3), mean),
                            Apun = apply(orl_posteriors$Apun, c(2,3), mean),
                            betaF = apply(orl_posteriors$betaF, c(2,3), mean),
                            betaP = apply(orl_posteriors$betaP, c(2,3), mean),
                            K = apply(orl_posteriors$K, c(2,3), mean),
                            Arew.0 = apply(orl_posteriors$Arew, 2, mean),
                            Apun.0 = apply(orl_posteriors$Apun, 2, mean),
                            betaF.0 = apply(orl_posteriors$betaF, 2, mean),
                            betaP.0 = apply(orl_posteriors$betaP, 2, mean),
                            K.0 = apply(orl_posteriors$K, 2, mean)) %>% 
  pivot_longer(starts_with(c("Arew", "Apun", "betaF", "betaP", "K")),
               names_to = c("parameter", "session"), values_to = "estimate",
               names_sep = "\\.", names_transform = list(session = as.numeric)) %>% 
  pivot_wider(names_from = "parameter", values_from = "estimate") %>% 
  mutate(ratio = Apun/Arew)

session1_session2 = self_report %>% 
  pivot_wider(names_from = "scale", values_from = "score") %>% 
  left_join(orl_parameters) %>% left_join(ch_prop_sess)
averages = self_report %>% 
  group_by(ID, scale) %>% 
  reframe(score = mean(score, na.rm = T), session = 0) %>% 
  pivot_wider(names_from = "scale", values_from = "score") %>% 
  left_join(orl_parameters) %>% left_join(ch_prop_avg)

combined = bind_rows(session1_session2, averages)
```



```{r}
set.seed(20230320)

# RUN SELF-REPORT/PLAY PROPORTION CORRELATIONS
SR_prop_correlations = data.frame()

for(s in unique(combined$session)){
  for(scale in unique(self_report$scale)){
    for(prop in c("Good", "Bad")){
      cur_data = combined %>% 
        filter(session == s) %>% 
        select(ID, all_of(scale), all_of(prop)) %>% 
        na.omit()
      
      if(nrow(cur_data)!=0){
        SR_prop_correlations = run_cor(cur_data, s, "SR-Prop", scale, prop) %>% 
          bind_rows(SR_prop_correlations)
      }
    }
  }
}

# RUN SELF-REPORT/ORL CORRELATIONS
SR_ORL_correlations = data.frame()

for(s in unique(combined$session)){
  for(scale in unique(self_report$scale)){
    for(parameter in c("Arew", "Apun", "betaF", "betaP", "K")){
      cur_data = combined %>% 
        filter(session == s) %>% 
        select(ID, all_of(scale), all_of(parameter)) %>% 
        na.omit()
      
      if(nrow(cur_data)!=0){
        SR_ORL_correlations = run_cor(cur_data, s, "SR-ORL", scale, parameter) %>% 
          bind_rows(SR_ORL_correlations)
      }
    }
  }
}

# RUN Play Proportion/ORL CORRELATIONS
prop_ORL_correlations = data.frame()

for(s in unique(combined$session)){
  for(prop in c("Good", "Bad")){
    for(parameter in c("Arew", "Apun", "betaF", "betaP", "K")){
      cur_data = combined %>% 
        filter(session == s) %>% 
        select(ID, all_of(prop), all_of(parameter)) %>% 
        na.omit()
      
      if(nrow(cur_data)!=0){
        prop_ORL_correlations = run_cor(cur_data, s, "ORL-Prop", parameter, prop) %>% 
          bind_rows(prop_ORL_correlations)
      }
    }
  }
}

correlations = bind_rows(SR_prop_correlations,
                         SR_ORL_correlations,
                         prop_ORL_correlations) %>% 
  separate(col = "CI", into = c("lower", "upper"), sep = ",") %>% 
  mutate(lower = as.numeric(str_remove(lower, "\\(")),
         upper = as.numeric(str_remove(upper, "\\)")),
         sig = case_when(lower < 0 & upper < 0 ~ "*",
                         lower > 0 & upper > 0 ~ "*",
                         lower < 0 & upper < .01 ~ "#",
                         lower > .01 & upper > 0 ~ "#",
                         T ~ ""))

saveRDS(correlations, here("1_IGT_PP", "Data", "2_Fitted",
                           "Joint_ORL", paste0("Joint_ORL_correlations.rds")))
```



## Save Correlations
```{r}
correlations = readRDS(here("1_IGT_PP", "Data", "2_Fitted",
                            "Joint_ORL", paste0("Joint_ORL_correlations.rds")))

correlations %>% 
  mutate(# MAKE NICE LABEL
         estimate = round(r,2),
         estimate_lab = paste(ifelse(sign(estimate)==1," ","-"), stri_pad_right(str_remove(abs(estimate), "^0+"),
                                                                                width = 3, pad = "0"),sep=""),
         lower = round(as.numeric(str_remove(lower, "\\(")),2),
         upper = round(as.numeric(str_remove(upper, "\\)")),2),
         
         lower_lab = paste(ifelse(sign(lower)==1,"","-"), stri_pad_right(str_remove(abs(lower), "^0+"),
                                                                         width = 3, pad = "0"),sep=""),
         
         upper_lab = paste(ifelse(sign(upper)==1,"","-"), stri_pad_right(str_remove(abs(upper), "^0+"),
                                                                         width = 3, pad = "0"),sep=""),
         lower_lab = case_when(lower_lab == "-000" ~ "-.00", T ~ lower_lab),
         upper_lab = case_when(upper_lab == "-000" ~ "-.00", T ~ upper_lab),
         estimate_lab = case_when(estimate_lab == "-000" ~ "-.00", T ~ estimate_lab),
         estimate_CI = paste(estimate_lab," [",lower_lab,",",upper_lab,"]",sep=""),
         # SORTING
         SR_sort = case_when(x == "bastot" ~ 1, x == "basdrive" ~ 2, x == "basfunsk" ~ 3, 
                             x == "basrewres" ~ 4, x == "bis" ~ 5, x == "panas_pa" ~ 6, 
                             x == "panas_na" ~ 7, x == "masqGDA" ~ 8, x == "masqAA" ~ 9, 
                             x == "masqGDD" ~ 10, x == "masqAD" ~ 11, x == "shaps_tot" ~ 12,
                             x == "prdep_tot" ~ 13)) %>% 
  write.csv(here("1_IGT_PP", "Data", "2_Fitted",
                 "Joint_ORL", paste0("Joint_ORL_correlations.csv")))
```



# ---------------------------------------
# Simulate ORL Parameters
## Prep Inputs for Simulations
```{r, eval = F}
# PREP TASK-RELATED INPUTS
cards = data.frame(card = stan_data$card[1,,1]) %>%
  mutate(trial = 1:n()) %>% 
  group_by(card) %>% 
  mutate(card_trial = 1:n())

outcomes = read.csv(here("1_IGT_PP", "Data", "0_Raw", "outcomes.csv")) %>% 
  mutate(card_trial = 1:n()) %>% 
  pivot_longer(starts_with("Deck"), names_to = "card",
               values_to = "outcome", names_prefix = "Deck_") %>% 
  mutate(card = case_when(card == "A" ~ 1, card == "B" ~ 2,
                          card == "C" ~ 3, card == "D" ~ 4),
         sign = sign(outcome),
         outcome = outcome / 100) %>% 
  left_join(cards) %>% na.omit()

#------------------------------------------------------------------------------
# PARAMETER VALUES FOR SIMULATION
parameter_mus = data.frame(Arew = orl_posteriors$mu_Arew,
                           Apun = orl_posteriors$mu_Apun,
                           K = orl_posteriors$mu_K,
                           betaF = orl_posteriors$mu_betaF,
                           betaP = orl_posteriors$mu_betaP) %>%
  pivot_longer(everything(), names_to = c("parameter", "session"), names_sep = "\\.",
               values_to = "estimate") %>%
  group_by(parameter, session) %>%
  reframe(mu = mean(estimate)) %>%
  pivot_wider(names_from = "session", values_from = "mu", names_prefix = "session_") %>%
  mutate(# Parameter values of observed changes in Arew & betaP with interaction
         BL = session_1,
         me_betaP = case_when(parameter == "Arew" ~ session_1, T ~ session_2),
         me_Arew = case_when(parameter == "betaP" ~ session_1, T ~ session_2),
         int = session_2,
         # Overall mu parameter values
         mu = (session_1 + session_2) / 2,
         # Parameter values of manipulating Arew
         rew_HI = case_when(parameter == "Arew" ~ mu*4, T ~ mu),
         rew_LO = case_when(parameter == "Arew" ~ mu/4, T ~ mu),
         # Parameter values of manipulating Apun
         pun_HI = case_when(parameter == "Apun" ~ mu*4, T ~ mu),
         pun_LO = case_when(parameter == "Apun" ~ mu/4, T ~ mu),
         # Parameter values of manipulating betaP
         betaP_HI = case_when(parameter == "betaP" ~ mu*4, T ~ mu),
         betaP_LO = case_when(parameter == "betaP" ~ mu/4, T ~ mu),
         # Parameter values of manipulating betaF
         betaF_HI = case_when(parameter == "betaF" ~ mu*4, T ~ mu),
         betaF_LO = case_when(parameter == "betaF" ~ mu/4, T ~ mu),
         # Parameter values of manipulating K
         K_HI = case_when(parameter == "K" ~ mu*4, T ~ mu),
         K_LO = case_when(parameter == "K" ~ mu/4, T ~ mu),
         # Parameter values of manipulating Arew & betaP
         rew_LO_betaP_HI = case_when(parameter == "betaP" ~ mu*4,
                                     parameter == "Arew" ~ mu/4,
                                     T ~ mu))
#------------------------------------------------------------------------------
# RUN SIMULATIONS
# Simulation of observed changes in Arew & betaP with interaction
databased_simulations = bind_rows(simulate_orl(parameter_mus, "BL"),
                                   simulate_orl(parameter_mus, "me_betaP"),
                                   simulate_orl(parameter_mus, "me_Arew"),
                                   simulate_orl(parameter_mus, "int"))
saveRDS(databased_simulations, here("1_IGT_PP", "Data", "2_Fitted", "Joint_ORL",
                                    "databased_simulations.rds"))
# Simulation of overall mus
mu_simultations = simulate_orl(parameter_mus, "mu")
saveRDS(mu_simultations, here("1_IGT_PP", "Data", "2_Fitted", "Joint_ORL",
                              "mu_simultations.rds"))
# Simulation of changes in Arew & betaP with interaction
Arew_betaP_simulations = bind_rows(mu_simultations,
                                   simulate_orl(parameter_mus, "rew_LO"),
                                   simulate_orl(parameter_mus, "betaP_HI"),
                                   simulate_orl(parameter_mus, "rew_LO_betaP_HI"))
saveRDS(Arew_betaP_simulations, here("1_IGT_PP", "Data", "2_Fitted", "Joint_ORL",
                                     "Arew_betaP_simulations.rds"))
# Simulation of manipulating Arew
Arew_simulations = bind_rows(mu_simultations,
                             simulate_orl(parameter_mus, "rew_HI"),
                             simulate_orl(parameter_mus, "rew_LO"))
saveRDS(Arew_simulations, here("1_IGT_PP", "Data", "2_Fitted", "Joint_ORL",
                               "Arew_simulations.rds"))
# Simulation of manipulating Apun
Apun_simulations = bind_rows(mu_simultations,
                             simulate_orl(parameter_mus, "pun_HI"),
                             simulate_orl(parameter_mus, "pun_LO"))
saveRDS(Apun_simulations, here("1_IGT_PP", "Data", "2_Fitted", "Joint_ORL",
                               "Apun_simulations.rds"))
# Simulation of manipulating betaP
betaP_simulations = bind_rows(mu_simultations,
                              simulate_orl(parameter_mus, "betaP_HI"),
                              simulate_orl(parameter_mus, "betaP_LO"))
saveRDS(betaP_simulations, here("1_IGT_PP", "Data", "2_Fitted", "Joint_ORL",
                                "betaP_simulations.rds"))
# Simulation of manipulating betaF
betaF_simulations = bind_rows(mu_simultations,
                              simulate_orl(parameter_mus, "betaF_HI"),
                              simulate_orl(parameter_mus, "betaF_LO"))
saveRDS(betaF_simulations, here("1_IGT_PP", "Data", "2_Fitted", "Joint_ORL",
                                "betaF_simulations.rds"))
# Simulation of manipulating Apun
K_simulations = bind_rows(mu_simultations,
                          simulate_orl(parameter_mus, "K_HI"),
                          simulate_orl(parameter_mus, "K_LO"))
saveRDS(K_simulations, here("1_IGT_PP", "Data", "2_Fitted", "Joint_ORL",
                            "K_simulations.rds"))
```



```{r}
databased_simulations = readRDS(here("1_IGT_PP", "Data", "2_Fitted", "Joint_ORL",
                                     "databased_simulations.rds"))
Arew_betaP_simulations = readRDS(here("1_IGT_PP", "Data", "2_Fitted", "Joint_ORL",
                                      "Arew_betaP_simulations.rds"))
mu_simultations = readRDS(here("1_IGT_PP", "Data", "2_Fitted", "Joint_ORL",
                               "mu_simultations.rds"))
Arew_simulations = readRDS(here("1_IGT_PP", "Data", "2_Fitted", "Joint_ORL",
                                "Arew_simulations.rds"))
Apun_simulations = readRDS(here("1_IGT_PP", "Data", "2_Fitted", "Joint_ORL",
                                "Apun_simulations.rds"))
betaP_simulations = readRDS(here("1_IGT_PP", "Data", "2_Fitted", "Joint_ORL",
                                 "betaP_simulations.rds"))
betaF_simulations = readRDS(here("1_IGT_PP", "Data", "2_Fitted", "Joint_ORL",
                                 "betaF_simulations.rds"))
K_simulations = readRDS(here("1_IGT_PP", "Data", "2_Fitted", "Joint_ORL",
                             "K_simulations.rds"))
```



## Arew/BetaP Simulation
```{r, eval = F}
labs = c("Session 1",
         expression(paste("\u0394",italic(A),"+",sep="")),
         expression(paste("\u0394","\u03B2",italic(f),sep="")),
         "Session 2")

tiff(here("1_IGT_PP", "Figs_Tables", "Manuscript_Plots",
          "Databased Simulations.tiff"),
     width = 6.5, height = 2.5, units = "in", res = 300)

  # data
  databased_simulations %>% 
    select(everything(), deck = card) %>% 
    mutate(choice = case_when(choice == 2 ~ 0, T ~ choice),
           simulation = factor(simulation,
                               levels = c("BL", "me_Arew", "me_betaP", "int"))) %>% 
    group_by(simulation, card_trial, deck) %>% 
    reframe(proportion = mean(choice)) %>% 
    # plotting
    ggplot(aes(x = card_trial, color = simulation)) +
      # geoms
      geom_line(aes(y = proportion)) +
      # scales
      scale_y_continuous(limits = c(0,1), expand = c(0,0),
                         breaks = seq(0,1,.25)) +
      scale_color_manual(values = c("black", "dodgerblue3", "orange2", "gray45"), labels = labs) +
      # theme
      labs(x = "Trial", y = "Proportion Play") +
      theme_classic() +
      theme(axis.text = element_text(color = "black"),
            legend.title = element_blank(),
            legend.background = element_rect(fill = "transparent", colour = "transparent"),
            legend.position = "top",
            legend.spacing.y = unit(-.25, 'cm'),
            legend.text = element_text(size = 8),
            strip.background = element_blank(),
            panel.spacing.x = unit(-.5,"lines"),
            panel.spacing.y = unit(0,"lines"),
            plot.margin = unit(c(.1,.25,.1,.1), "cm")) +
      facet_rep_grid(.~deck,
                     labeller = labeller(deck = c("1" = "Deck A", "2" = "Deck B",
                                                  "3" = "Deck C", "4" = "Deck D")))
dev.off()  
```



## Arew-Only Simulation
```{r, eval = F}
tiff(here("1_IGT_PP", "Figs_Tables", "Manuscript_Plots",
          "Arew_Simulations.tiff"),
     width = 6.5, height = 3, units = "in", res = 300)

  # data
  Arew_simulations %>% 
    select(everything(), deck = card) %>% 
    mutate(choice = case_when(choice == 2 ~ 0, T ~ choice)) %>% 
    group_by(simulation, trial, deck) %>% 
    reframe(proportion = mean(choice)) %>% 
    # plotting
    ggplot(aes(x = trial, color = simulation)) +
      # geoms
      # geom_point(aes(y = proportion, color = "Predicted", fill = "Predicted"),
      #            shape = 21, size = .75) +
      geom_line(aes(y = proportion)) +
      # scales
      scale_y_continuous(limits = c(0,1), expand = c(0,0),
                         breaks = seq(0,1,.25)) +
      # scale_color_manual(name = "hello", values = c("Predicted" = "goldenrod3")) +
      # scale_fill_manual(name = "hello", values = c("Predicted" = "white")) +
      # theme
      labs(x = "Trial", y = "Proportion Play") +
      theme_classic() +
      theme(axis.text = element_text(color = "black"),
            legend.title = element_blank(),
            legend.background = element_rect(fill = "transparent", colour = "transparent"),
            # legend.position = "none", 
            legend.spacing.x = unit(0, 'cm'),
            legend.spacing.y = unit(-.25, 'cm'),
            legend.text = element_text(size = 8),
            strip.background = element_blank(),
            panel.spacing.x = unit(-.5,"lines"),
            legend.key.size = unit(.25, "cm"),
            panel.spacing.y = unit(0,"lines")) +
      # guides(color = guide_legend(override.aes = list(size = 1.25))) +
      facet_rep_grid(.~deck,
                     labeller = labeller(deck = c("1" = "Deck A", "2" = "Deck B",
                                                  "3" = "Deck C", "4" = "Deck D")))
dev.off()  
```



## Apun-Only Simulation
```{r, eval = F}
tiff(here("1_IGT_PP", "Figs_Tables", "Manuscript_Plots",
          "Apun_Simulations.tiff"),
     width = 6.5, height = 3, units = "in", res = 300)

  # data
  Apun_simulations %>% 
    select(everything(), deck = card) %>% 
    mutate(choice = case_when(choice == 2 ~ 0, T ~ choice)) %>% 
    group_by(simulation, trial, deck) %>% 
    reframe(proportion = mean(choice)) %>% 
    # plotting
    ggplot(aes(x = trial, color = simulation)) +
      # geoms
      # geom_point(aes(y = proportion, color = "Predicted", fill = "Predicted"),
      #            shape = 21, size = .75) +
      geom_line(aes(y = proportion)) +
      # scales
      scale_y_continuous(limits = c(0,1), expand = c(0,0),
                         breaks = seq(0,1,.25)) +
      # scale_color_manual(name = "hello", values = c("Predicted" = "goldenrod3")) +
      # scale_fill_manual(name = "hello", values = c("Predicted" = "white")) +
      # theme
      labs(x = "Trial", y = "Proportion Play") +
      theme_classic() +
      theme(axis.text = element_text(color = "black"),
            legend.title = element_blank(),
            legend.background = element_rect(fill = "transparent", colour = "transparent"),
            # legend.position = "none", 
            legend.spacing.x = unit(0, 'cm'),
            legend.spacing.y = unit(-.25, 'cm'),
            legend.text = element_text(size = 8),
            strip.background = element_blank(),
            panel.spacing.x = unit(-.5,"lines"),
            legend.key.size = unit(.25, "cm"),
            panel.spacing.y = unit(0,"lines")) +
      # guides(color = guide_legend(override.aes = list(size = 1.25))) +
      facet_rep_grid(.~deck,
                     labeller = labeller(deck = c("1" = "Deck A", "2" = "Deck B",
                                                  "3" = "Deck C", "4" = "Deck D")))
dev.off()  
```



## BetaP-Only Simulation
```{r, eval = F}
tiff(here("1_IGT_PP", "Figs_Tables", "Manuscript_Plots",
          "betaP_Simulations.tiff"),
     width = 6.5, height = 3, units = "in", res = 300)

  # data
  betaP_simulations %>% 
    select(everything(), deck = card) %>% 
    mutate(choice = case_when(choice == 2 ~ 0, T ~ choice)) %>% 
    group_by(simulation, trial, deck) %>% 
    reframe(proportion = mean(choice)) %>% 
    # plotting
    ggplot(aes(x = trial, color = simulation)) +
      # geoms
      # geom_point(aes(y = proportion, color = "Predicted", fill = "Predicted"),
      #            shape = 21, size = .75) +
      geom_line(aes(y = proportion)) +
      # scales
      scale_y_continuous(limits = c(0,1), expand = c(0,0),
                         breaks = seq(0,1,.25)) +
      # scale_color_manual(name = "hello", values = c("Predicted" = "goldenrod3")) +
      # scale_fill_manual(name = "hello", values = c("Predicted" = "white")) +
      # theme
      labs(x = "Trial", y = "Proportion Play") +
      theme_classic() +
      theme(axis.text = element_text(color = "black"),
            legend.title = element_blank(),
            legend.background = element_rect(fill = "transparent", colour = "transparent"),
            # legend.position = "none", 
            legend.spacing.x = unit(0, 'cm'),
            legend.spacing.y = unit(-.25, 'cm'),
            legend.text = element_text(size = 8),
            strip.background = element_blank(),
            panel.spacing.x = unit(-.5,"lines"),
            legend.key.size = unit(.25, "cm"),
            panel.spacing.y = unit(0,"lines")) +
      # guides(color = guide_legend(override.aes = list(size = 1.25))) +
      facet_rep_grid(.~deck,
                     labeller = labeller(deck = c("1" = "Deck A", "2" = "Deck B",
                                                  "3" = "Deck C", "4" = "Deck D")))
dev.off()  
```



## BetaF-Only Simulation
```{r, eval = F}
tiff(here("1_IGT_PP", "Figs_Tables", "Manuscript_Plots",
          "betaF_Simulations.tiff"),
     width = 6.5, height = 3, units = "in", res = 300)

  # data
  betaF_simulations %>% 
    select(everything(), deck = card) %>% 
    mutate(choice = case_when(choice == 2 ~ 0, T ~ choice)) %>% 
    group_by(simulation, trial, deck) %>% 
    reframe(proportion = mean(choice)) %>% 
    # plotting
    ggplot(aes(x = trial, color = simulation)) +
      # geoms
      # geom_point(aes(y = proportion, color = "Predicted", fill = "Predicted"),
      #            shape = 21, size = .75) +
      geom_line(aes(y = proportion)) +
      # scales
      scale_y_continuous(limits = c(0,1), expand = c(0,0),
                         breaks = seq(0,1,.25)) +
      # scale_color_manual(name = "hello", values = c("Predicted" = "goldenrod3")) +
      # scale_fill_manual(name = "hello", values = c("Predicted" = "white")) +
      # theme
      labs(x = "Trial", y = "Proportion Play") +
      theme_classic() +
      theme(axis.text = element_text(color = "black"),
            legend.title = element_blank(),
            legend.background = element_rect(fill = "transparent", colour = "transparent"),
            # legend.position = "none", 
            legend.spacing.x = unit(0, 'cm'),
            legend.spacing.y = unit(-.25, 'cm'),
            legend.text = element_text(size = 8),
            strip.background = element_blank(),
            panel.spacing.x = unit(-.5,"lines"),
            legend.key.size = unit(.25, "cm"),
            panel.spacing.y = unit(0,"lines")) +
      # guides(color = guide_legend(override.aes = list(size = 1.25))) +
      facet_rep_grid(.~deck,
                     labeller = labeller(deck = c("1" = "Deck A", "2" = "Deck B",
                                                  "3" = "Deck C", "4" = "Deck D")))
dev.off()  
```



## K-Only Simulation
```{r, eval = F}
tiff(here("1_IGT_PP", "Figs_Tables", "Manuscript_Plots",
          "K_Simulations.tiff"),
     width = 6.5, height = 3, units = "in", res = 300)

  # data
  K_simulations %>% 
    select(everything(), deck = card) %>% 
    mutate(choice = case_when(choice == 2 ~ 0, T ~ choice)) %>% 
    group_by(simulation, trial, deck) %>% 
    reframe(proportion = mean(choice)) %>% 
    # plotting
    ggplot(aes(x = trial, color = simulation)) +
      # geoms
      # geom_point(aes(y = proportion, color = "Predicted", fill = "Predicted"),
      #            shape = 21, size = .75) +
      geom_line(aes(y = proportion)) +
      # scales
      scale_y_continuous(limits = c(0,1), expand = c(0,0),
                         breaks = seq(0,1,.25)) +
      # scale_color_manual(name = "hello", values = c("Predicted" = "goldenrod3")) +
      # scale_fill_manual(name = "hello", values = c("Predicted" = "white")) +
      # theme
      labs(x = "Trial", y = "Proportion Play") +
      theme_classic() +
      theme(axis.text = element_text(color = "black"),
            legend.title = element_blank(),
            legend.background = element_rect(fill = "transparent", colour = "transparent"),
            # legend.position = "none", 
            legend.spacing.x = unit(0, 'cm'),
            legend.spacing.y = unit(-.25, 'cm'),
            legend.text = element_text(size = 8),
            strip.background = element_blank(),
            panel.spacing.x = unit(-.5,"lines"),
            legend.key.size = unit(.25, "cm"),
            panel.spacing.y = unit(0,"lines")) +
      # guides(color = guide_legend(override.aes = list(size = 1.25))) +
      facet_rep_grid(.~deck,
                     labeller = labeller(deck = c("1" = "Deck A", "2" = "Deck B",
                                                  "3" = "Deck C", "4" = "Deck D")))
dev.off()  
```



# ---------------------------------------
# Correlations Between Changes
* These are correlations between changes in parameters
```{r, eval = F}
choice_prop_wide = pivot_wider(choice_proportions,
                               values_from = "choice_proportion",
                               names_from = "session",
                               names_prefix = "session_") %>% 
  mutate(diff = session_2 - session_1) %>% 
  filter(type == "Good")

ind_orl_diffs = bind_rows(data.frame(parameter = "Arew", estimate = orl_posteriors$Arew, iteration = 1:16000),
                          data.frame(parameter = "betaP", estimate = orl_posteriors$betaP, iteration = 1:16000)) %>% 
  pivot_longer(starts_with("estimate"), names_to = c("id", "session"), values_to = "estimate",
               names_sep = "(\\.)", names_prefix = "estimate.",
               names_transform = list(id = as.numeric)) %>% 
  pivot_wider(names_from = "session", values_from = "estimate", names_prefix = "session_") %>% 
  mutate(diff = session_2 - session_1) %>% 
  group_by(parameter, id) %>% 
  reframe(mu_diff = mean(diff))

choice_orl = left_join(choice_prop_wide, ind_orl_diffs)
choice_Arew = filter(choice_orl, parameter == "Arew")
choice_betaP = filter(choice_orl, parameter == "betaP")
cor.test(choice_Arew$diff, choice_Arew$mu_diff)
cor.test(choice_betaP$diff, choice_betaP$mu_diff)
```



```{r, eval = F}
T1_net = apply((choices*outcomes)[,,1], 1, sum)
T2_net = apply((choices*outcomes)[,,2], 1, sum)

t.test(T1_net, T2_net, paired = T)

sum(T1_net)
sum(T2_net,na.rm = T)

negative_outcomes = ifelse(choices*outcomes < 0, 1, 0)
positive_outcomes = ifelse(choices*outcomes >= 0, 1, 0)

T1_negative_outcomes = apply(negative_outcomes[,,1], 1, sum)
T2_negative_outcomes = apply(negative_outcomes[,,2], 1, sum)

t.test(T1_negative_outcomes, T2_negative_outcomes, paired = T)

T1_positive_outcomes = apply(positive_outcomes[,,1], 1, sum)
T2_positive_outcomes = apply(positive_outcomes[,,2], 1, sum)

t.test(T1_positive_outcomes, T2_positive_outcomes, paired = T)
```



# ---------------------------------------
# Correlation with Ratios
```{r}
orl_ratio = data.frame(ID = stan_data$subjIDs,
                       ratio = apply(orl_posteriors$Apun, 2, mean)/
                         apply(orl_posteriors$Arew, 2, mean))

averages = self_report %>% 
  group_by(ID, scale) %>% 
  reframe(score = mean(score, na.rm = T), session = 0) %>% 
  pivot_wider(names_from = "scale", values_from = "score") %>% 
  left_join(orl_ratio)

orlratio_correlations = data.frame()

      
for(scale in unique(self_report$scale)){
  orlratio_correlations = run_cor(averages, 0, "SR-ORL Ratio", scale, "ratio") %>% 
    bind_rows(orlratio_correlations)
}

orlratio_correlations = orlratio_correlations %>% 
  separate(col = "CI", into = c("lower", "upper"), sep = ",") %>% 
  mutate(lower = as.numeric(str_remove(lower, "\\(")),
         upper = as.numeric(str_remove(upper, "\\)")),
         sig = case_when(lower > 0 & upper > 0 ~ "*",
                         lower < 0 & upper < 0 ~ "*",
                         T ~ ""))
```



# ---------------------------------------
# No Memory Decks Results
```{r, eval = F}
nom_orl_posteriors = readRDS(here("1_IGT_PP", "Data", "2_Fitted", "Joint_ORL_start_noK",
                                  "Joint_ORL_start_noK_posteriors.rds"))
```



## Absolute Reliability
```{r, eval = F}
nom_orl_abs_data = bind_rows(data.frame(parameter = "Arew", session = nom_orl_posteriors$mu_Arew),
                         data.frame(parameter = "Apun", session = nom_orl_posteriors$mu_Apun),
                         data.frame(parameter = "betaF", session = nom_orl_posteriors$mu_betaF),
                         data.frame(parameter = "betaP", session = nom_orl_posteriors$mu_betaP)) %>% 
  mutate(session.diff = session.2 - session.1) %>% 
  pivot_longer(starts_with("session"),
               names_to = "session", values_to = "estimate", names_prefix = "session.") %>% 
  group_by(parameter, session) %>% 
  mutate(mu = mean(estimate),
         lower50 = HDIofMCMC(estimate, credMass = .5)[1],
         upper50 = HDIofMCMC(estimate, credMass = .5)[2],
         lower95 = HDIofMCMC(estimate)[1],
         upper95 = HDIofMCMC(estimate)[2],
         parameter = factor(parameter, ordered = T,
                            levels = c("Arew", "Apun", "betaF", "betaP")),
         parameter_lab = factor(parameter,
                                levels = c("Arew", "Apun", "betaF", "betaP"),
                                labels = c(expression(paste(italic(A),"+",sep="")),
                                           expression(paste(italic(A),"-",sep="")),
                                           expression(paste("\u03B2",italic(f),sep="")),
                                           expression(paste("\u03B2",italic(b),sep="")))),
         parameter_lab = case_when(session == "diff" ~ parameter_lab, T ~ NA))

nom_orl_abs_scales =
  list(parameter == "Arew" & session != "diff" ~
         scale_x_continuous(limits = c(0, .3), expand = expansion(add = c(0, 0)),
                            breaks = seq(0, .3, .15), labels = c("0", ".15", ".3")),
       parameter == "Arew" & session == "diff" ~
         scale_x_continuous(limits = c(-.3, .3), expand = expansion(add = c(0, 0)),
                            breaks = seq(-.3, .3, .3), labels = c("-.3", "0", ".3")),
       
       parameter == "Apun" & session != "diff" ~
         scale_x_continuous(limits = c(.05, .15), expand = expansion(add = c(0, 0)),
                            breaks = seq(.05, .15, .05), labels = c(".05", ".1", ".15")),
       parameter == "Apun" & session == "diff" ~
         scale_x_continuous(limits = c(-.05, .05), expand = expansion(add = c(0, 0)),
                            breaks = seq(-.05, .05, .05), labels = c("-.05", "0", ".05")),
       
       parameter == "betaF" & session != "diff" ~
         scale_x_continuous(limits = c(0, 6), expand = expansion(add = c(0, 0)),
                            breaks = seq(0, 6, 3), labels = c(".05", ".1", ".15")),
       parameter == "betaF" & session == "diff" ~
         scale_x_continuous(limits = c(-3, 3), expand = expansion(add = c(0, 0)),
                            breaks = seq(-3, 3, 3), labels = c("-3", "0", "3")),
       
       parameter == "betaP" & session != "diff" ~
         scale_x_continuous(limits = c(0, 3), expand = expansion(add = c(0, 0)),
                            breaks = seq(0, 3, 1.5), labels = c("0", "1.5", "3")),
       parameter == "betaP" & session == "diff" ~
         scale_x_continuous(limits = c(-2, 2), expand = expansion(add = c(0, 0)),
                            breaks = seq(-2, 2, 2), labels = c("-2", "0", "2")))
```



```{r, eval = F}
nom_orl_abs_plot = nom_orl_abs_data %>% 
  ggplot(aes(x = estimate)) +
    # geoms
    geom_histogram(aes(y = ..density..), color = "black", fill = "gray45",
                   linewidth = .1, bins = 50) +
  
    geom_hline(yintercept = 0) +
    geom_vline(aes(xintercept = mu), color = "red2", linewidth = .25) +
    geom_vline(aes(xintercept = lower95), color = "red", linetype = "dashed", linewidth = .25) +
    geom_vline(aes(xintercept = upper95), color = "red", linetype = "dashed", linewidth = .25) +
    # scales
    scale_y_continuous(limits = c(0,NA), expand = c(0,0), n.breaks = 3) +
    # themes
    labs(x = "Estimate", y = "Density") +
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(axis.text.x = element_text(color = "black"),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.y = element_blank(),
          plot.margin = unit(c(.5, .5, .3, .1), "cm"),
          panel.spacing.x = unit(.5, "cm"),
          panel.spacing.y = unit(0, "cm"),
          strip.background = element_rect(fill = "transparent", colour = "transparent"),
          strip.text.x = element_blank(),
          strip.text.y = element_blank(),
          panel.background = element_rect(fill = "transparent", colour = "transparent"),
          plot.background = element_rect(fill = "transparent", color = "transparent")) +
    facet_rep_wrap(parameter~session, scales = "free",
                   nrow = 5, ncol = 3) +
    facetted_pos_scales(x = nom_orl_abs_scales)
```



```{r, eval = F}
tiff(here("1_IGT_PP", "Figs_Tables", "Manuscript_Plots",
          "nom_ORL_Abs_Reliability.tiff"),
     width = 7, height = 10, units = "cm", res = 300)

  grid.newpage()
  pushViewport(viewport(x = .5, y = .5, width = 1, height = 1))
  grid.draw(nom_orl_abs_plot)
  
  # text
  grid.text(c("Session 1", "Session 2", " Session 2-1"),
            x = c(.2, .515, .81), y = .98,
            gp = gpar(fontsize = 9.5))
  grid.text(c(expression(paste(italic(A),"+",sep="")),
              expression(paste(italic(A),"-",sep="")),
              expression(paste("\u03B2",italic(f),sep="")),
              expression(paste("\u03B2",italic(b),sep=""))),
            x = rep(.93, 5), y = c(.87, .655, .43, .22),
            gp = gpar(fontsize = 9.5))
  
dev.off()
```



## Relative Reliability
```{r, eval = F}
print("R_Arew")
apply(nom_orl_posteriors$R_Arew, c(2,3), mean)
apply(nom_orl_posteriors$R_Arew, c(2,3), HDIofMCMC)
print("R_Apun")
apply(nom_orl_posteriors$R_Apun, c(2,3), mean)
apply(nom_orl_posteriors$R_Apun, c(2,3), HDIofMCMC)
print("R_betaF")
apply(nom_orl_posteriors$R_betaF, c(2,3), mean)
apply(nom_orl_posteriors$R_betaF, c(2,3), HDIofMCMC)
print("R_betaP")
apply(nom_orl_posteriors$R_betaP, c(2,3), mean)
apply(nom_orl_posteriors$R_betaP, c(2,3), HDIofMCMC)
```



```{r, eval = F}
tiff(here("1_IGT_PP", "Figs_Tables", "Manuscript_Plots",
          "nom_ORL_Rel_Reliability.tiff"),
     width = 14.6, height = 4, units = "cm", res = 300)

  bind_rows(data.frame(parameter = "Arew", r = nom_orl_posteriors$R_Arew[,2,1]),
            data.frame(parameter = "Apun", r = nom_orl_posteriors$R_Apun[,2,1]),
            data.frame(parameter = "betaF", r = nom_orl_posteriors$R_betaF[,2,1]),
            data.frame(parameter = "betaP", r = nom_orl_posteriors$R_betaP[,2,1])) %>% 
    mutate(parameter = factor(parameter,
                              levels = c("Arew", "Apun", "betaF", "betaP"),
                              labels = c(expression(paste(italic(A),"+",sep="")),
                                         expression(paste(italic(A),"-",sep="")),
                                         expression(paste("\u03B2",italic(f),sep="")),
                                         expression(paste("\u03B2",italic(b),sep=""))))) %>% 
    group_by(parameter) %>% 
    mutate(mu_r = mean(r), lower = HDIofMCMC(r)[1], upper = HDIofMCMC(r)[2],
           below_0 = paste0(round(mean(r<0)*100), "% < 0"), above_0 = paste0(round(mean(r>0)*100), "% > 0"),
           height = max(density(r)$x)*.025) %>% 
    ggplot(aes(x = r)) +
      # geoms
      geom_histogram(aes(y = ..density..), color = "black", fill = "gray45",
                     linewidth = .1, bins = 50) +
      geom_text_npc(aes(npcx = "left", npcy = "top", label = below_0),
                    size = 2, vjust = -1.43) +
      geom_text_npc(aes(npcx = "right", npcy = "top", label = above_0),
                    size = 2, vjust = -1.43) +
      # geom_text_npc(aes(npcx = "left", npcy = "top", label = below_0),
      #               size = 2, hjust = -3, vjust = -1.43) +
      # geom_text_npc(aes(npcx = "right", npcy = "top",
      #                   label = rCI_lab), size = 2, vjust = -1.05) +
      geom_hline(yintercept = 0) +
      geom_vline(aes(xintercept = mu_r), color = "red2", linewidth = .4) +
      geom_errorbarh(aes(xmin = lower, xmax = upper,
                         y = height),
                         color = "red", linewidth = .4) +
      # scales
      scale_x_continuous(limits = c(-1,1), expand = c(0,0), breaks = seq(-1,1,.5),
                         labels = c("-1","-.5","0",".5", "1")) +
      scale_y_continuous(limits = c(0,NA), expand = c(0,0), n.breaks = 3) +
      # themes
      labs(x = "Reliability Coefficient", y = "Density") +
      coord_cartesian(clip = "off") +
      theme_classic() +
      theme(axis.text.x = element_text(color = "black"),
            axis.ticks.x = element_line(color = "black"),
            axis.line.x = element_line(color = "transparent"),
            axis.text.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.line.y = element_blank(),
            plot.margin = unit(c(.1, .3, .1, .3), "cm"),
            panel.spacing = unit(.25, "cm"),
            strip.background = element_rect(fill = "transparent", colour = "transparent"),
            strip.text.x = element_text(size = 12, vjust = 1.5),
            strip.text.y = element_blank(),
            panel.background = element_rect(fill = "transparent", colour = "transparent"),
            plot.background = element_rect(fill = "transparent", color = "transparent")) +
      facet_rep_grid(.~parameter, scales = "free",
                     labeller = label_parsed)
dev.off()
```



## Self-Report Correlations
```{r}
nom_orl_parameters = data.frame(ID = stan_data$subjIDs,
                                Arew = apply(nom_orl_posteriors$Arew, c(2,3), mean),
                                Apun = apply(nom_orl_posteriors$Apun, c(2,3), mean),
                                betaF = apply(nom_orl_posteriors$betaF, c(2,3), mean),
                                betaP = apply(nom_orl_posteriors$betaP, c(2,3), mean),
                                Arew.0 = apply(nom_orl_posteriors$Arew, 2, mean),
                                Apun.0 = apply(nom_orl_posteriors$Apun, 2, mean),
                                betaF.0 = apply(nom_orl_posteriors$betaF, 2, mean),
                                betaP.0 = apply(nom_orl_posteriors$betaP, 2, mean)) %>% 
  pivot_longer(starts_with(c("Arew", "Apun", "betaF", "betaP")),
               names_to = c("parameter", "session"), values_to = "estimate",
               names_sep = "\\.", names_transform = list(session = as.numeric)) %>% 
  pivot_wider(names_from = "parameter", values_from = "estimate") %>% 
  mutate(ratio = Apun/Arew)

nom_session1_session2 = self_report %>% 
  pivot_wider(names_from = "scale", values_from = "score") %>% 
  left_join(nom_orl_parameters)
nom_averages = self_report %>% 
  group_by(ID, scale) %>% 
  reframe(score = mean(score, na.rm = T), session = 0) %>% 
  pivot_wider(names_from = "scale", values_from = "score") %>% 
  left_join(nom_orl_parameters)

nom_combined = bind_rows(session1_session2, averages)
```



```{r}
set.seed(20230320)

# RUN SELF-REPORT/ORL CORRELATIONS
SR_nom_ORL_correlations = data.frame()

for(s in unique(nom_combined$session)){
  for(scale in unique(self_report$scale)){
    for(parameter in c("Arew", "Apun", "betaF", "betaP")){
      cur_data = nom_combined %>% 
        filter(session == s) %>% 
        select(ID, all_of(scale), all_of(parameter)) %>% 
        na.omit()
      
      if(nrow(cur_data)!=0){
        SR_nom_ORL_correlations = run_cor(cur_data, s, "SR-ORL", scale, parameter) %>% 
          bind_rows(SR_nom_ORL_correlations)
      }
    }
  }
}

# RUN Play Proportion/ORL CORRELATIONS
prop_nom_ORL_correlations = data.frame()

for(s in unique(combined$session)){
  for(prop in c("Good", "Bad")){
    for(parameter in c("Arew", "Apun", "betaF", "betaP")){
      cur_data = combined %>% 
        filter(session == s) %>% 
        select(ID, all_of(prop), all_of(parameter)) %>% 
        na.omit()
      
      if(nrow(cur_data)!=0){
        prop_nom_ORL_correlations = run_cor(cur_data, s, "ORL-Prop", parameter, prop) %>% 
          bind_rows(prop_nom_ORL_correlations)
      }
    }
  }
}

nom_correlations = bind_rows(SR_nom_ORL_correlations,
                             prop_nom_ORL_correlations) %>% 
  separate(col = "CI", into = c("lower", "upper"), sep = ",") %>% 
  mutate(lower = as.numeric(str_remove(lower, "\\(")),
         upper = as.numeric(str_remove(upper, "\\)")),
         sig = case_when(lower < 0 & upper < 0 ~ "*",
                         lower > 0 & upper > 0 ~ "*",
                         lower < 0 & upper < .01 ~ "#",
                         lower > .01 & upper > 0 ~ "#",
                         T ~ ""))

saveRDS(nom_correlations, here("1_IGT_PP", "Data", "2_Fitted",
                           "Joint_ORL_start_noK", paste0("Joint_ORL_start_noK_correlations.rds")))
```



## Save Correlations
```{r}
nom_correlations = readRDS(here("1_IGT_PP", "Data", "2_Fitted",
                            "Joint_ORL_start_noK", paste0("Joint_ORL_start_noK_correlations.rds")))

nom_correlations %>% 
  mutate(# MAKE NICE LABEL
         estimate = round(r,2),
         estimate_lab = paste(ifelse(sign(estimate)==1," ","-"), stri_pad_right(str_remove(abs(estimate), "^0+"),
                                                                                width = 3, pad = "0"),sep=""),
         lower = round(as.numeric(str_remove(lower, "\\(")),2),
         upper = round(as.numeric(str_remove(upper, "\\)")),2),
         
         lower_lab = paste(ifelse(sign(lower)==1,"","-"), stri_pad_right(str_remove(abs(lower), "^0+"),
                                                                         width = 3, pad = "0"),sep=""),
         
         upper_lab = paste(ifelse(sign(upper)==1,"","-"), stri_pad_right(str_remove(abs(upper), "^0+"),
                                                                         width = 3, pad = "0"),sep=""),
         lower_lab = case_when(lower_lab == "-000" ~ "-.00", T ~ lower_lab),
         upper_lab = case_when(upper_lab == "-000" ~ "-.00", T ~ upper_lab),
         estimate_lab = case_when(estimate_lab == "-000" ~ "-.00", T ~ estimate_lab),
         estimate_CI = paste(estimate_lab," [",lower_lab,",",upper_lab,"]",sep=""),
         # SORTING
         SR_sort = case_when(x == "bastot" ~ 1, x == "basdrive" ~ 2, x == "basfunsk" ~ 3, 
                             x == "basrewres" ~ 4, x == "bis" ~ 5, x == "panas_pa" ~ 6, 
                             x == "panas_na" ~ 7, x == "masqGDA" ~ 8, x == "masqAA" ~ 9, 
                             x == "masqGDD" ~ 10, x == "masqAD" ~ 11, x == "shaps_tot" ~ 12,
                             x == "prdep_tot" ~ 13)) %>% 
  write.csv(here("1_IGT_PP", "Data", "2_Fitted",
                 "Joint_ORL_start_noK", paste0("Joint_ORL_start_noK_correlations.csv")))
```



# ---------------------------------------
# Single Timepoint Correlations
```{r}
sess1_posteriors = readRDS(here("1_IGT_PP", "Data", "2_Fitted", "Sess1_ORL",
                                "Sess1_ORL_posteriors.rds"))
sess2_posteriors = readRDS(here("1_IGT_PP", "Data", "2_Fitted", "Sess2_ORL",
                                "Sess2_ORL_posteriors.rds"))
```



```{r}
sess12_ORL = data.frame(ID = 1:49,
                        Arew_1 = apply(sess1_posteriors$Arew, 2, mean),
                        Arew_2 = apply(sess2_posteriors$Arew, 2, mean),
                        Apun_1 = apply(sess1_posteriors$Apun, 2, mean),
                        Apun_2 = apply(sess2_posteriors$Apun, 2, mean),
                        K_1 = apply(sess1_posteriors$K, 2, mean),
                        K_2 = apply(sess2_posteriors$K, 2, mean),
                        betaF_1 = apply(sess1_posteriors$betaF, 2, mean),
                        betaF_2 = apply(sess2_posteriors$betaF, 2, mean),
                        betaP_1 = apply(sess1_posteriors$betaP, 2, mean),
                        betaP_2 = apply(sess2_posteriors$betaP, 2, mean))

sess12_orl_correlations = bind_rows(run_cor(sess12_ORL, "rel", "Sess12", "Arew_1", "Arew_2"),
                                    run_cor(sess12_ORL, "rel", "Sess12", "Apun_1", "Apun_2"),
                                    run_cor(sess12_ORL, "rel", "Sess12", "K_1", "K_2"),
                                    run_cor(sess12_ORL, "rel", "Sess12", "betaF_1", "betaF_2"),
                                    run_cor(sess12_ORL, "rel", "Sess12", "betaP_1", "betaP_2"))
```


























